<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>2-3ë°˜ ê´€ë¦¬ì í˜ì´ì§€</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      margin:0;
      font-family:system-ui,sans-serif;
      background:#f8fafc;
      color:#1f2937;
    }
    header {
      background:linear-gradient(135deg,#4f46e5,#3b82f6);
      color:white;
      padding:1rem 1.5rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    header h1 { margin:0; font-size:1.4rem; font-weight:800; }
    nav a {
      color:white;
      margin-left:1rem;
      text-decoration:none;
      font-weight:600;
    }
    nav a:hover { text-decoration:underline; color:#e0e7ff; }
    .wrap { max-width:1000px; margin:20px auto; padding:0 1rem }
    h2 { font-size:1.2rem; margin-bottom:.5rem; }
    .card {
      background:white;
      border-radius:1rem;
      padding:1.2rem;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
      margin-bottom:20px;
    }
    .btn {
      padding:.55rem .9rem;
      border-radius:.6rem;
      border:1px solid #d1d5db;
      background:white;
      font-size:.9rem;
      cursor:pointer;
      margin:.2rem 0;
    }
    .btn.primary { background:#3b82f6; color:white; border:none }
    .btn.primary:hover { background:#2563eb }
    input, textarea {
      width:100%;
      padding:.5rem;
      margin-top:.3rem;
      border:1px solid #ddd;
      border-radius:.5rem;
    }
    label { font-weight:600; display:block; margin-top:.7rem }
    /* ìë¦¬ */
    #seat-map {
      display:grid;
      grid-template-columns:repeat(6,1fr);
      gap:10px;
      margin-top:1rem;
    }
    .seat {
      background:#f9fafb;
      border:1px solid #e2e8f0;
      border-radius:.5rem;
      padding:.6rem;
      text-align:center;
      cursor:grab;
    }
    .seat:active { cursor:grabbing }
    .seat.locked {
      background:#e0f2fe;
      border-color:#0284c7;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ« 2-3ë°˜ ê´€ë¦¬ì í˜ì´ì§€</h1>
    <nav>
      <a href="#seats">ìë¦¬</a>
      <a href="#assign">ê³¼ì œ</a>
      <a href="#points">í¬ì¸íŠ¸</a>
      <a href="#quiz">í€´ì¦ˆ</a>
      <a href="#vote">íˆ¬í‘œ</a>
    </nav>
  </header>

  <div class="wrap">

    <!-- ìë¦¬ ê´€ë¦¬ -->
    <div id="seats" class="card">
      <h2>ğŸª‘ ìë¦¬ ê´€ë¦¬</h2>
      <button class="btn" onclick="loadSeats()">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn primary" onclick="shuffleSeats()">ğŸ”„ ëœë¤ ì„ê¸°</button>
      <button class="btn primary" onclick="saveSeats()">ğŸ’¾ ì €ì¥</button>
      <div id="seat-map"></div>
    </div>
    
    <!-- ê³¼ì œ ê´€ë¦¬ -->
    <div id="assign" class="card">
      <h2>ğŸ“ ê³¼ì œ ë“±ë¡</h2>
      <label>ì œëª© <input id="assign-title"></label>
      <label>ë§ˆê°ì¼ <input type="date" id="assign-deadline"></label>
      <button class="btn primary" onclick="addAssignment()">ë“±ë¡</button>
    </div>

    <!-- í¬ì¸íŠ¸ ê´€ë¦¬ -->
    <div id="points" class="card">
      <h2>ğŸ† í¬ì¸íŠ¸ ê´€ë¦¬</h2>
      <label>í•™ìƒ ì„ íƒ
        <select id="point-student"></select>
      </label>
      <label>ì¶”ê°€í•  í¬ì¸íŠ¸ <input type="number" id="point-value"></label>
      <button class="btn primary" onclick="addPoint()">â• í¬ì¸íŠ¸ ì¶”ê°€</button>
    </div>


    <!-- í€´ì¦ˆ ê´€ë¦¬ -->
    <div id="quiz" class="card">
      <h2>ğŸ‡ºğŸ‡¸ ì˜ì–´ í€´ì¦ˆ ë“±ë¡</h2>
      <label>ë¬¸ì œ <input id="quiz-question"></label>
      <button class="btn primary" onclick="addQuiz()">ì¶”ê°€</button>
    </div>

    <!-- íˆ¬í‘œ ê´€ë¦¬ -->
    <div id="vote" class="card">
      <h2>ğŸ—³ï¸ íˆ¬í‘œ ë“±ë¡</h2>
      <label>ì§ˆë¬¸ <input id="vote-question"></label>
      <label>ì˜µì…˜ (ì½¤ë§ˆë¡œ êµ¬ë¶„) <input id="vote-options"></label>
      <button class="btn primary" onclick="addVote()">ë“±ë¡</button>
    </div>

  </div>

  <script>
    const client = window.supabase.createClient(
      "https://ucmzrkwrsezfdjnnwsww.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjbXpya3dyc2V6ZmRqbm53c3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NDIzODcsImV4cCI6MjA2ODQxODM4N30.rvLItmDStjWb3GfECnCXocHvj-CMTfHfD1CHsAHOLaw"
    );

    /* --------------------
       ìë¦¬ ê´€ë¦¬
    -------------------- */
    let seatData = [];

    async function loadSeats(){
      const { data, error } = await client.from("class_seats")
        .select("id,student_number,name,seat_index,locked")  // âœ… name ë¶ˆëŸ¬ì˜´
        .eq("grade",2).eq("class_num",3)
        .order("seat_index");
      if(error){ console.error(error); return; }
      seatData = data || [];
      renderSeats();
    }

    function renderSeats(){
      const container = document.getElementById("seat-map");
      container.innerHTML = "";
      seatData.forEach((s,i)=>{
        const div = document.createElement("div");
        div.className="seat";
        if(s.locked) div.classList.add("locked");
        div.textContent = s.name;    // âœ… ì´ë¦„ë§Œ í‘œì‹œ
        div.draggable = true;
        div.dataset.index = i;

        div.addEventListener("dragstart", e=>{
          e.dataTransfer.setData("from",i);
        });
        div.addEventListener("dragover", e=>e.preventDefault());
        div.addEventListener("drop", e=>{
          e.preventDefault();
          const from = parseInt(e.dataTransfer.getData("from"));
          swapSeats(from,i);
        });
        div.addEventListener("contextmenu", async e=>{
          e.preventDefault();
          seatData[i].locked = !seatData[i].locked;
          await client.from("class_seats")
            .update({locked:seatData[i].locked})
            .eq("id",seatData[i].id);
          renderSeats();
        });

        container.appendChild(div);
      });
    }

    function swapSeats(from,to){
      if(seatData[from].locked || seatData[to].locked) return;

      const temp = seatData[from];
      seatData[from] = seatData[to];
      seatData[to] = temp;

      renderSeats();  // í™”ë©´ë§Œ ê°±ì‹ 
    }

    function shuffleSeats(){
      let free = seatData.filter(s=>!s.locked);
      let shuffled = [...free].sort(()=>Math.random()-0.5);

      let idx = 0;
      seatData = seatData.map(s=>{
        if(s.locked) return s;
        return {...shuffled[idx++]};
      });

      // ìƒˆë¡œìš´ ë°°ì—´ ìˆœì„œëŒ€ë¡œ seat_index ë‹¤ì‹œ ë¶€ì—¬
      seatData.forEach((s,i)=> s.seat_index = i+1);

      renderSeats();
    }


async function saveSeats() {
  try {
    // 1ï¸âƒ£ seat_index ì¬í• ë‹¹
    seatData.forEach((s, i) => s.seat_index = i + 1);

    // 2ï¸âƒ£ ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
    let { error: delError } = await client
      .from("class_seats")
      .delete()
      .eq("grade", 2)
      .eq("class_num", 3);

    if (delError) throw delError;

    // 3ï¸âƒ£ seatData ë‹¤ì‹œ insert (âš ï¸ id ì œê±°!)
    const insertData = seatData.map(s => ({
      grade: 2,
      class_num: 3,
      student_number: s.student_number,
      name: s.name,
      seat_index: s.seat_index,
      locked: s.locked
    }));

    let { error: insError } = await client
      .from("class_seats")
      .insert(insertData);

    if (insError) throw insError;

    console.log("âœ… ìƒˆë¡œ ì €ì¥ëœ ë°ì´í„°:", insertData);
    alert("âœ… ìë¦¬ ì´ˆê¸°í™” í›„ ì €ì¥ ì™„ë£Œ!");
    await loadSeats(); // ì €ì¥ í›„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
  } catch (e) {
    console.error("âŒ ì €ì¥ ì‹¤íŒ¨", e);
    alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message);
  }
}






    /* --------------------
       ê³¼ì œ
    -------------------- */
    async function addAssignment(){
      const title=document.getElementById("assign-title").value;
      const deadline=document.getElementById("assign-deadline").value;
      await client.from("assignments")
        .insert([{title,deadline,grade:2,class_num:3}]);
      alert("âœ… ê³¼ì œ ë“±ë¡ ì™„ë£Œ");
    }

    /* --------------------
       í¬ì¸íŠ¸
    -------------------- */
    async function updatePoint(){
      const name=document.getElementById("point-name").value;
      const point=parseInt(document.getElementById("point-value").value);
      await client.from("class_student_points")
        .update({point})
        .eq("name",name).eq("grade",2).eq("class_num",3);
      alert("âœ… í¬ì¸íŠ¸ ìˆ˜ì • ì™„ë£Œ");
    }

    /* --------------------
       í€´ì¦ˆ
    -------------------- */
    // í€´ì¦ˆ ì¶”ê°€
    async function addQuiz() {
      const question = document.getElementById("quiz-question").value.trim();
      if (!question) {
        alert("âŒ ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      try {
        // ì˜¤ëŠ˜ ì„¸íŠ¸ uuid ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±)
        let setId = localStorage.getItem("quiz_set_id");
        if (!setId) {
          setId = crypto.randomUUID();  // âœ… uuid ìƒì„±
          localStorage.setItem("quiz_set_id", setId);
        }

        // í˜„ì¬ ì„¸íŠ¸ ë‚´ ë§ˆì§€ë§‰ number ì¡°íšŒ
        const { data: existing, error: fetchError } = await client
          .from("english_quiz_questions")
          .select("number")
          .eq("quiz_set_id", setId)
          .order("number", { ascending: false })
          .limit(1);

        if (fetchError) throw fetchError;

        const nextNumber = existing?.[0]?.number ? existing[0].number + 1 : 1;

        // í€´ì¦ˆ ì €ì¥
        const { error } = await client.from("english_quiz_questions").insert([
          {
            quiz_set_id: setId,
            number: nextNumber,
            question
          }
        ]);

        if (error) throw error;

        alert(`âœ… í€´ì¦ˆ ì¶”ê°€ ì™„ë£Œ! (ë²ˆí˜¸: ${nextNumber})`);
        document.getElementById("quiz-question").value = "";

      } catch (e) {
        console.error("âŒ í€´ì¦ˆ ì¶”ê°€ ì‹¤íŒ¨", e);
        alert("âŒ í€´ì¦ˆ ì¶”ê°€ ì‹¤íŒ¨: " + e.message);
      }
    }


    /* --------------------
       íˆ¬í‘œ
    -------------------- */
    async function addVote(){
      const q=document.getElementById("vote-question").value;
      const opts=document.getElementById("vote-options").value.split(",").map(x=>x.trim());
      await client.from("class_votes").insert([
        {question:q,options:opts,grade:2,class_num:3}
      ]);
      alert("âœ… íˆ¬í‘œ ë“±ë¡ ì™„ë£Œ");
    }

    document.addEventListener("DOMContentLoaded", loadSeats);

    // í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° â†’ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
async function loadPointStudents() {
  try {
    const { data, error } = await client
      .from("class_student_points")
      .select("name")
      .eq("grade", 2)
      .eq("class_num", 3)
      .order("student_number");

    if (error) throw error;

    const select = document.getElementById("point-student");
    select.innerHTML = data.map(s => `<option value="${s.name}">${s.name}</option>`).join("");
  } catch (e) {
    console.error("âŒ í•™ìƒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
  }
}

// í¬ì¸íŠ¸ ì¶”ê°€
async function addPoint() {
  const name = document.getElementById("point-student").value;
  const addValue = parseInt(document.getElementById("point-value").value);

  if (!name || isNaN(addValue)) {
    alert("âŒ í•™ìƒê³¼ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  try {
    // 1ï¸âƒ£ í˜„ì¬ í¬ì¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
    const { data, error } = await client
      .from("class_student_points")
      .select("point")
      .eq("grade", 2)
      .eq("class_num", 3)
      .eq("name", name)
      .single();

    if (error) throw error;

    const newPoint = (data?.point || 0) + addValue;

    // 2ï¸âƒ£ ìƒˆë¡œìš´ í¬ì¸íŠ¸ ì €ì¥
    const { error: updateError } = await client
      .from("class_student_points")
      .update({ point: newPoint })
      .eq("grade", 2)
      .eq("class_num", 3)
      .eq("name", name);

    if (updateError) throw updateError;

    alert(`âœ… ${name} í•™ìƒ í¬ì¸íŠ¸ê°€ ${newPoint}ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨!`);
    document.getElementById("point-value").value = "";
  } catch (e) {
    console.error("âŒ í¬ì¸íŠ¸ ì¶”ê°€ ì‹¤íŒ¨", e);
    alert("âŒ í¬ì¸íŠ¸ ì¶”ê°€ ì‹¤íŒ¨: " + e.message);
  }
}

// í˜ì´ì§€ ë¡œë“œì‹œ í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener("DOMContentLoaded", () => {
  loadSeats();         // ê¸°ì¡´ ìë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
  loadPointStudents(); // í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
});

  </script>
</body>
</html>

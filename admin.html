<!doctype html>
<html lang="ko" class="h-full">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>EduBoard 관리자</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta name="color-scheme" content="light dark"/>
  <link rel="stylesheet" href="css/admin.css">
</head>
<body class="h-full bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <!-- 헤더 -->
  <header class="bg-white/80 dark:bg-gray-800/70 backdrop-blur border-b sticky top-0 z-50">
    <div class="w-full px-8 py-3 flex items-center gap-3">
      <a href="./index.html" class="text-sm text-blue-600 dark:text-blue-400 hover:underline flex items-center gap-1">
        <svg viewBox="0 0 24 24" fill="none" class="w-4 h-4"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        대시보드
      </a>
      <h1 class="text-lg font-semibold">사용자 & 권한 관리</h1>
      <div class="ml-auto flex items-center gap-2">
        <button id="theme" class="btn btn-ghost text-sm">테마</button>
        <span id="me" class="text-sm text-gray-600 dark:text-gray-300 px-2 py-1 rounded bg-gray-100/70 dark:bg-gray-700/60"></span>
        <button id="signout" class="btn">로그아웃</button>
      </div>
    </div>
  </header>

  <!-- 본문 -->
  <main class="w-full px-8 py-6 space-y-8">
    <!-- KPI 카드 -->
    <section class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-6 gap-6">
      <div class="rounded-xl border bg-white p-5 shadow-sm"><h3 class="text-sm text-gray-500">전체 사용자</h3><p id="stat-total" class="text-2xl font-bold mt-1">0</p></div>
      <div class="rounded-xl border bg-white p-5 shadow-sm"><h3 class="text-sm text-gray-500">학생</h3><p id="stat-student" class="text-2xl font-bold mt-1 text-green-600">0</p></div>
      <div class="rounded-xl border bg-white p-5 shadow-sm"><h3 class="text-sm text-gray-500">교사</h3><p id="stat-teacher" class="text-2xl font-bold mt-1 text-blue-600">0</p></div>
      <div class="rounded-xl border bg-white p-5 shadow-sm"><h3 class="text-sm text-gray-500">관리자</h3><p id="stat-admin" class="text-2xl font-bold mt-1 text-red-600">0</p></div>
      <div class="rounded-xl border bg-white p-5 shadow-sm"><h3 class="text-sm text-gray-500">학급 수</h3><p id="stat-classes" class="text-2xl font-bold mt-1">0</p></div>
      <div class="rounded-xl border bg-white p-5 shadow-sm"><h3 class="text-sm text-gray-500">평균 학년</h3><p id="stat-avg-grade" class="text-2xl font-bold mt-1">-</p></div>
    </section>

    <!-- 툴바 -->
    <section class="rounded-xl border bg-white p-5 shadow-sm">
      <div class="flex flex-wrap items-center gap-2">
        <select id="f-grade" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900">
          <option value="">학년 전체</option><option>1</option><option>2</option><option>3</option>
        </select>
        <select id="f-class" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900">
          <option value="">반 전체</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
        </select>
        <select id="f-role" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900">
          <option value="">권한 전체</option>
          <option>admin</option><option>teacher</option><option>class_admin</option><option>student</option><option>user</option>
        </select>

        <div class="flex items-center gap-2 px-3 py-2 rounded-lg border bg-white dark:bg-gray-900">
          <svg viewBox="0 0 24 24" fill="none" class="w-4 h-4"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="search" class="outline-none bg-transparent text-sm w-72" placeholder="이름/학번/아이디 검색"/>
        </div>

        <button id="refresh" class="btn">새로고침</button>

        <div class="relative">
          <button id="more-btn" class="btn">More ▾</button>
          <div id="more" class="popover dark:[--bg:rgba(31,41,55,.98)]">
            <div class="p-2 text-sm">
              <button id="open-add" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700">+ 사용자 추가</button>
              <label class="w-full block px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                CSV 업로드<input id="csv-in" type="file" accept=".csv" class="hidden">
              </label>
              <button id="csv-out" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700">CSV 다운로드</button>
              <div class="my-1 h-px bg-gray-200 dark:bg-gray-700"></div>
              <button id="open-logs" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700">활동 로그</button>
              <button id="promote" class="w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700">신학기 자동 승급</button>
            </div>
          </div>
        </div>

        <div class="ml-auto flex items-center gap-2">
          <label class="text-sm">페이지</label>
          <select id="page-size" class="rounded-lg border px-2 py-1 text-sm dark:bg-gray-900">
            <option>25</option><option selected>50</option><option>100</option><option>200</option>
          </select>
        </div>
      </div>
    </section>

    <!-- 사용자 테이블 -->
    <section class="rounded-xl border bg-white p-5 shadow-sm">
      <div class="border rounded-xl overflow-x-auto bg-white dark:bg-gray-800 table">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr class="[&>th]:p-2 [&>th]:border">
              <th class="w-10 text-center"><input type="checkbox" id="check-all"></th>
              <th class="sortable" data-sort="name">이름</th>
              <th class="w-16 text-center sortable" data-sort="grade">학년</th>
              <th class="w-16 text-center sortable" data-sort="class_num">반</th>
              <th class="w-20 text-center sortable" data-sort="student_number">번호</th>
              <th>권한</th>
              <th class="w-16 text-center">레벨</th>
              <th class="w-20 text-center">XP</th>
              <th class="w-20 text-center">포인트</th>
              <th class="w-[220px] text-center">작업</th>
            </tr>
          </thead>
          <tbody id="rows" class="[&>tr>td]:p-2 [&>tr>td]:border"></tbody>
        </table>
        <p id="empty" class="hidden p-5 text-center text-gray-500">결과가 없습니다.</p>
      </div>

      <div class="flex items-center justify-between py-3 text-sm">
        <div id="page-info" class="text-gray-600 dark:text-gray-300"></div>
        <div class="flex gap-2">
          <button id="prev" class="btn">이전</button>
          <button id="next" class="btn">다음</button>
        </div>
      </div>
    </section>
  </main>

  <!-- 일괄 권한 배너 -->
  <div id="bulk-drawer" class="drawer hidden">
    <div class="w-full px-8 py-3 flex items-center gap-2">
      <div class="text-sm flex-1">선택됨: <span id="sel-count">0</span>명</div>
      <select id="bulk-role" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900">
        <option value="">일괄 권한 선택…</option>
        <option>admin</option><option>teacher</option><option>class_admin</option><option>student</option><option>user</option>
      </select>
      <button id="bulk-apply" class="btn btn-primary">일괄 적용</button>
    </div>
  </div>

  <!-- 사용자 추가 모달 -->
  <div id="modal-add" class="modal">
    <div class="w-full max-w-xl rounded-xl border bg-white dark:bg-gray-800 p-4">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">사용자 추가</h3>
        <button class="btn btn-ghost" data-close>닫기</button>
      </div>
      <div class="mt-3 grid sm:grid-cols-2 gap-3">
        <input id="add-username" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900" placeholder="아이디(username)"/>
        <input id="add-name" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900" placeholder="이름"/>
        <input id="add-email" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900" placeholder="이메일(선택)"/>
        <input id="add-grade" type="number" min="1" max="3" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900" placeholder="학년"/>
        <input id="add-class" type="number" min="1" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900" placeholder="반"/>
        <input id="add-number" type="number" min="1" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900" placeholder="번호(학번)"/>
        <select id="add-role" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900">
          <option value="student">student(동아리)</option><option>class_admin</option><option>admin</option><option>user</option>
        </select>
        <input id="add-level" type="number" min="1" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900" placeholder="레벨(선택)"/>
        <input id="add-xp" type="number" min="0" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900" placeholder="XP(선택)"/>
        <input id="add-point" type="number" min="0" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900" placeholder="포인트(선택)"/>
        <input id="add-password" class="rounded-lg border px-3 py-2 text-sm dark:bg-gray-900" placeholder="임시 비번(선택)"/>
      </div>
      <div class="mt-4 flex justify-end">
        <button id="add-submit" class="btn btn-primary">추가</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">운영에선 비밀번호는 서버에서 해시 저장 권장.</p>
    </div>
  </div>

  <div id="modal-coin" class="modal">
    <div class="w-full max-w-sm rounded-xl border bg-white dark:bg-gray-800 p-4">
      <h3 class="font-semibold mb-3">포인트 지급</h3>
      <input id="coin-amount" type="number" min="1" class="w-full rounded-lg border px-3 py-2 text-sm dark:bg-gray-900" placeholder="지급할 포인트 수"/>
      <div class="mt-4 flex justify-end gap-2">
        <button class="btn btn-ghost" data-close>취소</button>
        <button class="btn btn-primary" id="coin-submit">지급</button>
      </div>
    </div>
  </div>


  <!-- 로그 모달 -->
  <div id="modal-logs" class="modal">
    <div class="w-full max-w-2xl rounded-xl border bg-white dark:bg-gray-800 p-4">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">활동 로그</h3>
        <div class="flex gap-2">
          <button id="refresh-logs" class="btn">새로고침</button>
          <button class="btn btn-ghost" data-close>닫기</button>
        </div>
      </div>
      <ul id="log-list" class="mt-3 space-y-2 max-h:[60vh] overflow-auto text-sm"></ul>
      <p id="log-empty" class="hidden text-sm text-gray-500">로그가 없습니다(테이블 없을 수도 있음).</p>
    </div>
  </div>

  <!-- 전역 컨텍스트 메뉴(작업) -->
  <div id="ctx" class="dark:[--bg:rgba(31,41,55,.98)]">
    <div class="p-1 text-sm">
      <button class="w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700" data-ctx="save">권한 저장</button>
      <button class="w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700" data-ctx="reset">비번 초기화</button>
      <button class="w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700" data-ctx="coin">포인트 지급</button>
      <button class="w-full text-left px-3 py-2 rounded text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30" data-ctx="del">삭제</button>
    </div>
  </div>

  <!-- 토스트 -->
  <div id="toast" role="status" aria-live="polite"></div>

  <script src="js/admin.js"></script>
</body>
</html>

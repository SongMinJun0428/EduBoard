<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ClassNote</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    /* ===== ê³µí†µ ===== */
    body {
      margin: 0;
      font-family: 'Noto Sans KR', sans-serif;
      background: #f8f9fa;
      color: #333;
    }
    header {
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      color: #007bff;
    }
    #profile-icon {
      cursor: pointer;
      font-size: 1.3rem;
      margin-left: 1rem;
    }
    nav {
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 0.75rem;
    }
    nav a {
      text-decoration: none;
      color: #495057;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
    }
    nav a:hover {
      background: #e9ecef;
      color: #007bff;
    }
    .content {
      padding: 2rem;
      max-width: 1000px;
      margin: auto;
    }
    .panel {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    button {
      background: #007bff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background: #0056b3;
    }
    input[type=text],
    input[type=password],
    input[type=email],
    input[type=number],
    textarea {
      display: block;
      width: 100%;
      height: 40px;
      padding: 0 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      margin-bottom: 0.8rem;
      font-size: 0.95rem;
      background: #fff;
      box-sizing: border-box;
    }
    textarea {
      height: 80px;
      padding: 0.6rem;
    }
    #login-screen {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #ffffff;
    }
    .auth-box {
      background: #fff;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 320px;
      text-align: center;
    }
    .auth-box h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #007bff;
    }
  </style>
</head>
<body>

  <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… -->
  <div id="login-screen">
    <div class="auth-box" id="login-box">
      <h2>ë¡œê·¸ì¸</h2>
      <input id="loginUsername" type="text" placeholder="ì•„ì´ë””">
      <input id="loginPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
      <button onclick="loginDirect()">ë¡œê·¸ì¸</button>
      <p style="font-size:0.85rem;">
        ì•„ì´ë””ê°€ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" onclick="showSignup()">íšŒì›ê°€ì…</a>
      </p>
      <div id="loginStatus" style="font-size:0.85rem;color:red;"></div>
    </div>

    <div class="auth-box" id="signup-box" style="display:none;">
      <h2>íšŒì›ê°€ì…</h2>
      <input id="signupUsername" type="text" placeholder="ì•„ì´ë””">
      <input id="signupEmail" type="email" placeholder="ì´ë©”ì¼">
      <input id="signupPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
      <input id="signupName" type="text" placeholder="ì´ë¦„">
      <input id="signupGrade" type="number" placeholder="í•™ë…„">
      <input id="signupClass" type="number" placeholder="ë°˜">
      <input id="signupNumber" type="number" placeholder="ë²ˆí˜¸">
      <button onclick="signup()">ê°€ì…í•˜ê¸°</button>
      <p style="font-size:0.85rem;">
        <a href="#" onclick="showLogin()">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      </p>
      <div id="signupStatus" style="font-size:0.85rem;color:red;"></div>
    </div>
  </div>

  <!-- ë©”ì¸ ì•± -->
  <div id="main-app" style="display:none;">
    <header>
      <h1>ClassNote</h1>
      <div style="display:flex;align-items:center;">
        <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        <span id="profile-icon">ğŸ‘¤</span>
      </div>
    </header>

    <nav id="main-nav">
      <a href="#" onclick="showPanel('doc-panel')">ë¬¸ì„œ ë¶„ì„</a>
      <a href="#" onclick="showPanel('notice-panel')">ê³µì§€ì‚¬í•­</a>
      <a href="#" onclick="showPanel('student-panel')">í•™ìƒ ê´€ë¦¬</a>
      <a href="#" onclick="showPanel('homework-panel')">ê³¼ì œ ì œì¶œ</a>
      <a href="#" onclick="showPanel('chat-panel')">ìƒë‹´ì‹¤</a>
    </nav>

    <div class="content">
      <div id="doc-panel" class="panel">
        <h2>ğŸ“„ ë¬¸ì„œ ì—…ë¡œë“œ</h2>
        <input type="file" id="doc-file" accept=".pdf,.jpg,.png"/>
        <button onclick="analyzeDocument()">ë¬¸ì„œ ë¶„ì„í•˜ê¸°</button>
        <div id="doc-result" style="margin-top:1rem; white-space:pre-wrap;"></div>
      </div>

      <div id="notice-panel" class="panel" style="display:none;">
        <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
        <div id="notice-list"></div>
        <h3>ìƒˆ ê³µì§€ ë“±ë¡</h3>
        <input type="text" id="notice-title" placeholder="ì œëª©"/>
        <textarea id="notice-content" placeholder="ë‚´ìš©"></textarea>
        <button onclick="addNotice()">ê³µì§€ ì¶”ê°€</button>
      </div>

      <div id="student-panel" class="panel" style="display:none;">
        <h2>ğŸ‘©â€ğŸ“ í•™ìƒ ê´€ë¦¬</h2>
        <button onclick="loadStudents()">í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <ul id="student-list"></ul>
      </div>

      <div id="homework-panel" class="panel" style="display:none;">
        <h2>ğŸ“š ê³¼ì œ ì œì¶œ</h2>
        <input type="file" id="homework-file"/>
        <button onclick="submitHomework()">ì œì¶œí•˜ê¸°</button>
        <div id="homework-status" style="margin-top:0.5rem;"></div>
        <h3>ğŸ“‹ ë‚´ ê³¼ì œ ëª©ë¡</h3>
        <ul id="homework-list"></ul>
      </div>

      <div id="chat-panel" class="panel" style="display:none;">
        <h2>ğŸ’¬ ìƒë‹´ì‹¤</h2>
        <div id="chat-box" style="border:1px solid #ccc; height:200px; overflow-y:auto; padding:0.5rem; margin-bottom:0.5rem;"></div>
        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
        <button onclick="sendChat()">ë³´ë‚´ê¸°</button>
      </div>

      <div id="profile-panel" class="panel" style="display:none;">
        <h2>ë‚´ ì •ë³´ ìˆ˜ì •</h2>
        <input type="text" id="update-name" placeholder="ì´ë¦„ ìˆ˜ì •">
        <input type="password" id="update-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •">
        <button onclick="updateProfile()">ìˆ˜ì •í•˜ê¸°</button>
        <button onclick="showPanel('doc-panel')">â† ëŒì•„ê°€ê¸°</button>
      </div>

      <div id="admin-panel" class="panel" style="display:none;">
        <h2>âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h2>
        <input type="text" id="admin-user-id" placeholder="ì‚¬ìš©ì ID"/>
        <select id="admin-role">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
        <button onclick="changeRole()">ê¶Œí•œ ë³€ê²½</button>
        <button onclick="deleteUser()">ì‚¬ìš©ì ì‚­ì œ</button>
        <div id="admin-status" style="margin-top:0.5rem;"></div>
      </div>
    </div>
  </div>

<script>
const { createClient } = supabase;
const supabaseClient = createClient(
  'https://ucmzrkwrsezfdjnnwsww.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjbXpya3dyc2V6ZmRqbm53c3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NDIzODcsImV4cCI6MjA2ODQxODM4N30.rvLItmDStjWb3GfECnCXocHvj-CMTfHfD1CHsAHOLaw'
);

let currentUserRole = 'user';

async function loginDirect() {
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  const { data: user } = await supabaseClient
    .from('users')
    .select('*')
    .eq('username', username)
    .eq('password', password)
    .single();

  if (user) {
    currentUserRole = user.role || 'user';
    showMain();
  } else {
    document.getElementById('loginStatus').innerText = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
  }
}

async function signup() {
  const username = document.getElementById('signupUsername').value.trim();
  const password = document.getElementById('signupPassword').value.trim();
  const name = document.getElementById('signupName').value.trim();
  const grade = parseInt(document.getElementById('signupGrade').value);
  const classNum = parseInt(document.getElementById('signupClass').value);
  const studentNumber = parseInt(document.getElementById('signupNumber').value);

  // 1. username ì¤‘ë³µ ì²´í¬
  const { data: existing, error: checkError } = await supabaseClient
    .from('users')
    .select('username')
    .eq('username', username)
    .maybeSingle();

  if (checkError) {
    console.error('ì¤‘ë³µì²´í¬ ì˜¤ë¥˜:', checkError);
    document.getElementById('signupStatus').innerText = 'ì˜¤ë¥˜ ë°œìƒ: ' + checkError.message;
    return;
  }

  if (existing) {
    document.getElementById('signupStatus').innerText = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.';
    return;
  }

  // 2. insert
  const { data, error } = await supabaseClient.from('users').insert([{
    username: username,
    password: password,
    name: name,
    grade: grade,
    class_num: classNum,
    student_number: studentNumber,
    coin_balance: 0,
    role: 'user'
  }]);

  if (error) {
    console.error('insert ì˜¤ë¥˜:', error);
    document.getElementById('signupStatus').innerText = 'íšŒì›ê°€ì… ì‹¤íŒ¨: ' + error.message;
    return;
  }

  console.log('íšŒì›ê°€ì… ì„±ê³µ:', data);
  document.getElementById('signupStatus').innerText = 'íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.';
  showLogin();
}

function showMain() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  setupAdminNav();
}

function showSignup() {
  document.getElementById('login-box').style.display = 'none';
  document.getElementById('signup-box').style.display = 'block';
}

function showLogin() {
  document.getElementById('login-box').style.display = 'block';
  document.getElementById('signup-box').style.display = 'none';
}

async function logout() {
  await supabaseClient.auth.signOut();
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
}

async function updateProfile() {
  const newName = document.getElementById('update-name').value;
  const newPass = document.getElementById('update-password').value;

  if (newPass) {
    const { error } = await supabaseClient.auth.updateUser({ password: newPass });
    if (error) alert('ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • ì˜¤ë¥˜:' + error.message);
    else alert('ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • ì™„ë£Œ!');
  }
  if (newName) {
    const user = await supabaseClient.auth.getUser();
    if (user && user.data.user) {
      await supabaseClient.from('users').update({ name: newName }).eq('id', user.data.user.id);
      alert('ì´ë¦„ ìˆ˜ì • ì™„ë£Œ!');
    }
  }
}

function showPanel(panelId) {
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  document.getElementById(panelId).style.display = 'block';
}

document.getElementById('profile-icon').addEventListener('click', () => {
  showPanel('profile-panel');
});

supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
  if (session) {
    const { data: user } = await supabaseClient
      .from('users')
      .select('role')
      .eq('id', session.user.id)
      .single();
    if (user) currentUserRole = user.role;
    showMain();
  } else {
    showLogin();
  }
});

function setupAdminNav() {
  if (currentUserRole === 'admin') {
    if (!document.getElementById('admin-nav')) {
      const nav = document.getElementById('main-nav');
      const a = document.createElement('a');
      a.href = '#';
      a.id = 'admin-nav';
      a.innerText = 'ê´€ë¦¬ì ì„¤ì •';
      a.onclick = () => { showPanel('admin-panel'); };
      nav.appendChild(a);
    }
  }
}
// âœ… í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ì„¸ì…˜ì„ í™•ì¸í•´ì„œ ìë™ ë¡œê·¸ì¸ ì²˜ë¦¬
window.addEventListener('DOMContentLoaded', async () => {
  try {
    const { data, error } = await supabaseClient.auth.getSession();
    if (error) {
      console.error('ì„¸ì…˜ í™•ì¸ ì˜¤ë¥˜:', error.message);
      showLogin(); // ì„¸ì…˜ ëª» ê°€ì ¸ì˜¤ë©´ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
      return;
    }

    // ì„¸ì…˜ì´ ìˆëŠ” ê²½ìš°
    if (data.session && data.session.user) {
      console.log('ìë™ ë¡œê·¸ì¸ ì„±ê³µ:', data.session.user);
      currentUserRole = 'user'; // í•„ìš”í•˜ë©´ role ì¡°íšŒ
      showMain();               // ë©”ì¸í™”ë©´ ì—´ê¸°
    } else {
      console.log('ìë™ ë¡œê·¸ì¸ ì„¸ì…˜ ì—†ìŒ');
      showLogin();
    }
  } catch (err) {
    console.error('ìë™ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err);
    showLogin();
  }
});


</script>
</body>
</html>

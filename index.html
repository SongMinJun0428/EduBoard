<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduBoard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
  <style>
    /* ===== ê³µí†µ ===== */
    body {
      margin: 0;
      font-family: 'Noto Sans KR', sans-serif;
      background: #f8f9fa;
      color: #333;
    }
    header {
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      color: #007bff;
    }
    #profile-icon {
      cursor: pointer;
      font-size: 1.3rem;
      margin-left: 1rem;
    }
    nav {
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 0.75rem;
    }
    nav a {
      text-decoration: none;
      color: #495057;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
    }
    nav a:hover {
      background: #e9ecef;
      color: #007bff;
    }
    .content {
      padding: 2rem;
      max-width: 1000px;
      margin: auto;
    }
    .panel {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    button {
      background: #007bff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background: #0056b3;
    }
    input[type=text],
    input[type=password],
    input[type=email],
    input[type=number],
    textarea {
      display: block;
      width: 100%;
      height: 40px;
      padding: 0 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      margin-bottom: 0.8rem;
      font-size: 0.95rem;
      background: #fff;
      box-sizing: border-box;
    }
    textarea {
      height: 80px;
      padding: 0.6rem;
    }
    #login-screen {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #ffffff;
    }
    .auth-box {
      background: #fff;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 320px;
      text-align: center;
    }
    .auth-box h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #007bff;
    }
    /* ë¬¸ì„œ ë¶„ì„ íŒ¨ë„ ë‚´ë¶€ ì „ìš© ìŠ¤íƒ€ì¼ */
    #doc-panel h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
      color: #343a40;
    }

    #doc-panel input[type="file"] {
      margin-bottom: 0.8rem;
    }

    #doc-panel h3 {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      color: #495057;
      border-top: 1px solid #dee2e6;
      padding-top: 0.8rem;
    }

    #doc-panel textarea {
      width: 100%;
      min-height: 150px;
      resize: vertical;
      font-size: 0.95rem;
      line-height: 1.4rem;
      padding: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 0.5rem;
      background: #fdfdfd;
      margin-bottom: 1rem;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }

    /* ë²„íŠ¼ë“¤ì„ ë‚˜ë€íˆ ë‘ê³  ì‹¶ë‹¤ë©´ flex */
    #doc-panel .button-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    #doc-panel .button-group button {
      flex: 1;
    }

    /* ë²„íŠ¼ ìƒ‰ìƒ ê°œì„  */
    #doc-panel button {
      background: #007bff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.6rem 1rem;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    #doc-panel button:hover {
      background: #0056b3;
    }

    #doc-result {
      width: 100%;
      min-height: 100px;       /* ìµœì†Œ ë†’ì´ */
      resize: none;            /* ìˆ˜ë™ í¬ê¸°ì¡°ì ˆ ë¹„í™œì„±í™” */
      overflow: hidden;        /* ë„˜ì¹˜ëŠ” ìŠ¤í¬ë¡¤ ì œê±° */
      font-size: 0.95rem;
      line-height: 1.4rem;
      padding: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 0.5rem;
      background: #fdfdfd;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }

    #homework-panel label {
      font-weight: 600;
      margin-top: 0.5rem;
      display: block;
      margin-bottom: 0.3rem;
      color: #495057;
    }

    #homework-panel input[type="text"],
    #homework-panel input[type="file"],
    #homework-panel textarea {
      display: block;
      width: 100%;
      padding: 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      font-size: 0.95rem;
      margin-bottom: 1rem;
      background: #fff;
      box-sizing: border-box;
    }

    #homework-panel textarea {
      min-height: 80px;
      resize: vertical;
    }

    @media (max-width: 768px) {
  .container {
    padding: 12px;
  }

  .top-bar h1 {
    font-size: 20px;
  }

  .logout {
    font-size: 14px;
    padding: 8px 12px;
  }

  .card {
    padding: 12px;
  }

  .card h2 {
    font-size: 16px;
  }

  .card button {
    font-size: 14px;
    padding: 10px;
  }
}

/* ğŸ“± ë” ì‘ì€ í™”ë©´ (ì˜ˆ: 480px ì´í•˜) */
@media (max-width: 480px) {
  .top-bar {
    flex-direction: column;
    align-items: flex-start;
  }

  .logout {
    margin-top: 8px;
    width: 100%;
  }
}



  </style>
</head>
<body>

  <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… -->
  <div id="login-screen">
    <div class="auth-box" id="login-box">
      <h2>ë¡œê·¸ì¸</h2>
      <input id="loginUsername" type="text" placeholder="ì•„ì´ë””">
      <input id="loginPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
      <button onclick="loginDirect()">ë¡œê·¸ì¸</button>
      <p style="font-size:0.85rem;">
        ì•„ì´ë””ê°€ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" onclick="showSignup()">íšŒì›ê°€ì…</a>
      </p>
      <div id="loginStatus" style="font-size:0.85rem;color:red;"></div>
    </div>

    <div class="auth-box" id="signup-box" style="display:none;">
      <h2>íšŒì›ê°€ì…</h2>
      <input id="signupUsername" type="text" placeholder="ì•„ì´ë””">
      <input id="signupEmail" type="email" placeholder="ì´ë©”ì¼">
      <input id="signupPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
      <input id="signupName" type="text" placeholder="ì´ë¦„">
      <input id="signupGrade" type="number" placeholder="í•™ë…„">
      <input id="signupClass" type="number" placeholder="ë°˜">
      <input id="signupNumber" type="number" placeholder="ë²ˆí˜¸">
      <button onclick="signup()">ê°€ì…í•˜ê¸°</button>
      <p style="font-size:0.85rem;">
        <a href="#" onclick="showLogin()">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      </p>
      <div id="signupStatus" style="font-size:0.85rem;color:red;"></div>
    </div>
  </div>

  <!-- ë©”ì¸ ì•± -->
  <div id="main-app" style="display:none;">
    <header>
      <h1>EduBoard</h1>
      <div style="display:flex;align-items:center;">
        <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        <span id="profile-icon">ğŸ‘¤</span>
      </div>
    </header>

    <nav id="main-nav">
      <a href="#" onclick="showPanel('notice-panel')">ê³µì§€ì‚¬í•­</a>
      <a href="#" onclick="showPanel('doc-panel')">ë¬¸ì„œ ë¶„ì„</a>
      <a href="#" onclick="showPanel('student-panel')">í•™ìƒ ê´€ë¦¬</a>
      <a href="#" onclick="showPanel('homework-panel')">ê³¼ì œ ì œì¶œ</a>
      <a href="#" onclick="showPanel('chat-panel')">ìƒë‹´ì‹¤</a>
      <a href="#" onclick="showPanel('timetable-panel')">ì‹œê°„í‘œ</a>
      <a href="#" onclick="showPanel('materials-panel')">ìë£Œì‹¤</a>
    </nav>

    <div class="content">
      <div id="notice-panel" class="panel" style="display:none;">
        <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
        <div id="notice-list"></div>
        <h3>ìƒˆ ê³µì§€ ë“±ë¡</h3>
        <input type="text" id="notice-title" placeholder="ì œëª©"/>
        <textarea id="notice-content" placeholder="ë‚´ìš©"></textarea>
        <button onclick="addNotice()">ê³µì§€ ì¶”ê°€</button>
      </div>

      <div id="doc-panel" class="panel">
        <h2>ğŸ“„ ë¬¸ì„œ ì—…ë¡œë“œ</h2>
        <input type="file" id="doc-file" accept=".pdf,.jpg,.png"/>
        <div class="button-group">
          <button onclick="analyzeDocument()">ë¬¸ì„œ ë¶„ì„í•˜ê¸°</button>
        </div>

        <h3>ë¶„ì„ ê²°ê³¼ (ìˆ˜ì • ê°€ëŠ¥)</h3>
          <textarea 
            id="doc-result"
            placeholder="ë¶„ì„ëœ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. í•„ìš”í•˜ë©´ ìˆ˜ì • í›„ ë“±ë¡í•˜ì„¸ìš”."
            style="
              min-height:100px;
              resize:none;
              overflow:hidden;
              width:100%;
              padding:0.8rem;
              font-size:0.95rem;
              line-height:1.4rem;
              border:1px solid #ced4da;
              border-radius:0.5rem;
              background:#fdfdfd;
              box-shadow:inset 0 1px 2px rgba(0,0,0,0.04);
            ">
          </textarea>



        <div class="button-group">
          <button onclick="registerAnalyzedText()">ë¶„ì„ëœ ê¸€ ë“±ë¡í•˜ê¸°</button>
        </div>
      </div>



      <div id="student-panel" class="panel" style="display:none;">
        <h2>ğŸ‘©â€ğŸ“ í•™ìƒ ê´€ë¦¬</h2>
        <button onclick="loadStudents()">í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <ul id="student-list"></ul>
      </div>

      <div id="homework-panel" class="panel" style="display:none;">
        <h2>ğŸ“š ìˆ™ì œ ì œì¶œí•˜ê¸°</h2>
        
        <!-- ì´ë¦„ -->
        <label for="homework-name">ì´ë¦„</label>
        <input type="text" id="homework-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”">

        <!-- ê³¼ì œëª… -->
        <label for="homework-title">ê³¼ì œëª…</label>
        <input type="text" id="homework-title" placeholder="ì˜ˆ: íŒŒì´ì¬ 2ì£¼ì°¨ ìˆ™ì œ">

        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <label for="homework-file">ìˆ™ì œ íŒŒì¼ ì—…ë¡œë“œ</label>
        <input type="file" id="homework-file">

        <!-- ì½”ë©˜íŠ¸ -->
        <label for="homework-comment">ì½”ë©˜íŠ¸ (ì„ íƒ)</label>
        <textarea id="homework-comment" placeholder="ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”"></textarea>

        <button onclick="submitHomework()">ì œì¶œí•˜ê¸°</button>
        <div id="homework-status" style="margin-top:0.5rem;font-size:0.9rem;color:#007bff;"></div>
      </div>


      <div id="chat-panel" class="panel" style="display:none;">
        <h2>ğŸ’¬ ìƒë‹´ì‹¤</h2>
        <div id="chat-box" style="border:1px solid #ccc; height:200px; overflow-y:auto; padding:0.5rem; margin-bottom:0.5rem;"></div>
        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
        <button onclick="sendChat()">ë³´ë‚´ê¸°</button>
      </div>

      <div id="profile-panel" class="panel" style="display:none;">
        <h2>ë‚´ ì •ë³´ ìˆ˜ì •</h2>
        <input type="text" id="update-name" placeholder="ì´ë¦„ ìˆ˜ì •">
        <input type="password" id="update-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •">
        <button onclick="updateProfile()">ìˆ˜ì •í•˜ê¸°</button>
        <button onclick="showPanel('doc-panel')">â† ëŒì•„ê°€ê¸°</button>
      </div>

      <div id="admin-panel" class="panel" style="display:none;">
        <h2>âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h2>
        <input type="text" id="admin-user-id" placeholder="ì‚¬ìš©ì ID"/>
        <select id="admin-role">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
        <button onclick="changeRole()">ê¶Œí•œ ë³€ê²½</button>
        <button onclick="deleteUser()">ì‚¬ìš©ì ì‚­ì œ</button>
        <div id="admin-status" style="margin-top:0.5rem;"></div>
      </div>

      <!-- âœ… ì‹œê°„í‘œ íŒ¨ë„ -->
      <!-- âœ… ì‹œê°„í‘œ íŒ¨ë„ (EduBoard ìŠ¤íƒ€ì¼ ë§ì¶¤) -->
      <div id="timetable-panel" class="panel" style="display:none;">
        <h2>ğŸ—“ï¸ ë‚˜ì˜ ì‹œê°„í‘œ</h2>
        <p style="margin-bottom:1rem; color:#495057; font-size:0.95rem;">
          ë´‰ë‹´ì¤‘í•™êµ / ë¡œê·¸ì¸í•œ í•™ë…„Â·ë°˜ ê¸°ì¤€ ì‹œê°„í‘œë¥¼ ì•„ë˜ì—ì„œ í™•ì¸í•˜ì„¸ìš”.
        </p>

        <!-- ìƒë‹¨ ì •ë³´ ì˜ì—­ -->
        <div id="timetable-info" style="
              display:flex;
              justify-content:space-between;
              align-items:center;
              background:#f1f3f5;
              padding:0.75rem 1rem;
              border-radius:0.5rem;
              margin-bottom:1rem;
              font-size:0.9rem;
              color:#333;">
          <span id="timetable-grade-info">í•™ë…„/ë°˜ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
          <button onclick="reloadTimetable()" style="
              background:#007bff;
              border:none;
              border-radius:0.5rem;
              padding:0.4rem 0.8rem;
              color:#fff;
              font-weight:600;
              cursor:pointer;">
            ğŸ”„ ìƒˆë¡œê³ ì¹¨
          </button>
        </div>

        <!-- iframe ì˜ì—­ -->
        <div style="
              border:1px solid #dee2e6;
              border-radius:0.75rem;
              overflow:hidden;
              box-shadow:0 2px 4px rgba(0,0,0,0.05);">
          <iframe id="timetable-iframe"
                  width="100%"
                  height="600"
                  frameborder="0"
                  style="border:none; display:block;">
          </iframe>
        </div>
      </div>



      <!-- âœ… ìë£Œì‹¤ íŒ¨ë„ -->
      <div id="materials-panel" class="panel" style="display:none;">
        <h2>ğŸ“‚ ìë£Œì‹¤</h2>
        <input type="file" id="material-file">
        <button onclick="uploadMaterial()">ì—…ë¡œë“œ</button>
        <div id="material-status" style="margin-top:0.5rem;"></div>
        <h3>ìë£Œ ëª©ë¡</h3>
        <ul id="material-list"></ul>
        <button onclick="loadMaterials()">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
  </div>

<script>
const { createClient } = supabase;
const supabaseClient = createClient(
  'https://ucmzrkwrsezfdjnnwsww.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjbXpya3dyc2V6ZmRqbm53c3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NDIzODcsImV4cCI6MjA2ODQxODM4N30.rvLItmDStjWb3GfECnCXocHvj-CMTfHfD1CHsAHOLaw'
);

let currentUserRole = 'user';

async function loginDirect() {
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;

  const { data: user } = await supabaseClient
    .from('users')
    .select('*')
    .eq('username', username)
    .eq('password', password)
    .single();

  if (user) {
    currentUserRole = user.role || 'user';
    showMyTimetable(user.grade, user.class_num);
    showMain();
    loadNotices();

    // âœ… ë¡œê·¸ì¸ ì„±ê³µ ì‹œ localStorageì— ì €ì¥
    localStorage.setItem('savedUsername', username);
  } else {
    document.getElementById('loginStatus').innerText = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
  }
}


async function signup() {
  const username = document.getElementById('signupUsername').value.trim();
  const password = document.getElementById('signupPassword').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const name = document.getElementById('signupName').value.trim();
  const grade = parseInt(document.getElementById('signupGrade').value);
  const classNum = parseInt(document.getElementById('signupClass').value);
  const studentNumber = parseInt(document.getElementById('signupNumber').value);

  // 1. username ì¤‘ë³µ ì²´í¬
  const { data: existing, error: checkError } = await supabaseClient
    .from('users')
    .select('username')
    .eq('username', username)
    .maybeSingle();

  if (checkError) {
    console.error('ì¤‘ë³µì²´í¬ ì˜¤ë¥˜:', checkError);
    document.getElementById('signupStatus').innerText = 'ì˜¤ë¥˜ ë°œìƒ: ' + checkError.message;
    return;
  }

  if (existing) {
    document.getElementById('signupStatus').innerText = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.';
    return;
  }

  // 2. insert
  const { data, error } = await supabaseClient.from('users').insert([{
    username: username,
    password: password,
    name: name,
    grade: grade,
    email: email,
    class_num: classNum,
    student_number: studentNumber,
    coin_balance: 0,
    role: 'user'
  }]);

  if (error) {
    console.error('insert ì˜¤ë¥˜:', error);
    document.getElementById('signupStatus').innerText = 'íšŒì›ê°€ì… ì‹¤íŒ¨: ' + error.message;
    return;
  }

  console.log('íšŒì›ê°€ì… ì„±ê³µ:', data);
  document.getElementById('signupStatus').innerText = 'íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.';
  showLogin();
}

function showMain() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  setupAdminNav();
}

function showSignup() {
  document.getElementById('login-box').style.display = 'none';
  document.getElementById('signup-box').style.display = 'block';
}

function showLogin() {
  document.getElementById('login-box').style.display = 'block';
  document.getElementById('signup-box').style.display = 'none';
}

async function logout() {
  await supabaseClient.auth.signOut();
  localStorage.removeItem('savedUsername'); // âœ… ë¡œê·¸ì•„ì›ƒ ì‹œ ì €ì¥ëœ ì•„ì´ë”” ì‚­ì œ
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
}

async function updateProfile() {
  const newName = document.getElementById('update-name').value;
  const newPass = document.getElementById('update-password').value;

  if (newPass) {
    const { error } = await supabaseClient.auth.updateUser({ password: newPass });
    if (error) alert('ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • ì˜¤ë¥˜:' + error.message);
    else alert('ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • ì™„ë£Œ!');
  }
  if (newName) {
    const user = await supabaseClient.auth.getUser();
    if (user && user.data.user) {
      await supabaseClient.from('users').update({ name: newName }).eq('id', user.data.user.id);
      alert('ì´ë¦„ ìˆ˜ì • ì™„ë£Œ!');
    }
  }
}

function showPanel(panelId) {
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  document.getElementById(panelId).style.display = 'block';
}

document.getElementById('profile-icon').addEventListener('click', () => {
  showPanel('profile-panel');
});

supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
  if (session) {
    const { data: user } = await supabaseClient
      .from('users')
      .select('role')
      .eq('id', session.user.id)
      .single();
    if (user) currentUserRole = user.role;
    showMain();
  } else {
    showLogin();
  }
});

function setupAdminNav() {
  if (currentUserRole === 'admin') {
    if (!document.getElementById('admin-nav')) {
      const nav = document.getElementById('main-nav');
      const a = document.createElement('a');
      a.href = '#';
      a.id = 'admin-nav';
      a.innerText = 'ê´€ë¦¬ì ì„¤ì •';
      a.onclick = () => { showPanel('admin-panel'); };
      nav.appendChild(a);
    }
  }
}

// ===== ê³µì§€ì‚¬í•­ ë“±ë¡ =====
async function addNotice() {
  const title = document.getElementById('notice-title').value.trim();
  const content = document.getElementById('notice-content').value.trim();
  if (!title || !content) {
    alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    return;
  }

  const { error } = await supabaseClient.from('notices').insert([{ title, content }]);
  if (error) {
    alert('ê³µì§€ ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
    return;
  }

  // ì…ë ¥ ì´ˆê¸°í™”
  document.getElementById('notice-title').value = '';
  document.getElementById('notice-content').value = '';

  alert('ê³µì§€ ë“±ë¡ ì™„ë£Œ!');

  // ê³µì§€ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
  await loadNotices();

  // âœ… ê³µì§€ íŒ¨ë„ë¡œ ì „í™˜
  showPanel('notice-panel');
}


// ===== ê³µì§€ì‚¬í•­ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° =====
async function loadNotices() {
  const { data, error } = await supabaseClient
    .from('notices')
    .select('*')
    .order('id', { ascending: false });
  if (error) {
    console.error('ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
    return;
  }
  const listEl = document.getElementById('notice-list');
  listEl.innerHTML = '';
  data.forEach(item => {
    // ì¤„ë°”ê¿ˆ(\n)ì„ <br>ë¡œ ë³€í™˜
    const formattedContent = item.content.replace(/\n/g, '<br>');
    const div = document.createElement('div');
    div.style.borderBottom = '1px solid #ddd';
    div.style.padding = '0.5rem 0';
    div.innerHTML = `<strong>${item.title}</strong><br>${formattedContent}`;
    listEl.appendChild(div);
  });
}


// ===== ë¬¸ì„œ ë¶„ì„(OCR) =====
async function analyzeDocument() {
  const fileInput = document.getElementById('doc-file');
  if (!fileInput.files.length) {
    alert('íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
    return;
  }

  const file = fileInput.files[0];
  document.getElementById('doc-result').value = 'ë¬¸ì„œ ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.';

  const reader = new FileReader();
  reader.onload = () => {
    Tesseract.recognize(reader.result, 'kor', { logger: m => console.log(m) })
      .then(({ data: { text } }) => {
        // OCR ê²°ê³¼ë¥¼ textareaì— í‘œì‹œ (ìˆ˜ì • ê°€ëŠ¥)
        document.getElementById('doc-result').value = text;
        autoResize();
        alert('ë¬¸ì„œ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”í•˜ë©´ ë‚´ìš©ì„ ìˆ˜ì •í•œ ë’¤ ë“±ë¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      })
      .catch(err => {
        console.error('OCR ì˜¤ë¥˜:', err);
        document.getElementById('doc-result').value = 'ë¬¸ì„œ ë¶„ì„ ì‹¤íŒ¨: ' + err.message;
      });
  };
  reader.readAsDataURL(file);
}


async function registerAnalyzedText() {
  const text = document.getElementById('doc-result').value.trim();
  if (!text) {
    alert('ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
    return;
  }

  const { error } = await supabaseClient.from('notices').insert([
    { title: 'ë¬¸ì„œ ë¶„ì„ ë“±ë¡', content: text }
  ]);

  if (error) {
    alert('ê³µì§€ ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
    return;
  }

  alert('ë¶„ì„ëœ ê¸€ì´ ê³µì§€ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
  loadNotices(); // ê³µì§€ ëª©ë¡ ê°±ì‹ 
  }

  const docResult = document.getElementById('doc-result');

  // ë†’ì´ ìë™ ì¡°ì • í•¨ìˆ˜
  function autoResize() {
    docResult.style.height = 'auto';  // ì´ˆê¸°í™”
    docResult.style.height = docResult.scrollHeight + 'px'; // ë‚´ìš©ì— ë§ê²Œ ëŠ˜ë¦¼
  }

  // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•  ë•Œë„ ì ìš©
  docResult.addEventListener('input', autoResize);

    async function submitHomework() {
    const name = document.getElementById('homework-name').value.trim();
    const title = document.getElementById('homework-title').value.trim();
    const comment = document.getElementById('homework-comment').value.trim();
    const fileInput = document.getElementById('homework-file');
    const statusEl = document.getElementById('homework-status');

    if (!name || !title || !fileInput.files.length) {
      alert('ì´ë¦„, ê³¼ì œëª…, íŒŒì¼ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      return;
    }

    // Supabase ìŠ¤í† ë¦¬ì§€ì— íŒŒì¼ ì—…ë¡œë“œ
    const file = fileInput.files[0];
    const fileName = Date.now() + '_' + file.name;

    let { error: uploadError } = await supabaseClient.storage
      .from('homework-files') // ìŠ¤í† ë¦¬ì§€ ë²„í‚· ì´ë¦„
      .upload(fileName, file);

    if (uploadError) {
      statusEl.style.color = 'red';
      statusEl.textContent = 'íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadError.message;
      return;
    }

    const { data: publicURLData } = supabaseClient
      .storage
      .from('homework-files')
      .getPublicUrl(fileName);

    const fileURL = publicURLData.publicUrl;

    // DBì— ê¸°ë¡
    const { error: insertError } = await supabaseClient.from('homeworks').insert([{
      name: name,
      title: title,
      comment: comment,
      file_url: fileURL
    }]);

    if (insertError) {
      statusEl.style.color = 'red';
      statusEl.textContent = 'ì œì¶œ ì‹¤íŒ¨: ' + insertError.message;
      return;
    }

    statusEl.style.color = 'green';
    statusEl.textContent = 'âœ… ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
    
    // ì…ë ¥ ì´ˆê¸°í™”
    document.getElementById('homework-name').value = '';
    document.getElementById('homework-title').value = '';
    document.getElementById('homework-comment').value = '';
    document.getElementById('homework-file').value = '';
  }

  // ë´‰ë‹´ì¤‘í•™êµ ì½”ë“œ ê³ ì •
  const SCHOOL_CODE = 'M100000655';

  let currentGrade = null;
  let currentClassNum = null;

  // âœ… ë´‰ë‹´ì¤‘í•™êµ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
  function showMyTimetable(grade, classNum) {
    currentGrade = grade;
    currentClassNum = classNum;

    // ìƒë‹¨ ì •ë³´ ì—…ë°ì´íŠ¸
    const infoEl = document.getElementById('timetable-grade-info');
    if (infoEl) infoEl.textContent = `${grade}í•™ë…„ ${classNum}ë°˜`;

    // URL êµ¬ì„±
    const url = `http://comci.net:4082/st?sch=${SCHOOL_CODE}&grade=${grade}&class=${classNum}`;
    const iframe = document.getElementById('timetable-iframe');
    if (iframe) iframe.src = url;

    // ì‹œê°„í‘œ íŒ¨ë„ í‘œì‹œ
    showPanel('timetable-panel');
  }

  // ğŸ”„ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
  function reloadTimetable() {
    if (currentGrade && currentClassNum) {
      showMyTimetable(currentGrade, currentClassNum);
    }
  }

  window.addEventListener('DOMContentLoaded', async () => {
    // ğŸ‘‰ ì´ì „ì— ë¡œê·¸ì¸í•œ ì•„ì´ë””ê°€ localStorageì— ì €ì¥ë¼ ìˆëŠ”ì§€ í™•ì¸
    const savedUsername = localStorage.getItem('savedUsername');

    if (savedUsername) {
      // Supabaseì—ì„œ í•´ë‹¹ ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
      const { data: user, error } = await supabaseClient
        .from('users')
        .select('*')
        .eq('username', savedUsername)
        .maybeSingle();

      if (error) {
        console.error('ìë™ ë¡œê·¸ì¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
        showLogin();
        return;
      }

      if (user) {
        currentUserRole = user.role || 'user';
        currentGrade = user.grade;
        currentClassNum = user.class_num;

        // ğŸ‘‰ í•™ë…„/ë°˜ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
        showMyTimetable(user.grade, user.class_num);
        showMain();
        loadNotices();
        return; // ìë™ ë¡œê·¸ì¸ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì¢…ë£Œ
      }
    }

    // ğŸ‘‰ ì €ì¥ëœ ì•„ì´ë””ê°€ ì—†ê±°ë‚˜ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í™”ë©´
    showLogin();
  });


  function setupAdminNav() {
    const existing = document.getElementById('admin-nav');

    if (currentUserRole === 'admin') {
      if (!existing) {
        const nav = document.getElementById('main-nav');
        const a = document.createElement('a');
        a.href = '#';
        a.id = 'admin-nav';
        a.innerText = 'ê´€ë¦¬ì ì„¤ì •';
        a.onclick = () => { showPanel('admin-panel'); };
        nav.appendChild(a);
      }
    } else {
      if (existing) existing.remove();
    }
  }




</script>
</body>
</html>

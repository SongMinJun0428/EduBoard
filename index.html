<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduBoard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Noto Sans KR', sans-serif;
      background: #f8f9fa;
      color: #333;
    }

    header {
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    #profile-wrapper {
      position: relative;
      margin-left: auto;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      color: #007bff;
    }

    #profile-icon {
      cursor: pointer;
      font-size: 1.3rem;
      margin-left: 1rem;
    }

    nav {
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 0.75rem;
    }

    nav a {
      text-decoration: none;
      color: #495057;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
    }

    nav a:hover {
      background: #e9ecef;
      color: #007bff;
    }

    .content {
      padding: 2rem;
      max-width: 1000px;
      margin: auto;
    }

    .panel {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }

    button {
      background: #007bff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      margin-bottom: 0.5rem;
    }

    button:hover {
      background: #0056b3;
    }

    input[type=text],
    input[type=password],
    input[type=email],
    input[type=number],
    textarea {
      display: block;
      width: 100%;
      height: 40px;
      padding: 0 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      margin-bottom: 0.8rem;
      font-size: 0.95rem;
      background: #fff;
      box-sizing: border-box;
    }

    textarea {
      height: 80px;
      padding: 0.6rem;
    }

    #login-screen {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #ffffff;
    }

    .auth-box {
      background: #fff;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 320px;
      text-align: center;
    }

    .auth-box h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #007bff;
    }

    #doc-panel h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
      color: #343a40;
    }

    #doc-panel input[type="file"] {
      margin-bottom: 0.8rem;
    }

    #doc-panel h3 {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      color: #495057;
      border-top: 1px solid #dee2e6;
      padding-top: 0.8rem;
    }

    #doc-panel textarea {
      width: 100%;
      min-height: 150px;
      resize: vertical;
      font-size: 0.95rem;
      line-height: 1.4rem;
      padding: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 0.5rem;
      background: #fdfdfd;
      margin-bottom: 1rem;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }

    #doc-panel .button-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    #doc-panel .button-group button {
      flex: 1;
    }

    #doc-panel button {
      background: #007bff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.6rem 1rem;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    #doc-panel button:hover {
      background: #0056b3;
    }

    #doc-result {
      width: 100%;
      min-height: 100px;      
      resize: none;          
      overflow: hidden;        
      font-size: 0.95rem;
      line-height: 1.4rem;
      padding: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 0.5rem;
      background: #fdfdfd;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }
    
    #homework-panel label {
      font-weight: 600;
      margin-top: 0.5rem;
      display: block;
      margin-bottom: 0.3rem;
      color: #495057;
    }

    #homework-panel input[type="text"],
    #homework-panel input[type="file"],
    #homework-panel textarea {
      display: block;
      width: 100%;
      padding: 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      font-size: 0.95rem;
      margin-bottom: 1rem;
      background: #fff;
      box-sizing: border-box;
    }

    #homework-panel textarea {
      min-height: 80px;
      resize: vertical;
    }

    .mobile-only {
      display: none;
    }

    
    @media (max-width: 768px) {
      header {
        display: none !important;
      }

      .mobile-only {
        display: block;
      }

      .mobile-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 56px;
        background-color: #f8f8f8;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 3000;
      }

      .menu-icon {
        font-size: 24px;
        cursor: pointer;
      }

      .mobile-title {
        font-weight: bold;
        font-size: 18px;
      }

      .mobile-user {
        font-size: 14px;
        color: #333;
        white-space: nowrap;    
        overflow: visible;      
        max-width: none; 
      }

      .mobile-side-menu {
        position: fixed;
        top: 0;
        left: 0;
        transform: translateX(-100%);
        width: 250px;
        height: 100%;
        background: white;
        padding: 80px 20px 20px;
        z-index: 2900;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        transition: left 0.3s ease;
      }

      .mobile-side-menu.open {
        transform: translateX(0);;
      }

      .mobile-side-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .mobile-side-menu li {
        margin-bottom: 1rem;
      }

      .mobile-side-menu a {
        text-decoration: none;
        font-size: 16px;
        color: #333;
      }

      .mobile-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.3);
        z-index: 2800;
      }

      .mobile-overlay.show {
        display: block;
      }

      hr {
        border: none;
        border-top: 1px solid #ccc;
        margin: 16px 0;
      }

      nav {
        display: flex;
        gap: 2rem;
      }

      @media (max-width: 768px) {
        nav {
          visibility: hidden; 
          height: 1.2rem;      
          margin-top: 0.5rem;  
        }

        .preview-container img {
          width: 100px;
          height: 100px;
        }
      }
    }

    .login-help {
      margin-top: 1rem;
      text-align: center;
      font-size: 0.9rem;
    }

    .login-help a {
      color: #007bff;
      text-decoration: none;
      margin: 0 0.5rem;
    }

    .login-help a:hover {
      text-decoration: underline;
    }
    
    .mini-btn {
      padding: 2px 6px;
      font-size: 0.75rem;
      border-radius: 4px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      line-height: 1;
    }

    .mini-btn:hover {
      background: #0056b3;
    }

    .week-nav {
      display: flex;
      border: 2px solid #007bff;
      border-radius: 8px;
      overflow: hidden;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      height: 44px;
    }

    .nav-btn {
      flex: 1;
      background-color: white;
      color: #007bff;
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      border-right: 1px solid #007bff;
      display: flex;                 
      align-items: center;          
      justify-content: center;      
      height: 100%;                 
      line-height: 1;                
      padding: 0;                   
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .nav-btn:last-child {
      border-right: none;
    }

    .nav-btn:hover {
      background-color: #e6f0ff;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }

    .dashboard-card {
      background: #fff;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      min-height: 180px;
    }
    .dashboard-card h3 {
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    .dashboard-card small {
      color: #888;
      font-size: 0.85rem;
    }

    #dashboard-container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 1.5rem;
      padding: 2rem;
    }

    .dashboard-panel {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      width: 100%;
      max-width: 500px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .nav-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #timetable-grade-class {
      margin-bottom: 1rem;
    }

    #dashboard-timetable-list {
      list-style: none;
      padding-left: 1rem;
    }

    #dashboard-meal-info {
      white-space: pre-line;
    }

    .preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 1rem;
      }
      .preview-container img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        cursor: pointer;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.8);
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      .modal img {
        max-width: 90%;
        max-height: 70%;
        margin-bottom: 1rem;
      }
      .modal a {
        color: #fff;
        background: #007bff;
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 6px;
      }
      .close {
        position: absolute;
        top: 20px; right: 30px;
        font-size: 36px;
        color: white;
        cursor: pointer;
      }

      /* ========== DASH: ìƒë‹¨ 2ì—´ ========== */
.dash-top{display:grid;grid-template-columns:1fr 380px;gap:20px}
@media (max-width:980px){.dash-top{grid-template-columns:1fr}}
.card{background:#fff;border:1px solid #e9ecef;border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.05)}
.card-body{padding:18px 20px}
.section-head{display:flex;justify-content:space-between;align-items:center;margin:2px 0 12px}
.section-head .mini{font-size:.85rem;color:#6c757d}
.link-btn{background:#f6f7fb;border:1px solid #e9ecf3;border-radius:10px;padding:6px 10px;font-weight:600;color:#495057;cursor:pointer}
.link-btn:hover{background:#eef1f8}

/* ê³µì§€ ë¦¬ìŠ¤íŠ¸ */
.notice-list{display:flex;flex-direction:column;gap:10px}
.notice-item{padding:12px;border:1px solid #eef0f2;border-radius:12px}
.notice-item .title{font-weight:700;margin-bottom:4px}
.notice-item .meta{color:#6c757d;font-size:.85rem}

.profile-card{display:flex;gap:18px;align-items:flex-start;position:relative}
.profile-illust{flex-shrink:0}
.profile-avatar{
  width:120px;height:120px;border-radius:20px;background:#f4f6ff;
  display:grid;place-items:center;font-size:56px;box-shadow:0 6px 18px rgba(79,70,229,.15)
}
.profile-info{flex:1;display:flex;flex-direction:column}
.info-top{display:flex;justify-content:space-between;align-items:center}
.profile-name{font-size:20px;font-weight:800}
.profile-sub{margin:8px 0 10px;font-size:14px;color:#555;line-height:1.5}
.points-chip{display:inline-flex;gap:6px;align-items:center;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff}
.p-dot{width:8px;height:8px;border-radius:50%;background:#a78bfa}
.lvl-wrap{margin-top:auto}
.lvl-head{display:flex;justify-content:space-between;color:#6b7280;font-size:12px;margin-bottom:6px}
.lvl-bar{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden}
.lvl-fill{height:100%;width:0%;background:linear-gradient(90deg,#4f46e5,#6366f1)}
.lvl-badge{position:absolute;top:-10px;left:-10px;background:#7c3aed;color:#fff;padding:4px 8px;border-radius:10px;font-size:12px;font-weight:800;box-shadow:0 6px 14px rgba(124,58,237,.25)}




/* ë‹¬ë ¥ ì…€ */
/* ë‹¬ë ¥ ë˜í¼ì— ê³ ì • ë†’ì´(ì¹´ë“œ ì•ˆì—ì„œ ìŠ¤í¬ë¡¤ ì—†ì´ ë‹¤ ë³´ì´ê²Œ) */
.sched-grid{
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  grid-template-rows: repeat(6, 1fr);    /* 6ì¤„ ê³ ì • */
  gap: 6px;
  height: 520px;                          /* í•„ìš” ì‹œ 460~600pxë¡œ ì¡°ì ˆ */
}

/* ì…€ì„ ì¤„ì—¬ì„œ ì •ë³´ê°€ ë“¤ì–´ê°€ë„ í–‰ ë†’ì´ ìœ ì§€ */
.sched-cell{
  background:#fff; border:1px solid #e5e7eb; border-radius:10px;
  padding:6px; display:flex; flex-direction:column; min-height:0;
  overflow:hidden;                          /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ê°ì¶”ê¸° */
}
.sched-day{font-weight:800; font-size:.9rem; line-height:1.1rem}
.sched-items{display:flex; flex-direction:column; gap:2px; margin-top:2px; overflow:hidden}

/* ì•„ì´í…œ(ê³¼ëª© - êµì‹œ) 2ì¤„ê¹Œì§€ë§Œ ë³´ì´ê³  ë‚˜ë¨¸ì§€ëŠ” ìˆ¨ê¹€ */
.sched-item{
  font-size:.74rem; line-height:1.05rem; color:#374151;
  background:#f6f7fb; border:1px solid #e9ecf3; border-radius:6px; padding:1px 5px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.sched-items{max-height: 2.3rem;}          /* ëŒ€ëµ 2ì¤„ */
.sched-more{font-size:.7rem; color:#6b7280}

/* ìƒíƒœ ê°•ì¡° */
.sched-cell.out{opacity:.45}
.sched-cell.today{
  outline: none;
  border-color:#c7d2fe;
  background:#fafbff;
}

/* ê¸°ì¡´ .sched-cell.has ìŠ¤íƒ€ì¼ì—ì„œ ë°°ê²½ ì œê±° */
.sched-cell.has {
  border-color:#c7d2fe;
  background:#fff;   /* âœ… í°ìƒ‰ìœ¼ë¡œ ê³ ì • */
}


/* ë°˜ì‘í˜•: ì¢ì€ í™”ë©´ì—ì„  ë†’ì´ë¥¼ ì¡°ê¸ˆ ì¤„ì—¬ì„œ 6ì¤„ ìœ ì§€ */
@media (max-width: 750px){
  .sched-grid{height:460px;}
  .sched-day{font-size:.85rem}
  .sched-item{font-size:.7rem}
}

.sched-week-row{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
  margin:.5rem 0 .25rem;
  color:#6b7280;
  font-size:.9rem;
  text-align:center;
}
.sched-week-row span{padding:2px 0}

/* ê¸°ì¡´ .sched-grid ê·œì¹™ì€ ìœ ì§€í•˜ë˜, id ìš°ì„ ìœ¼ë¡œ í•œ ë²ˆ ë” ê°•ì œ */
#sched-grid{
  display:grid !important;
  grid-template-columns:repeat(7,1fr);
  grid-template-rows:repeat(6,1fr); /* 6ì£¼ ê³ ì • */
  gap:6px;
  height:520px;                      /* í•„ìš”ì‹œ 460~600pxë¡œ ì¡°ì ˆ */
}

/* ===== í•™ì‚¬ì¼ì • ë±ƒì§€ ===== */
.sched-evts{display:flex;flex-direction:column;gap:2px;margin-top:4px;overflow:hidden}
.sched-evt{
  font-size:.72rem; line-height:1.05rem; 
  border-radius:999px; padding:1px 6px; 
  border:1px solid #e9ecf3; background:#f6f7fb; 
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.sched-evt.exam{background:#fff7ed;border-color:#fed7aa}     /* ì‹œí—˜ */
.sched-evt.holiday{background:#fef2f2;border-color:#fecaca}  /* ê³µíœ´ì¼/íœ´ì—… */
.sched-evt.event{background:#f0f9ff;border-color:#bae6fd}    /* í–‰ì‚¬ ì¼ë°˜ */

.sched-legend{display:flex;gap:8px;align-items:center;margin-top:8px;font-size:.85rem;color:#555}
.sched-chip{display:inline-flex;align-items:center;gap:6px}
.sched-chip .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
.dot.exam{background:#fb923c}
.dot.holiday{background:#f87171}
.dot.event{background:#60a5fa}

.sched-cell.selected {
  border: 2px solid #7c3aed;   /* ë³´ë¼ìƒ‰ */
  border-radius: 6px;
}

</style>
</head>
  <body>
    <!-- ë¡œê·¸ì¸, íšŒì›ê°€ì… -->
    <div id="login-screen">
      <div class="auth-box" id="login-box">
        <h2>ë¡œê·¸ì¸</h2>
        <input id="loginUsername" type="text" placeholder="ì•„ì´ë””">
        <input id="loginPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button onclick="loginDirect()">ë¡œê·¸ì¸</button>
        <p style="font-size:0.85rem;">
        ì•„ì´ë””ê°€ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" onclick="showSignup()">íšŒì›ê°€ì…</a>
        <div class="login-help">
          <a href="find-id.html">ì•„ì´ë”” ì°¾ê¸°</a>
          <span>|</span>
          <a href="find-password.html">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
        </div>
        </p>
        <div id="loginStatus" style="font-size:0.85rem;color:red;"></div>
      </div>

      <!-- íšŒì›ê°€ì… ë°•ìŠ¤ -->
      <div class="auth-box" id="signup-box" style="display:none;">
      <h2>íšŒì›ê°€ì…</h2>

      <!-- ê°œì¸ì •ë³´ ìˆ˜ì§‘, ì´ìš© ë™ì˜ -->
      <div style="
        text-align:left;
        font-size:0.8rem;
        margin:0.5rem 0;
        border:1px solid #ddd;
        padding:0.6rem;
        border-radius:0.5rem;
        background:#f8f9fa;">
        <p style="margin:0 0 0.4rem 0; font-weight:bold;">ğŸ“Œ ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜</p>
        <p style="margin:0 0 0.3rem 0; line-height:1.4;">
          ìˆ˜ì§‘ í•­ëª©: ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸, ì´ë©”ì¼, ì´ë¦„, í•™ë…„, ë°˜, ë²ˆí˜¸<br>
          ì´ìš© ëª©ì : EduBoard íšŒì› ê´€ë¦¬ ë° ìˆ˜ì—… ìë£Œ ì œê³µ<br>
          ë³´ìœ  ê¸°ê°„: íšŒì› íƒˆí‡´ ì‹œê¹Œì§€ (ë²•ë ¹ì— ë”°ë¼ ë³´ê´€ í•„ìš” ì‹œ í•´ë‹¹ ê¸°ê°„ ë³´ì¡´)<br>
          ë™ì˜ ê±°ë¶€ ì‹œ íšŒì›ê°€ì…ì´ ì œí•œë©ë‹ˆë‹¤.
        </p>
        <label style="display:flex;align-items:center;font-weight:600;">
          <input type="checkbox" id="privacy-agree" style="margin-right:0.4rem;">
          ìœ„ ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.
        </label>
      </div>

      <!-- ì…ë ¥ í¼ -->
      <input id="signupUsername" type="text" placeholder="ì•„ì´ë””">
      <div style="position:relative; margin-bottom: 0.8rem;">
        <input id="signupPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" required />
        <span onclick="togglePassword('signupPassword')" style="
          position:absolute; right:10px; top:50%; transform:translateY(-50%);
          cursor:pointer;">ğŸ‘ï¸</span>
      </div>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 0.8rem;">
      <input id="signupEmailId" type="text" placeholder="ì´ë©”ì¼ ì•„ì´ë””" style="flex:1;" />
        <span>@</span>
        <select id="signupEmailDomain" style="flex:1;">
          <option value="gmail.com">gmail.com</option>
          <option value="naver.com">naver.com</option>
          <option value="daum.net">daum.net</option>
          <option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
        </select>
      </div>
      <input id="signupEmailCustom" type="text" placeholder="ë„ë©”ì¸ ì…ë ¥" style="display:none; margin-bottom:0.8rem;" />
      <input id="signupName" type="text" placeholder="ì´ë¦„">
      <input id="signupGrade" type="number" placeholder="í•™ë…„">
      <input id="signupClass" type="number" placeholder="ë°˜">
      <input id="signupNumber" type="number" placeholder="ë²ˆí˜¸">

      <!-- íšŒì›ê°€ì… ë²„íŠ¼ (ë™ì˜ ì‹œ ë³´ì´ë„ë¡) -->
      <button id="signup-btn" onclick="signup()" style="display:none;">íšŒì›ê°€ì… ì™„ë£Œ</button>

      <p style="font-size:0.85rem;">
        <a href="#" onclick="showLogin()">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      </p>
      <div id="signupStatus" style="font-size:0.85rem;color:red;"></div>
      </div>
    </div>

    <!-- ë©”ì¸ ì›¹ -->
    <div id="main-app" style="display:none;">
      <header>
        <h1>EduBoard</h1>
        <div id="profile-wrapper" style="position: relative;">
          <button id="profile-button" style="
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;">
            ğŸ‘¤ <span id="profile-name-display">ì´ë¦„</span> â–¼
          </button>
          <div id="profile-dropdown" style="
            display: none;
            position: absolute;
            right: 0;
            top: 120%;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            z-index: 1000;
            min-width: 140px;">
            <button onclick="showPanel('profile-panel')" style="
              width: 100%;
              padding: 0.6rem 1rem;
              background: none;
              border: none;
              text-align: left;
              color: black;
              cursor: pointer;
              font-size: 0.95rem;">
              ë‚´ ì •ë³´ ìˆ˜ì •
            </button>
            <button onclick="logout()" style="
              width: 100%;
              padding: 0.6rem 1rem;
              background: none;
              border: none;
              text-align: left;
              color: black;
              cursor: pointer;
              font-size: 0.95rem;">
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>

        <!-- âœ… ì˜¤ë²„ë ˆì´ -->
        <div id="mobile-overlay" class="mobile-overlay" onclick="closeMobileMenu()"></div>
      </header>
      <!-- âœ… ëª¨ë°”ì¼ ì „ìš© ìƒë‹¨ í—¤ë” -->
      <div class="mobile-only mobile-header">
        <div class="menu-icon" onclick="toggleMobileMenu()">â˜°</div>
        <div class="mobile-title">EduBoard</div>
        <div class="mobile-user" id="mobile-user-name">admin</div>
      </div>

      <nav id="main-nav">
        <a href="#" onclick="showPanel('dashboard')">ëŒ€ì‹œë³´ë“œ</a>
        <a href="#" onclick="showPanel('notice-panel')">ê³µì§€ì‚¬í•­</a>
        <a href="#" onclick="showPanel('doc-panel')">ìˆ˜í–‰ ë“±ë¡</a>
        <!-- <a href="#" onclick="showPanel('student-panel')">í•™ìƒ ê´€ë¦¬</a> -->
        <a href="#" onclick="showPanel('homework-panel')">íŒŒì¼ ê³µìœ  & ìë£Œì‹¤</a>
        <!-- <a href="#" onclick="showPanel('chat-panel')">ëŒ€í™”ì‹¤</a> -->
        <a href="#" onclick="showPanel('timetable-panel')">ì‹œê°„í‘œ</a>
        <a href="#" onclick="showPanel('minigame-panel')">ë¯¸ë‹ˆê²Œì„</a>
      </nav>
      
      <div class="content">
        <div id="dashboard" class="panel active">
          <h2>ğŸ  ëŒ€ì‹œë³´ë“œ</h2>
          <div class="dash-top">

            <!-- ì¢Œ: ìµœê·¼ ê³µì§€ 3ê±´ -->
            <div class="card">
                <div class="card-body">
                <div class="section-head">
                    <h3>ğŸ“¢ ìµœê·¼ ê³µì§€</h3>
                    <span class="mini" id="dash-notice-date"></span>
                </div>
                <div id="dash-notice-list" class="notice-list">
                    <!-- JSê°€ ì±„ì›€ -->
                </div>
                </div>
            </div>

            <!-- ìš°: í”„ë¡œí•„ + ë ˆë²¨/í¬ì¸íŠ¸ (ë ˆë²¨/í¬ì¸íŠ¸ëŠ” ë³„ê°œ) -->
            <div class="card">
  <div class="card-body">
    <div class="profile-card">
      <span class="lvl-badge">Lv <span id="lv-num">1</span></span>

      <!-- ì™¼ìª½ í° ì•„ë°”íƒ€ -->
      <div class="profile-illust">
        <div class="profile-avatar" id="dash-avatar">ğŸ™‚</div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ ì •ë³´ -->
      <div class="profile-info">
        <div class="info-top">
          <div class="profile-name">
            <span id="dash-name">admin</span>
            <small style="margin-left:4px;color:#6c757d">í•™ìƒ</small>
          </div>
          <div class="points-chip">
            <span class="p-dot"></span> P <span id="coin-balance" style="margin-left:4px">99999999</span>
          </div>
        </div>

        <div class="profile-sub">
          <div id="dash-school">ë´‰ë‹´ì¤‘í•™êµ</div>
          <div><span id="dash-grade">-</span>í•™ë…„ <span id="dash-class">-</span>ë°˜ <span id="dash-num">0</span>ë²ˆ</div>
        </div>

        <!-- ë ˆë²¨ë°” -->
        <div class="lvl-wrap">
          <div class="lvl-head">
            <span>ê²½í—˜ì¹˜</span>
            <span><span id="exp-cur">0</span> / <span id="exp-need">20</span></span>
          </div>
          <div class="lvl-bar"><div id="lvl-fill" class="lvl-fill"></div></div>
        </div>

        <div class="todo-section">
      <h4>ë¹ˆì¹¸(ì•„ë˜ ì—¬ë°±) ì¶”ì²œ ë°›ì•„ìš”</h4>
    </div>
      </div>
    </div>
  </div>
</div>

            <div class="card">
  <div class="card-body">
    <div class="section-head">
      <h3>ğŸ“„ ì¼ì •</h3>
    </div>

    <!-- ìƒë‹¨ íˆ´ë°”: ì›” ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="sched-toolbar">
      <button id="sched-prev" class="mini-btn">âª</button>
      <div id="sched-month-label" class="sched-month"></div>
      <button id="sched-next" class="mini-btn">â©</button>
    </div>

    <!-- ìš”ì¼ í—¤ë” -->
    <div class="sched-week-row">
      <span>ì¼</span><span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span>í† </span>
    </div>

    <!-- ë‹¬ë ¥ ê·¸ë¦¬ë“œ(ì—¬ê¸°ì— JSë¡œ ì…€ ì±„ì›€) -->
    <div id="sched-grid" class="sched-grid"></div>

    <!-- (ì„ íƒ) ë‚ ì§œ í´ë¦­ ìƒì„¸ -->
    <div class="sched-detail">
      <h4 id="sched-detail-title">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</h4>
      <ul id="sched-detail-list"></ul>
    </div>
  </div>
</div>


            <div class="card">
                <div class="card-body">
                  <div class="section-head" style="display:flex;align-items:center;justify-content:space-between;">
                    <h3>ğŸ•’ ì‹œê°„í‘œ <span id="badge-day" class="badge" style="margin-left:6px;"></span></h3>
                    <div class="controls" style="display:flex;gap:8px;align-items:center;">
                      <input type="date" id="datePicker" />
                      <select id="classSelect" style="display:none"></select>
                    </div>
                  </div>

                  <ul id="timetable" style="list-style:none;margin:12px 0 0;padding:0;"></ul>
                  <div id="notice" style="display:none;color:#6c757d;padding:12px 0;"></div>
                </div>
            </div>

            <div class="card" id="rank-card">
                <div class="card-body">
                  <div class="section-head" style="display:flex;align-items:center;justify-content:space-between;">
                    <h3>ğŸ† ë­í‚¹</h3>
                    <div style="display:flex;gap:6px;align-items:center;">
                      <!-- ì •ë ¬ ê¸°ì¤€ -->
                      <select id="rank-metric" style="border:1px solid #e9ecef;border-radius:10px;padding:6px 8px;">
                        <option value="coin">ì½”ì¸</option>
                        <option value="level">ë ˆë²¨</option>
                      </select>
                      <!-- ë²”ìœ„ (í•™ìƒì€ ìë™ ê³ ì •) -->
                      <select id="rank-scope" style="border:1px solid #e9ecef;border-radius:10px;padding:6px 8px;">
                        <option value="class">ê°™ì€ ë°˜</option>
                        <!-- <option value="grade">ê°™ì€ í•™ë…„</option>
                        <option value="school">ì „êµ</option> -->
                      </select>
                      <button class="mini-btn" id="rank-refresh">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                  </div>

                  <ul id="rank-list" style="list-style:none;margin:10px 0 0;padding:0;"></ul>
                  <div id="rank-me" style="margin-top:12px;padding:10px;border:1px dashed #e9ecef;border-radius:10px;background:#fafafa;display:none"></div>
                </div>
            </div>

            <div class="card">
              <div class="card-body">
                <div class="section-head">
                  <h3>ğŸ½ï¸ ê¸‰ì‹</h3>
                </div>
                <div id="meal-box"></div>
              </div>
            </div>


            </div>
        </div>


      <div id="notice-panel" class="panel" style="display:none;">
        <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
          <div id="notice-list"></div>
            <h3>ìƒˆ ê³µì§€ ë“±ë¡</h3>
            <input type="text" id="notice-title" placeholder="ì œëª©"/>
            <textarea id="notice-content" placeholder="ë‚´ìš©"></textarea>
            
            <!-- ì‚¬ì§„ íŒŒì¼ ì„ íƒ -->
            <input type="file" id="notice-image" accept="image/*">

            <!-- ì‚¬ì§„ ì—…ë¡œë“œ ì—¬ë¶€ ì„ íƒ -->
            <label style="display:flex;align-items:center;margin-top:0.5rem;">
              <input type="checkbox" id="notice-upload-check" style="margin-right:0.5rem;">
              ì´ ì‚¬ì§„ì„ ê³µì§€ì— í¬í•¨í•˜ê¸°
            </label>

            <button onclick="addNotice()">ê³µì§€ ì¶”ê°€</button>
      </div>      

      <div id="doc-panel" class="panel">
        <h2>ğŸ“„ ìˆ˜í–‰ í‰ê°€ ì—…ë¡œë“œ</h2>
        <input type="file" id="doc-file" accept=".pdf,.jpg,.png"/>
        <div class="button-group">
          <button onclick="analyzeDocument()">ë¬¸ì„œ ë¶„ì„í•˜ê¸°</button>
        </div>

        <h3>ë¶„ì„ ê²°ê³¼ (ìˆ˜ì • ê°€ëŠ¥)</h3>
          <textarea 
            id="doc-result"
            placeholder="ë¶„ì„ëœ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. í•„ìš”í•˜ë©´ ìˆ˜ì • í›„ ë“±ë¡í•˜ì„¸ìš”."
            style="
              min-height:100px;
              resize:none;
              overflow:hidden;
              width:100%;
              padding:0.8rem;
              font-size:0.95rem;
              line-height:1.4rem;
              border:1px solid #ced4da;
              border-radius:0.5rem;
              background:#fdfdfd;
              box-shadow:inset 0 1px 2px rgba(0,0,0,0.04);
            ">
          </textarea>
          
          <!-- ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° -->
          <img id="doc-preview" style="max-width:100%; margin-top:1rem; display:none; border-radius:0.5rem;" />

          <!-- ì—…ë¡œë“œ ì—¬ë¶€ ì„ íƒ -->
          <label style="display:flex;align-items:center;margin-top:0.5rem;">
            <input type="checkbox" id="upload-image-check" style="margin-right:0.5rem;">
            ì´ ì‚¬ì§„ì„ ê³µì§€ì— ê°™ì´ ì˜¬ë¦¬ê¸°
          </label>

          <div class="button-group">
            <button onclick="registerAnalyzedText()">ë¶„ì„ëœ ê¸€ ë“±ë¡í•˜ê¸°</button>
          </div>
      </div>      

      <div id="student-panel" class="panel" style="display:none;">
        <h2>ğŸ‘©â€ğŸ“ í•™ìƒ ê´€ë¦¬</h2>
        <button onclick="loadStudents()">í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <ul id="student-list"></ul>
      </div>

      <div id="homework-panel" class="panel" style="display:none;">
        <h2>ğŸ“š íŒŒì¼ ê³µìœ  & ìë£Œì‹¤</h2>

        <!-- ì—…ë¡œë“œ ì˜ì—­ -->
        <label for="homework-scope">ê³µìœ  ë²”ìœ„</label>
        <select id="homework-scope">
          <option value="school">ì „êµ</option>
          <option value="grade">ê°™ì€ í•™ë…„( ì¶”ê°€ ì˜ˆì • )</option>
          <option value="class">ê°™ì€ ë°˜( ì¶”ê°€ ì˜ˆì • )</option>
        </select>

        <label for="homework-userinfo">í•™ë²ˆ + ì´ë¦„</label>
        <input type="text" id="homework-userinfo" readonly style="background:#f1f3f5; font-weight:bold; margin-bottom:0.8rem;">

        <label for="homework-title">ì œëª©</label>
        <input type="text" id="homework-title" placeholder="ì˜ˆ: ì²´í—˜í•™ìŠµ ì‚¬ì§„">

        <label for="homework-file">íŒŒì¼ ì—…ë¡œë“œ</label>
        <input type="file" id="homework-file" multiple>

        <label for="homework-comment">ì½”ë©˜íŠ¸ (ì„ íƒ)</label>
        <textarea id="homework-comment" placeholder="ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”"></textarea>

        <button onclick="submitHomework()">ì—…ë¡œë“œí•˜ê¸°</button>
        <div id="homework-status" style="margin-top:0.5rem;font-size:0.9rem;color:#007bff;"></div>

        <hr style="margin:1.5rem 0;">

        <!-- ìë£Œ ëª©ë¡ ì˜ì—­ -->
        <h3>ğŸ“‚ ì—…ë¡œë“œëœ ìë£Œ</h3>
        <button onclick="loadMaterials()">ğŸ”„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        <ul id="material-list" style="margin-top:1rem;"></ul>
      </div>

      <div id="chat-panel" class="panel" style="display:none;">
        <h2>ğŸ’¬ ìƒë‹´ì‹¤</h2>
        <div id="chat-box" style="border:1px solid #ccc; height:200px; overflow-y:auto; padding:0.5rem; margin-bottom:0.5rem;"></div>
        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
        <button onclick="sendChat()">ë³´ë‚´ê¸°</button>
      </div>

      <div id="profile-panel" class="panel" style="display:none;">
        <h2>ë‚´ ì •ë³´ ìˆ˜ì •</h2>
        <input type="text" id="update-name" placeholder="ì´ë¦„ ìˆ˜ì •">
        <input type="password" id="update-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •">
        <button onclick="updateProfile()">ìˆ˜ì •í•˜ê¸°</button>
        <button onclick="showPanel('doc-panel')">â† ëŒì•„ê°€ê¸°</button>
      </div>

      <div id="admin-panel" class="panel" style="display:none;">
        <h2>âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h2>
        <input type="text" id="admin-user-id" placeholder="ì‚¬ìš©ì ID"/>
        <select id="admin-role">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
        <button onclick="changeRole()">ê¶Œí•œ ë³€ê²½</button>
        <button onclick="deleteUser()">ì‚¬ìš©ì ì‚­ì œ</button>
        <div id="admin-status" style="margin-top:0.5rem;"></div>
      </div>

        <!-- ì‹œê°„í‘œ íŒ¨ë„ -->
      <div id="timetable-panel" class="panel" style="display:none;">
        <h2>ğŸ—“ï¸ ë‚˜ì˜ ì‹œê°„í‘œ</h2>
        <p style="margin-bottom:1rem; color:#495057; font-size:0.95rem;">
          ë´‰ë‹´ì¤‘í•™êµ / ë¡œê·¸ì¸í•œ í•™ë…„Â·ë°˜ ê¸°ì¤€ ì‹œê°„í‘œë¥¼ ì•„ë˜ì—ì„œ í™•ì¸í•˜ì„¸ìš”.
        </p>

        <!-- ìƒë‹¨ ì •ë³´ ì˜ì—­ -->
        <div id="timetable-info" style="
              display:flex;
              justify-content:space-between;
              align-items:center;
              background:#f1f3f5;
              padding:0.75rem 1rem;
              border-radius:0.5rem;
              margin-bottom:1rem;
              font-size:0.9rem;
              color:#333;">

          <span id="timetable-grade-info">í•™ë…„/ë°˜ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>

          <div class="week-nav">
            <button class="nav-btn" onclick="moveTimetable(-1)">âª ì´ì „</button>
            <button class="nav-btn" onclick="moveTimetable(0)">ìƒˆë¡œê³ ì¹¨</button>
            <button class="nav-btn" onclick="moveTimetable(1)">â© ë‹¤ìŒ</button>
          </div>
        </div>
        <div id="timetable-container"
            style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;">
        </div>
      </div>

        
      <div id="minigame-panel" class="panel" style="display:none;">
        <h2>ğŸ® ë¯¸ë‹ˆê²Œì„</h2>
        <!-- 4=10 ê²Œì„ -->
          <div style="border:1px solid #ddd;padding:1rem;border-radius:0.75rem;">
            <h3>ğŸ§® 4 = 10 í¼ì¦</h3>
            <p>ìˆ«ì 4ê°œë¡œ ì—°ì‚°í•˜ì—¬ 10ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”<br><strong>ğŸ’° 5ì½”ì¸ í•„ìš”</strong></p>
            <button onclick="startGame('fourEqualsTen')">ê²Œì„ ì‹œì‘</button>
          </div>
      </div>

      <div id="fourEqualsTen-game" class="panel" style="display:none;">
        <h2>ğŸ§® 4 = 10 ê²Œì„</h2>
        <p>ì•„ë˜ ìˆ«ìë¥¼ ì‚¬ìš©í•´ ì‚¬ì¹™ì—°ì‚°ìœ¼ë¡œ 10ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
        <div id="game-numbers" style="font-size:1.5rem; margin-bottom:0.5rem;"></div>
        <input id="game-input" placeholder="ì˜ˆ: (1+3)Ã—2+4" style="width:100%;padding:0.5rem;">
        <button onclick="checkFourEqualsTen()">ì œì¶œ</button>
        <p id="game-feedback" style="margin-top:0.5rem;font-weight:bold;"></p>
        <button onclick="exitMiniGame()">âŒ ë‚˜ê°€ê¸°</button>
      </div>

    </div>
          </div>

    <!-- âœ… ëª¨ë°”ì¼ ì‚¬ì´ë“œ ë©”ë‰´ -->
    <div id="mobile-side-menu" class="mobile-only mobile-side-menu">
      <ul class="menu-section">
        <li><a href="#" onclick="showPanel('dashboard');closeMobileMenu()">ğŸ ëŒ€ì‹œë³´ë“œ</a></li>
        <li><a href="#" onclick="showPanel('notice-panel'); closeMobileMenu()">ğŸ“¢ ê³µì§€ì‚¬í•­</a></li>
        <li><a href="#" onclick="showPanel('doc-panel'); closeMobileMenu()">ğŸ“„ ë¬¸ì„œ ë¶„ì„</a></li>
        <li><a href="#" onclick="showPanel('homework-panel'); closeMobileMenu()">ğŸ“ ìë£Œì‹¤</a></li>
        <li><a href="#" onclick="showPanel('timetable-panel'); closeMobileMenu()">ğŸ•’ ì‹œê°„í‘œ</a></li>
        <li><a href="#" onclick="showPanel('minigame-panel'); closeMobileMenu()">ğŸ® ë¯¸ë‹ˆê²Œì„</a></li>
      </ul>
      <hr>
      <ul class="user-section">
        <li><a href="#" id="menu-profile">ğŸ™â€â™‚ï¸ ë‚´ ì •ë³´</a></li>
        <li><a href="#" id="menu-password">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a></li>
        <li><a href="#" id="menu-setting">âš™ï¸ ì„¤ì •</a></li>
        <li><a href="#" id="menu-logout">ğŸšª ë¡œê·¸ì•„ì›ƒ</a></li>
      </ul>
    </div>  

    <!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
    <div id="imageModal" class="modal" style="
      display:none;
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.8);
      justify-content:center;
      align-items:center;
      z-index:5000;
      flex-direction:column;
    ">
      <span onclick="closeImageModal()" style="color:white;font-size:2rem;position:absolute;top:20px;right:30px;cursor:pointer;">&times;</span>
      <img id="modalImage" src="" style="max-width:90%; max-height:80%; border-radius:8px;" />
    </div>

    <script>
      const { createClient } = supabase;
      const supabaseClient = createClient(
        'https://ucmzrkwrsezfdjnnwsww.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjbXpya3dyc2V6ZmRqbm53c3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NDIzODcsImV4cCI6MjA2ODQxODM4N30.rvLItmDStjWb3GfECnCXocHvj-CMTfHfD1CHsAHOLaw'
      );

      const CLOVER_API = 'https://YOUR_DOMAIN/functions/v1/ocr-classify'; 
      const USE_TESSERACT_FALLBACK = true;

      
      const NEIS_KEY = '28ca0f05af184e8ba231d5a949d52db2';
      const ATPT_OFCDC_SC_CODE = 'J10';
      const SD_SCHUL_CODE = '7679111';


      let currentUserRole = 'user';
      let currentUserName = '';
      let currentStudentNumber = '';
      let currentGrade = null;
      let currentClassNum = null;
      let timetableOffset = 0;

      async function loginDirect() {
        const username = document.getElementById('loginUsername').value.replace(/\s+/g, '');
        const password = document.getElementById('loginPassword').value.replace(/\s+/g, '');
        const { data: user } = await supabaseClient
          .from('users')
          .select('*')
          .eq('username', username)
          .eq('password', password)
          .single();

        if (user) {
          currentUserName = user.name;
          currentStudentNumber = user.student_number;

          localStorage.setItem('savedUsername', username);
          localStorage.setItem('savedName', currentUserName);
          localStorage.setItem('savedStudentNum', currentStudentNumber);
          localStorage.setItem('savedGrade', user.grade);
          localStorage.setItem('savedClassNum', user.class_num);



          // í™”ë©´ì— í‘œì‹œ
          setUserInfoInput();

          currentUserRole = user.role || 'user';
          currentGrade = user.grade;
          currentClassNum = user.class_num;

          loadTimetableWeek(user.grade, user.class_num);
          showMain();
          loadNotices();
          afterLoginRefreshDashboard();
        } else {
          document.getElementById('loginStatus').innerText = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
        }
      }

      // ìƒˆë¡œê³ ì¹¨ ì‹œ ì €ì¥ëœ ì´ë¦„/í•™ë²ˆ ë¶ˆëŸ¬ì˜¤ê¸°
      window.addEventListener('DOMContentLoaded', () => {
        const savedName = localStorage.getItem('savedName');
        const savedNum = localStorage.getItem('savedStudentNum');
        if (savedName && savedNum) {
          currentUserName = savedName;
          currentStudentNumber = savedNum;
          setUserInfoInput();
        }
      });

      function setUserInfoInput() {
        const inputEl = document.getElementById('homework-userinfo');
        if (inputEl) {
          inputEl.value = `${currentStudentNumber}ë²ˆ ${currentUserName}`;
        }
      }
      
      async function signup() {
        const username = document.getElementById('signupUsername').value.trim();
        const password = document.getElementById('signupPassword').value.trim();
        const emailId = document.getElementById('signupEmailId').value.trim();
        const domainValue = document.getElementById('signupEmailDomain').value;
        const customDomain = document.getElementById('signupEmailCustom').value.trim();
        const email = `${emailId}@${domainValue === 'ì§ì ‘ì…ë ¥' ? customDomain : domainValue}`;
        const name = document.getElementById('signupName').value.trim();
        const grade = document.getElementById('signupGrade').value.trim();
        const classNum = document.getElementById('signupClass').value.trim();
        const number = document.getElementById('signupNumber').value.trim();
        const agree = document.getElementById('privacy-agree').checked;

        if (!agree) {
          document.getElementById('signupStatus').innerText = 'ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•´ ì£¼ì„¸ìš”.';
          return;
        }
        if (!username || !password || !email || !name || !grade || !classNum || !number) {
          document.getElementById('signupStatus').innerText = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
          return;
        }
        if (password.length < 6) {
          document.getElementById('signupStatus').innerText = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
          return;
        }

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          document.getElementById('signupStatus').innerText = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
          return;
        }

        try {
          const { error } = await supabaseClient.from('users').insert([{
            username: username,
            password: password,
            email: email,
            name: name,
            grade: parseInt(grade, 10),
            class_num: parseInt(classNum, 10),
            student_number: parseInt(number, 10),
            role: 'user'
          }]);
          if (error) {
            document.getElementById('signupStatus').innerText = 'íšŒì›ê°€ì… ì‹¤íŒ¨: ' + error.message;
            return;
          }
          alert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
          document.getElementById('signupStatus').style.color = 'green';
          document.getElementById('signupStatus').innerText = 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.';
        } catch (e) {
          document.getElementById('signupStatus').innerText = 'ì˜¤ë¥˜ ë°œìƒ: ' + e.message;
        }
      }

      function showMain() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        setupAdminNav();
        showPanel('dashboard');
      }

      function showSignup() {
        document.getElementById('login-box').style.display = 'none';
        document.getElementById('signup-box').style.display = 'block';
      }

      function showLogin() {
        document.getElementById('login-box').style.display = 'block';
        document.getElementById('signup-box').style.display = 'none';
      }

      async function logout() {
        await supabaseClient.auth.signOut();
        localStorage.removeItem('savedUsername'); // âœ… ë¡œê·¸ì•„ì›ƒ ì‹œ ì €ì¥ëœ ì•„ì´ë”” ì‚­ì œ
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
      }

      async function updateProfile() {
        const newName = document.getElementById('update-name').value;
        const newPass = document.getElementById('update-password').value;

        if (newPass) {
          const { error } = await supabaseClient.auth.updateUser({ password: newPass });
          if (error) alert('ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • ì˜¤ë¥˜:' + error.message);
          else alert('ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • ì™„ë£Œ!');
        }
        if (newName) {
          const user = await supabaseClient.auth.getUser();
          if (user && user.data.user) {
            await supabaseClient.from('users').update({ name: newName }).eq('id', user.data.user.id);
            alert('ì´ë¦„ ìˆ˜ì • ì™„ë£Œ!');
          }
        }
      }

    function showPanel(panelId) {
      document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
      const target = document.getElementById(panelId);
      if (target) {
        target.style.display = 'block';
      }
    }

    supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
      if (session) {
        const { data: user } = await supabaseClient
          .from('users')
          .select('role')
          .eq('id', session.user.id)
          .single();
        if (user) currentUserRole = user.role;
      } else {
        showLogin();
      }
    });

    function setupAdminNav() {
      if (currentUserRole === 'admin') {
        if (!document.getElementById('admin-nav')) {
          const nav = document.getElementById('main-nav');
          const a = document.createElement('a');
          a.href = '#';
          a.id = 'admin-nav';
          a.innerText = 'ê´€ë¦¬ì ì„¤ì •';
          a.onclick = () => { showPanel('admin-panel'); };
          nav.appendChild(a);
        }
      }
    }

    async function addNotice() {
      const title = document.getElementById('notice-title').value.trim();
      const content = document.getElementById('notice-content').value.trim();
      const fileInput = document.getElementById('notice-image');
      const uploadChecked = document.getElementById('notice-upload-check').checked;

      if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      let imageUrl = '';

      if (uploadChecked && fileInput.files.length) {
        const file = fileInput.files[0];
        const uniqueName = Date.now() + '_' + file.name;
        const filePath = `public/${uniqueName}`;

        const { error: uploadErr } = await supabaseClient
          .storage
          .from('notice-images')
          .upload(filePath, file, { upsert: true });

        if (uploadErr) {
          alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadErr.message);
          return;
        }

        const { data: publicData } = supabaseClient
          .storage
          .from('notice-images')
          .getPublicUrl(filePath);

        imageUrl = publicData.publicUrl;
      }

      // âœ… í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const { data: writerData, error: writerError } = await supabaseClient
        .from('users')
        .select('username,name,role,grade,class_num')
        .eq('username', localStorage.getItem('savedUsername'))
        .single();

      if (writerError || !writerData) {
        alert('ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      // âœ… í…Œì´ë¸”ì— ë“±ë¡í•  ë°ì´í„°
      const newNotice = {
        title: title,
        content: content,
        image_url: imageUrl,
        writer: writerData.name,        // ì‘ì„±ì ì´ë¦„
        writer_role: writerData.role,   // ì‘ì„±ì ì—­í• 
        grade: writerData.grade,        // ì‘ì„±ì í•™ë…„
        class_num: writerData.class_num // ì‘ì„±ì ë°˜
      };

      const { error } = await supabaseClient.from('notices').insert([ newNotice ]);
        if (error) {
          alert('ê³µì§€ ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
          return;
        }

        alert('ê³µì§€ ë“±ë¡ ì™„ë£Œ!');
        document.getElementById('notice-title').value = '';
        document.getElementById('notice-content').value = '';
        document.getElementById('notice-image').value = '';
        document.getElementById('notice-upload-check').checked = false;

        loadNotices();
      }

    async function loadNotices() {
      let query = supabaseClient.from('notices').select('*').order('id', { ascending: false });

      if (currentUserRole !== 'admin') {
        // âœ… í•™ìƒì´ë¼ë©´ ê°™ì€ í•™ë…„/ë°˜ & ì–´ë“œë¯¼ì´ ì˜¬ë¦° ê¸€ ì œì™¸
        query = query
          .eq('grade', currentGrade)
          .eq('class_num', currentClassNum)
          .neq('writer_role', 'admin');
      }
      // âœ… adminì´ë©´ ëª¨ë“  ê³µì§€ë¥¼ ê·¸ëŒ€ë¡œ ë¶ˆëŸ¬ì˜´

      const { data, error } = await query;

      if (error) {
        console.error('ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        return;
      }

      const listEl = document.getElementById('notice-list');
      listEl.innerHTML = '';

      data.forEach(item => {
        const formattedContent = item.content.replace(/\n/g, '<br>');
        const div = document.createElement('div');
        div.style.borderBottom = '1px solid #ddd';
        div.style.padding = '0.5rem 0';
        // ëˆ„ê°€ ì˜¬ë¦° ê¸€ì¸ì§€ í‘œì‹œ
        div.innerHTML = `<strong>${item.title}</strong> <span style="font-size:0.8rem;color:#888;">(${item.writer})</span><br>${formattedContent}`;

        if (item.image_url) {
          div.innerHTML += `<br><img src="${item.image_url}" style="max-width:100%;margin-top:0.5rem;border-radius:0.5rem;">`;
        }

        listEl.appendChild(div);
      });
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const dataUrl = fr.result; // "data:...;base64,AAAA..."
          const base64 = String(dataUrl).split(',')[1] || '';
          resolve(base64);
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    async function analyzeDocument() {
      const fileInput = document.getElementById('doc-file');
      const previewEl = document.getElementById('doc-preview');
      const resultEl = document.getElementById('doc-result');

      if (!fileInput.files.length) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }

      const file = fileInput.files[0];
      lastAnalyzedFile = file; // ë¶„ì„í•œ íŒŒì¼ ì €ì¥ (ê³µì§€ ë“±ë¡ ì‹œ ì´ë¯¸ì§€ ì—…ë¡œë“œìš©)

      // ë¯¸ë¦¬ë³´ê¸°
      previewEl.src = URL.createObjectURL(file);
      previewEl.style.display = 'block';

      resultEl.value = 'ğŸ“„ ë¬¸ì„œ ë¶„ì„ ì¤‘... (CLOVA + Auto Classify)';
      autoResize();

      try {
        // 1) íŒŒì¼ì„ Base64ë¡œ ë³€í™˜í•˜ì—¬ ì„œë²„ë¡œ ì „ì†¡
        const fileBase64 = await fileToBase64(file);

        const res = await fetch(CLOVER_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fileBase64 })
        });

        if (!res.ok) throw new Error(`CLOVA ì„œë²„ ì˜¤ë¥˜ (${res.status})`);

        // 2) ì„œë²„ ì‘ë‹µ(JSON) íŒŒì‹±
        //    ì„œë²„ì—ì„œ ì•„ë˜ í‚¤ë¥¼ ë‚´ë ¤ì£¼ë„ë¡ êµ¬í˜„:
        //    { subject, date, time, topic, materials, raw }
        const json = await res.json();

        const subject   = json.subject   || '';
        const date      = json.date      || '';
        const time      = json.time      || '';
        const topic     = json.topic     || '';
        const materials = json.materials || '';
        const raw       = json.raw       || '';

        // 3) ê°„ê²° í¬ë§·ìœ¼ë¡œ ìë™ ì±„ìš°ê¸° (ìˆ˜ì • ê°€ëŠ¥)
        const pretty = [
          `[ê³¼ëª©] ${subject}`,
          `[í‰ê°€ ë‚ ì§œ] ${date}`,
          `[í‰ê°€ ì‹œê°„] ${time}`,
          `[í‰ê°€ ì£¼ì œ] ${topic}`,
          `[ì¤€ë¹„ë¬¼] ${materials}`,
          `--------------------------------`,
        ];

        resultEl.value = pretty.trim();
        autoResize();

        alert('âœ… CLOVA ë¶„ì„ ì™„ë£Œ! í•„ìš”í•œ í•­ëª©ì€ ììœ ë¡­ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.');

      } catch (err) {
        console.error('CLOVA ë¶„ì„ ì‹¤íŒ¨:', err);
        if (!USE_TESSERACT_FALLBACK) {
          resultEl.value = `ë¬¸ì„œ ë¶„ì„ ì‹¤íŒ¨: ${err.message}`;
          autoResize();
          return;
        }

        // ğŸ” ë°±ì—…: Tesseractë¡œ ì›ë¬¸ì´ë¼ë„ ë½‘ì•„ í‘œì‹œ
        resultEl.value = 'âš ï¸ CLOVA ì‹¤íŒ¨ â†’ Tesseractë¡œ ë°±ì—… ì¸ì‹ ì¤‘...';
        autoResize();

        try {
          const reader = new FileReader();
          reader.onload = () => {
            Tesseract.recognize(reader.result, 'kor', { logger: m => console.log(m) })
              .then(({ data: { text } }) => {
                resultEl.value = [
                  `[ê³¼ëª©] `,
                  `[í‰ê°€ ë‚ ì§œ] `,
                  `[í‰ê°€ ì‹œê°„] `,
                  `[í‰ê°€ ì£¼ì œ] `,
                  `[ì¤€ë¹„ë¬¼] `
                ].join('\n').trim();
                autoResize();
                alert('âš ï¸ CLOVA ì‹¤íŒ¨. Tesseract ê²°ê³¼ë¥¼ í‘œì‹œí–ˆì–´ìš”. í•­ëª©ì„ ì§ì ‘ ë³´ì™„í•´ ì£¼ì„¸ìš”.');
              })
              .catch(fallbackErr => {
                console.error('Tesseract ì˜¤ë¥˜:', fallbackErr);
                resultEl.value = `ë¬¸ì„œ ë¶„ì„ ì‹¤íŒ¨(ë°±ì—…ë„ ì‹¤íŒ¨): ${fallbackErr.message}`;
                autoResize();
              });
          };
          reader.readAsDataURL(file);
        } catch (fallbackWrapErr) {
          console.error('ë°±ì—… ì²˜ë¦¬ ì˜¤ë¥˜:', fallbackWrapErr);
          resultEl.value = `ë¬¸ì„œ ë¶„ì„ ì‹¤íŒ¨: ${fallbackWrapErr.message}`;
          autoResize();
        }
      }
    }

    async function registerAnalyzedText() {
      const text = document.getElementById('doc-result').value.trim();
      if (!text) {
        alert('ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
        return;
      }

      let imageUrl = '';
      const shouldUploadImage = document.getElementById('upload-image-check').checked;

      if (shouldUploadImage && lastAnalyzedFile) {
        const fileName = Date.now() + '_' + lastAnalyzedFile.name;
        const { error: uploadErr } = await supabaseClient
          .storage
          .from('notice-images')
          .upload(fileName, lastAnalyzedFile);

        if (uploadErr) {
          alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadErr.message);
          return;
        }
        const { data: publicData } = supabaseClient
          .storage
          .from('notice-images')
          .getPublicUrl(fileName);
        imageUrl = publicData.publicUrl;
      }

      // âœ… í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const { data: writerData, error: writerError } = await supabaseClient
        .from('users')
        .select('username,name,role,grade,class_num')
        .eq('username', localStorage.getItem('savedUsername'))
        .single();

      if (writerError || !writerData) {
        alert('ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      // âœ… DBì— ê³µì§€ ë“±ë¡ (ë¬¸ì„œ ë¶„ì„ ê²°ê³¼)
      const { error } = await supabaseClient.from('notices').insert([{
        title: 'ã…‡ã…‡ ìˆ˜í–‰',
        content: text,
        image_url: imageUrl,
        writer: writerData.name,
        writer_role: writerData.role,
        grade: writerData.grade,
        class_num: writerData.class_num
      }]);

      if (error) {
        alert('ê³µì§€ ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
        return;
      }

      alert('ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      loadNotices();

      // ì´ˆê¸°í™”
      lastAnalyzedFile = null;
      document.getElementById('doc-file').value = '';
      document.getElementById('doc-preview').style.display = 'none';
      document.getElementById('upload-image-check').checked = false;
      document.getElementById('doc-result').value = '';
    }

    const docResult = document.getElementById('doc-result');

    function autoResize() {
      docResult.style.height = 'auto';  // ì´ˆê¸°í™”
      docResult.style.height = docResult.scrollHeight + 'px'; // ë‚´ìš©ì— ë§ê²Œ ëŠ˜ë¦¼
    }

    docResult.addEventListener('input', autoResize);

    async function loadTimetableWeek(grade, classNum) {
      currentGrade = grade;
      currentClassNum = classNum;
            

      document.getElementById('timetable-grade-info').innerText = `${grade}í•™ë…„ ${classNum}ë°˜ (ì£¼ê°„)`;
      const container = document.getElementById('timetable-container');
      container.innerHTML = '<p>ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

      const today = new Date();
      const day = today.getDay();
      const monday = new Date(today);
      monday.setDate(today.getDate() - (day === 0 ? 6 : day - 1) + timetableOffset * 7);

      const year = today.getFullYear();
      const month = today.getMonth() + 1;
      const semester = (month <= 8) ? 1 : 2;

      const dates = Array.from({ length: 5 }, (_, i) => {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        return `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
      });

      try {
        const results = await Promise.all(
          dates.map(async (dateStr) => {
            const url = `https://open.neis.go.kr/hub/misTimetable?KEY=${NEIS_KEY}&Type=json&ATPT_OFCDC_SC_CODE=${ATPT_OFCDC_SC_CODE}&SD_SCHUL_CODE=${SD_SCHUL_CODE}&AY=${year}&SEM=${semester}&ALL_TI_YMD=${dateStr}&GRADE=${grade}&CLASS_NM=${classNum}`;
            console.log(url);
            const res = await fetch(url);
            const data = await res.json();
            return { dateStr, data };
          })
        );

              container.innerHTML = '';

              for (const { dateStr, data } of results) {
                const dayBox = document.createElement('div');
                dayBox.style.border = '1px solid #ccc';
                dayBox.style.borderRadius = '8px';
                dayBox.style.padding = '8px';
                dayBox.style.background = '#fdfdfd';
                dayBox.style.marginBottom = '10px';

                const title = document.createElement('h4');
                const dateObj = new Date(
                  dateStr.slice(0, 4), // ì—°ë„
                  parseInt(dateStr.slice(4, 6)) - 1, // ì›” (0ë¶€í„° ì‹œì‘)
                  dateStr.slice(6, 8) // ì¼
                );

                // ìš”ì¼ ë°°ì—´
                const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                const dayName = days[dateObj.getDay()];

                title.innerText = `${dateStr.slice(0, 4)}-${dateStr.slice(4, 6)}-${dateStr.slice(6, 8)} (${dayName})`;

                dayBox.appendChild(title);

                if (data.misTimetable && data.misTimetable[1]) {
                  const rows = data.misTimetable[1].row;
                  const unique = {};
                  rows.forEach(row => {
                    const key = row.PERIO;
                    if (!unique[key]) {
                      unique[key] = row.ITRT_CNTNT;
                    }
                  });

                  // PERIO ìˆœì„œëŒ€ë¡œ ì •ë ¬í•´ì„œ ì¶œë ¥
                  Object.keys(unique).sort((a, b) => parseInt(a) - parseInt(b)).forEach(perio => {
                    const item = document.createElement('div');
                    item.innerHTML = `<strong>${perio}êµì‹œ</strong> : ${unique[perio]}`;
                    dayBox.appendChild(item);
                  });

                } else {
                  const none = document.createElement('p');
                  none.innerText = 'êµìœ¡ì²­ ì‹œê°„í‘œ ë°ì´í„° ì—†ìŒ';
                  dayBox.appendChild(none);
                }

                container.appendChild(dayBox);
              }
            } catch (err) {
              console.error('ì£¼ê°„ ì‹œê°„í‘œ ì˜¤ë¥˜:', err);
              container.innerHTML = '<p>ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }

          }

    function moveTimetable(offset) {
      timetableOffset += offset;
      loadTimetableWeek(currentGrade, currentClassNum, timetableOffset);
    }

    window.addEventListener('DOMContentLoaded', async () => {
  const savedUsername = localStorage.getItem('savedUsername');
  if (!savedUsername) { showLogin(); return; }

  const { data: user, error } = await supabaseClient
    .from('users')
    .select('*')
    .eq('username', savedUsername)
    .maybeSingle();

  if (error || !user) { showLogin(); return; }

  // âœ… ìƒíƒœê°’ ì±„ìš°ê¸°
  currentUserRole = user.role || 'user';
  currentGrade = user.grade;
  currentClassNum = user.class_num;
  currentUserName = user.name;
  currentStudentNumber = user.student_number;

  // âœ… ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥ (ëŒ€ì‹œë³´ë“œ fallbackì´ ì´ ê°’ì„ ì”ë‹ˆë‹¤)
  localStorage.setItem('savedName', user.name);
  localStorage.setItem('savedStudentNum', user.student_number);
  localStorage.setItem('savedGrade', user.grade);
  localStorage.setItem('savedClassNum', user.class_num);

  // âœ… í—¤ë”/ëª¨ë°”ì¼ ì´ë¦„ ë¼ë²¨ ë“± ì¦‰ì‹œ ë°˜ì˜
  setUserInfoInput();

  // âœ… ë©”ì¸ í™”ë©´ ì—´ê¸° + ë°ì´í„° ë¡œë“œ
  await loadTimetableWeek(user.grade, user.class_num);
  await loadCoinBalance();
  showMain();
  loadNotices();

  // âœ… ëŒ€ì‹œë³´ë“œ ë¼ë²¨/ê²½í—˜ì¹˜/í¬ì¸íŠ¸ ìƒˆë¡œ ê·¸ë¦¬ê¸°
  afterLoginRefreshDashboard();
});


    function setupAdminNav() {
      const existing = document.getElementById('admin-nav');

      if (currentUserRole === 'admin') {
        if (!existing) {
          const nav = document.getElementById('main-nav');
          const a = document.createElement('a');
          a.href = '#';
          a.id = 'admin-nav';
          a.innerText = 'ê´€ë¦¬ì ì„¤ì •';
          a.onclick = () => { showPanel('admin-panel'); };
          nav.appendChild(a);
        }
      } else {
        if (existing) existing.remove();
      }
    }

    document.querySelectorAll('#main-nav a').forEach(link => {
      link.addEventListener('click', () => {
        const menuToggle = document.getElementById('menu-toggle');
        if (menuToggle) {
          menuToggle.checked = false;
        }
      });
    });

    async function submitHomework() {
      const name = currentUserName;
      const studentNum = currentStudentNumber;
      const grade = currentGrade;
      const classNum = currentClassNum;
      const scope = document.getElementById('homework-scope').value;
      const title = document.getElementById('homework-title').value.trim();
      const comment = document.getElementById('homework-comment').value.trim();
      const fileInput = document.getElementById('homework-file');
      const statusEl = document.getElementById('homework-status');

      if (!name || !studentNum || !title || fileInput.files.length === 0) {
        alert('ê³¼ì œëª…ê³¼ íŒŒì¼ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      statusEl.style.color = '#007bff';
      statusEl.textContent = 'â³ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...';

      const insertRecords = [];

      try {
        for (let i = 0; i < fileInput.files.length; i++) {
          const file = fileInput.files[i];
          const timestamp = Date.now();

          // âœ… ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„±
          const safeFileName = file.name
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^\w.-]/g, '_');

          const fileName = `${studentNum}_${timestamp}_${i}_${safeFileName}`;

          // âœ… íŒŒì¼ ì—…ë¡œë“œ
          const { error: uploadError } = await supabaseClient
            .storage
            .from('homework-files')
            .upload(fileName, file);

          if (uploadError) {
            throw new Error(`âŒ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${safeFileName} - ${uploadError.message}`);
          }

          const { data: publicURLData } = supabaseClient
            .storage
            .from('homework-files')
            .getPublicUrl(fileName);

          const fileURL = publicURLData.publicUrl;

          insertRecords.push({
            name,
            student_number: studentNum,
            title,
            grade,
            class_num: classNum,
            comment,
            file_url: fileURL,
            share_scope: scope
          });
        }

        // âœ… DBì— í•œêº¼ë²ˆì— insert
        const { error: insertError } = await supabaseClient
          .from('homeworks')
          .insert(insertRecords);

        if (insertError) {
          throw new Error(`âŒ DB ì €ì¥ ì‹¤íŒ¨: ${insertError.message}`);
        }

        statusEl.style.color = 'green';
        statusEl.textContent = `âœ… ì´ ${insertRecords.length}ê°œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!`;

        // ì…ë ¥ ì´ˆê¸°í™”
        document.getElementById('homework-title').value = '';
        document.getElementById('homework-comment').value = '';
        document.getElementById('homework-file').value = '';

        // ìë£Œ ëª©ë¡ ê°±ì‹ 
        loadMaterials();

      } catch (err) {
        console.error(err);
        statusEl.style.color = 'red';
        statusEl.textContent = err.message || 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ';
      }
    }

    async function loadMaterials() {
      const listEl = document.getElementById('material-list');
      listEl.innerHTML = '';

      const { data, error } = await supabaseClient
        .from('homeworks')
        .select('*')
        .order('uploaded_at', { ascending: false });

      if (error) {
        console.error('âŒ ìë£Œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
        listEl.innerHTML = '<li>ìë£Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>';
        return;
      }

      if (!data || data.length === 0) {
        listEl.innerHTML = '<li>ë“±ë¡ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
      }

      data.forEach(item => {
        const titleLine = `ğŸ“Œ ${item.title} (${item.grade}í•™ë…„ ${item.class_num}ë°˜ ${item.student_number}ë²ˆ ${item.name})`;
        const commentHtml = item.comment
          ? `<p style="margin:6px 0;">ğŸ’¬ ${item.comment}</p>`
          : '';

        const fileUrls = Array.isArray(item.file_url)
          ? item.file_url
          : (typeof item.file_url === 'string' && item.file_url.startsWith('['))
            ? JSON.parse(item.file_url)
            : [item.file_url];

        const fileHtmlArray = fileUrls.map(url => {
          const filename = decodeURIComponent(url.split('/').pop());
          const isImage = url.match(/\.(jpg|jpeg|png|gif|webp)$/i);

          // ì´ë¯¸ì§€ í™•ëŒ€ ê¸°ëŠ¥ í¬í•¨
          const imagePreview = isImage
            ? `<img src="${url}" alt="${filename}" 
                  onclick="openImageModal('${url}')"
                  style="max-width:120px; max-height:120px; border-radius:6px; cursor:pointer; margin-bottom:6px;" />`
            : '';

          const downloadLink = `<a href="${url}" download="${filename}" target="_blank" style="color:#007bff;text-decoration:none;font-weight:500;">
            ğŸ“¥ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          </a>`;

          return `${imagePreview}<br>${downloadLink}`;
        });

        const li = document.createElement('li');
        li.style.borderBottom = '1px solid #ddd';
        li.style.padding = '12px 0';
        li.innerHTML = `
          <div style="font-weight:bold; margin-bottom:6px;">${titleLine}</div>
          ${commentHtml}
          ${fileHtmlArray.join('<br><br>')}
        `;
        listEl.appendChild(li);
      });
    }

    function setUserInfoInput() {
      const inputEl = document.getElementById('homework-userinfo');
      const nameEl = document.getElementById('profile-name-display');
      const mobileNameEl = document.getElementById('mobile-user-name');

      if (inputEl) inputEl.value = `${currentStudentNumber}ë²ˆ ${currentUserName}`;
      if (nameEl) nameEl.textContent = currentUserName;
      if (mobileNameEl) mobileNameEl.textContent = currentUserName;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const profileButton = document.getElementById('profile-button');
      const dropdown = document.getElementById('profile-dropdown');

      if (profileButton && dropdown) {

        document.addEventListener('click', () => {
          dropdown.style.display = 'none';
        });
      }
    });


// ==== 4 = 10 ë¯¸ë‹ˆê²Œì„ ====
// í•„ìš”í•œ ì „ì—­ ìƒíƒœ
let currentFourNumbers = [];
let currentUserCoin = 0;

// ë¡œê·¸ì¸/í™”ë©´ ì§„ì… ì‹œ ì½”ì¸ ë™ê¸°í™” í•´ë‘ë©´ ì¢‹ì•„ìš”.
// (ì›ë˜ ì½”ë“œì˜ displayCoinBalance()ë¥¼ ì¬ì‚¬ìš©)
async function syncCoinBalance() {
  const username = localStorage.getItem('savedUsername');
  if (!username) return;
  const { data, error } = await supabaseClient
    .from('users')
    .select('coin_balance')
    .eq('username', username)
    .single();
  if (!error && data) {
    currentUserCoin = data.coin_balance || 0;
  }
}

// ë‚œìˆ˜ 4ê°œ(1~9) ìƒì„± + í™”ë©´ í‘œì‹œ
function generateFourNumbers() {
  currentFourNumbers = Array.from({ length: 4 }, () => Math.floor(Math.random() * 9) + 1);
  const box = document.getElementById('game-numbers');
  if (box) box.textContent = currentFourNumbers.join('  ');
  const input = document.getElementById('game-input');
  if (input) input.value = '';
  const fb = document.getElementById('game-feedback');
  if (fb) fb.textContent = '';
}

// ì‹ ê²€ì¦: í—ˆìš© ë¬¸ìë§Œ, ìˆ«ì ì‚¬ìš© ì¼ì¹˜
function isValidExpression(expr, numbers) {
  if (!expr) return false;

  // ë³´ê¸° ì¢‹ê²Œ ê¸°í˜¸ ì¹˜í™˜
  expr = expr.replace(/Ã—/g, '*').replace(/Ã·/g, '/');

  // í—ˆìš© ë¬¸ìë§Œ ê²€ì‚¬(ìˆ«ì, + - * /, (), ê³µë°±)
  if (!/^[\d+\-*/()\s.]+$/.test(expr)) return false;

  // ìˆ«ì ì‚¬ìš© ê²€ì¦ (ê° ìˆ«ìë¥¼ ì •í™•íˆ í•œ ë²ˆì”©)
  const used = (expr.match(/\d+/g) || []).map(n => Number(n)).sort((a,b)=>a-b);
  const need = [...numbers].sort((a,b)=>a-b);
  if (JSON.stringify(used) !== JSON.stringify(need)) return false;

  return true;
}

// ì•ˆì „ í‰ê°€: í—ˆìš© ë¬¸ìë§Œ í†µê³¼ì‹œì¼œ new Functionìœ¼ë¡œ ê³„ì‚°
function safeEval(expr) {
  expr = expr.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
  // ë§ˆì§€ë§‰ ë°©ì–´ì„ : í—ˆìš© ë¬¸ìë§Œ
  if (!/^[\d+\-*/()\s.]+$/.test(expr)) throw new Error('invalid');
  // ê´„í˜¸ ë°¸ëŸ°ìŠ¤ ê°„ë‹¨ ì²´í¬
  let bal = 0;
  for (const ch of expr) {
    if (ch === '(') bal++;
    if (ch === ')') bal--;
    if (bal < 0) throw new Error('paren');
  }
  if (bal !== 0) throw new Error('paren');

  const fn = new Function(`return (${expr});`);
  return fn();
}

async function checkFourEqualsTen() {
  const fb = document.getElementById('game-feedback');
  const input = document.getElementById('game-input');
  if (!input || !fb) return;
  const expr = input.value.trim();

  if (!isValidExpression(expr, currentFourNumbers)) {
    fb.textContent = 'âŒ ì£¼ì–´ì§„ 4ê°œ ìˆ«ìë¥¼ ê°ê° í•œ ë²ˆì”©ë§Œ ì‚¬ìš©í•˜ê³ , + - Ã— Ã· () ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.';
    exitMiniGame();   // ğŸš€ ì œì¶œê³¼ ë™ì‹œì— ìë™ ë‚˜ê°€ê¸°
    return;
  }

  try {
    const result = safeEval(expr);
    const ok = Math.abs(result - 10) < 1e-9;

    if (ok) {
      fb.textContent = 'ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! (+10ì½”ì¸ ì§€ê¸‰)';
      const username = localStorage.getItem('savedUsername');
      if (username) {
        const { error } = await supabaseClient
          .from('users')
          .update({ coin_balance: currentUserCoin + 10 })
          .eq('username', username);
        if (!error) {
          currentUserCoin += 10;
          if (typeof displayCoinBalance === 'function') {
            displayCoinBalance();
          }
        }
      }
    } else {
      fb.textContent = `ğŸ˜… ì˜¤ë‹µ! ê²°ê³¼ëŠ” ${result} ì…ë‹ˆë‹¤.`;
    }

    // ğŸš€ ì •ë‹µì´ë“  ì˜¤ë‹µì´ë“  ì œì¶œ í›„ ìë™ìœ¼ë¡œ ë‚˜ê°€ê¸°
    exitMiniGame();

  } catch (e) {
    fb.textContent = 'âš ï¸ ì‹ì„ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
    exitMiniGame();   // ğŸš€ ì˜¤ë¥˜ì—¬ë„ ì œì¶œ í›„ ë‚˜ê°€ê¸°
  }
} 

// ë‚˜ê°€ê¸° ë²„íŠ¼
function exitMiniGame() {
  const game = document.getElementById('fourEqualsTen-game');
  if (game) game.style.display = 'none';
  const panel = document.getElementById('minigame-panel');
  if (panel) panel.style.display = 'block';
}

// ê²Œì„ ì‹œì‘(ì½”ì¸ 5 ì°¨ê°)
async function startGame(gameType) {
  if (gameType !== 'fourEqualsTen') return;

  const username = localStorage.getItem('savedUsername');
  if (!username) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }

  // ì½”ì¸ ìµœì‹ í™”
  await syncCoinBalance();

  const cost = 5;
  if (currentUserCoin < cost) {
    alert('ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: 5)');
    return;
  }

  // DB ì½”ì¸ ì°¨ê°
  const { error } = await supabaseClient
    .from('users')
    .update({ coin_balance: currentUserCoin - cost })
    .eq('username', username);

  if (error) {
    alert('ì½”ì¸ ì°¨ê° ì‹¤íŒ¨: ' + error.message);
    return;
  }

  // ë¡œì»¬/í™”ë©´ ê°±ì‹ 
  currentUserCoin -= cost;
  if (typeof displayCoinBalance === 'function') {
    displayCoinBalance();
  }

  // í™”ë©´ ì „í™˜ & ë‚œìˆ˜ ìƒì„±
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  const game = document.getElementById('fourEqualsTen-game');
  if (game) game.style.display = 'block';
  generateFourNumbers();
}

// ì—”í„°í‚¤ë¡œ ì œì¶œ ê°€ëŠ¥
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('game-input');
  if (input) {
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        checkFourEqualsTen();
      }
    });
  }
});



    document.addEventListener('DOMContentLoaded', () => {
      const agree = document.getElementById('privacy-agree');
      const btn = document.getElementById('signup-btn');
      agree.addEventListener('change', () => {
        btn.style.display = agree.checked ? 'block' : 'none';
      });
    });

    function toggleMobileMenu() {
      document.getElementById('mobile-side-menu').classList.toggle('open');
      document.getElementById('mobile-overlay').classList.toggle('show');
    }

    function closeMobileMenu() {
      document.getElementById('mobile-side-menu').classList.remove('open');
      document.getElementById('mobile-overlay').classList.remove('show');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const domainSelect = document.getElementById('signupEmailDomain');
      const customInput = document.getElementById('signupEmailCustom');

      domainSelect.addEventListener('change', () => {
        if (domainSelect.value === 'ì§ì ‘ì…ë ¥') {
          customInput.style.display = 'block';
        } else {
          customInput.style.display = 'none';
        }
      });
    });

    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        input.type = input.type === 'password' ? 'text' : 'password';
      } 

    document.addEventListener('DOMContentLoaded', () => {
    const menuProfile = document.getElementById('menu-profile');
    const menuPassword = document.getElementById('menu-password');
    const menuSetting = document.getElementById('menu-setting');
    const menuLogout = document.getElementById('menu-logout');

      if (menuProfile) {
        menuProfile.addEventListener('click', (e) => {
          e.preventDefault();
          showPanel('profile-panel');
          closeMobileMenu();
        });
      }

        if (menuPassword) {
          menuPassword.addEventListener('click', (e) => {
            e.preventDefault();
            alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
            closeMobileMenu();
            /*showPanel('profile-panel'); // ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ íŒ¨ë„ ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ ë°”ê¾¸ì„¸ìš”
            closeMobileMenu();*/
          });
        }

        if (menuSetting) {
          menuSetting.addEventListener('click', (e) => {
            e.preventDefault();
            alert('ì„¤ì •ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
            closeMobileMenu();
          });
        }

        if (menuLogout) {
          menuLogout.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
            closeMobileMenu();
          });
        }
    });

    let currentDate = new Date();

    function formatYMD(date) {
      return date.toISOString().slice(0, 10).replace(/-/g, '');
    }

    function updateDateLabels() {
      const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
      const dateStr = currentDate.toLocaleDateString('ko-KR', options);
      document.getElementById('timetable-date-label').textContent = dateStr;
      document.getElementById('meal-date-label').textContent = dateStr;
    }

    function changeDate(delta) {
      currentDate.setDate(currentDate.getDate() + delta);
      //updateDateLabels();
      loadTimetable();
      loadMeal();
    }

    const fileInput = document.getElementById('homework-file');
    const previewContainer = document.getElementById('filePreviewContainer');
    const modal = document.getElementById('fileModal');
    const modalImage = document.getElementById('modalImage');
    const downloadLink = document.getElementById('downloadLink');

    fileInput.addEventListener('change', () => {
      previewContainer.innerHTML = '';

      Array.from(fileInput.files).forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = e => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = file.name;
            img.onclick = () => {
              modal.style.display = 'flex';
              modalImage.src = e.target.result;
              downloadLink.href = e.target.result;
              downloadLink.download = file.name;
            };
            previewContainer.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });
    });

    function closeModal() {
      modal.style.display = 'none';
    }

    function openImageModal(url) {
      const modal = document.getElementById('imageModal');
      const img = document.getElementById('modalImage');
      img.src = url;
      modal.style.display = 'flex';
    }

    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.style.display = 'none';
    }

    /* ===== DASHBOARD TOP ===== */
function $id(id){return document.getElementById(id)}

function initDashboardTop(){
  // ë‚ ì§œ
  const d=new Date(); const w=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];
  if($id('dash-notice-date')) $id('dash-notice-date').textContent =
    `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} (${w})`;

  // ì‚¬ìš©ì ë¼ë²¨
  const nm = currentUserName || localStorage.getItem('savedName') || 'í•™ìƒ';
  const num = currentStudentNumber || localStorage.getItem('savedStudentNum') || 0;
const grd = (currentGrade ?? parseInt(localStorage.getItem('savedGrade') || '0', 10)) || '-';
const cls = (currentClassNum ?? parseInt(localStorage.getItem('savedClassNum') || '0', 10)) || '-';
  if($id('dash-name')) $id('dash-name').textContent = nm;
  if($id('dash-num')) $id('dash-num').textContent = num;
  if($id('dash-grade')) $id('dash-grade').textContent = grd;
  if($id('dash-class')) $id('dash-class').textContent = cls;

  // ê³µì§€ 3ê±´
  loadRecentNotices3();
  // ìŠ¤íƒ¯(ë ˆë²¨/ê²½í—˜ì¹˜/í¬ì¸íŠ¸)
  syncStatsAndRender();
}

async function loadRecentNotices3(){
  const box = $id('dash-notice-list');
  if(!box) return;
  box.innerHTML = `<div class="notice-item"><div class="meta">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>`;

  let q = supabaseClient.from('notices').select('*').order('id',{ascending:false}).limit(3);
  if(currentUserRole !== 'admin'){
    q = q.eq('grade', currentGrade).eq('class_num', currentClassNum).neq('writer_role','admin');
  }
  const {data, error} = await q;
  if(error){ box.innerHTML = `<div class="notice-item"><div class="meta">ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div></div>`; return; }
  if(!data || data.length===0){ box.innerHTML = `<div class="notice-item"><div class="meta">ìµœê·¼ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>`; return; }

  box.innerHTML = '';
  data.forEach(n=>{
    const preview = (n.content||'').replace(/\n/g,' ').slice(0,90);
    const el = document.createElement('div');
    el.className='notice-item';
    el.innerHTML = `
      <div class="title">${n.title}</div>
      <div class="meta">${n.writer} Â· ${n.grade}í•™ë…„ ${n.class_num}ë°˜</div>
      <div class="meta" style="margin-top:4px">${preview}${(n.content||'').length>90?'â€¦':''}</div>`;
    box.appendChild(el);
  });
}

async function syncStatsAndRender(){
  try{
    const username = localStorage.getItem('savedUsername');
    if(!username) { 
      renderStats({ level:1, exp:0, need:20 }); 
      return; 
    }

    const { data, error } = await supabaseClient
      .from('users')
      .select('level, exp, coin_balance')
      .eq('username', username)
      .single();

    const level = (data && Number.isInteger(data.level)) ? data.level : 1;
    const exp   = (data && Number.isInteger(data.exp))   ? data.exp   : 0;

    // í•„ìš” ê²½í—˜ì¹˜ëŠ” ê³ ì • 20 (ê¸°ì¡´ ê·œì¹™ ìœ ì§€)
    const need = 20;

    // âš ï¸ ì—¬ê¸°ì„œëŠ” ì½”ì¸ ë„˜ê¸°ì§€ ì•ŠìŒ
    renderStats({ level, exp, need });
  }catch(e){
    console.warn(e);
    renderStats({ level:1, exp:0, need:20 }); // ì½”ì¸ ì—…ë°ì´íŠ¸ ê¸ˆì§€
  }
}



/* ë¡œê·¸ì¸ ì§í›„/ìë™ë¡œê·¸ì¸ ì§í›„ ë°˜ë“œì‹œ í˜¸ì¶œ */
async function afterLoginRefreshDashboard(){
  initDashboardTop();
}

/* í˜ì´ì§€ê°€ ì—´ë ¤ ìˆì„ ë•Œë„ 1íšŒ ì´ˆê¸°í™” */
document.addEventListener('DOMContentLoaded', initDashboardTop);


function renderStats({ level, exp, need, point }) {
  if ($id('lv-num')) $id('lv-num').textContent = level;

  // pointê°€ ì •ì˜ëœ ê²½ìš°ì—ë§Œ ì½”ì¸ í‘œì‹œë¥¼ ê°±ì‹  (loadCoinBalanceê°€ ì§„ì§œ ì†ŒìŠ¤)
  if ($id('coin-balance') && point !== undefined) {
    $id('coin-balance').textContent = point;
  }

  const cur = Math.max(0, Math.min(exp, need));
  const pct = need > 0 ? Math.round((cur / need) * 100) : 0;

  if ($id('exp-cur'))  $id('exp-cur').textContent = cur;
  if ($id('exp-need')) $id('exp-need').textContent = need;
  if ($id('lvl-fill')) $id('lvl-fill').style.width = pct + '%';
}


// ì½”ì¸ë§Œ DBì—ì„œ ì½ì–´ì™€ ëŒ€ì‹œë³´ë“œ ì¹©ì— ë°˜ì˜
async function loadCoinBalance() {
  const username = localStorage.getItem('savedUsername');
  if (!username) return;

  const { data, error } = await supabaseClient
    .from('users')
    .select('coin_balance')
    .eq('username', username)
    .single();

  // ì‹¤íŒ¨/ë„ ëŒ€ë¹„í•´ì„œ 0ìœ¼ë¡œ ì²˜ë¦¬
  const coin = (!error && data && Number.isFinite(+data.coin_balance)) ? +data.coin_balance : 0;

  // í™”ë©´ ë°˜ì˜
  const el = document.getElementById('coin-balance');
  if (el) el.textContent = coin;

  // (ì„ íƒ) ì „ì—­ê°’ ë™ê¸°í™”
  currentUserCoin = coin;
}


/* ====== [ë‹¬ë ¥/ìˆ˜í–‰ì¼ì • ì „ìš© í•¨ìˆ˜ ëª¨ìŒ: ê·¸ëŒ€ë¡œ ë¶™ì—¬ ë„£ê¸°] ====== */

// ë‚ ì§œ ìœ í‹¸
// ë¡œì»¬ ê¸°ì¤€ YYYY-MM-DD
const ymd = (d) => {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
};
// ë¡œì»¬ ê¸°ì¤€ YYYYMMDD (NEIS ì¿¼ë¦¬ìš©)
const ymdCompact = (d) => ymd(d).replace(/-/g, '');

const startOfMonth = d => new Date(d.getFullYear(), d.getMonth(), 1);
const endOfMonth   = d => new Date(d.getFullYear(), d.getMonth()+1, 0);
const addDays = (d,n)=>{ const t=new Date(d); t.setDate(t.getDate()+n); return t; };

// ë‹¬ë ¥ ê¸°ì¤€ ì›”
let schedRefDate = new Date();

// 6ì£¼(42ì¹¸) ë‹¬ë ¥ ì…€ ìƒì„±
function buildMonthMatrix(ref){
  const first = startOfMonth(ref);
  const start = addDays(first, -((first.getDay()+7)%7)); // ê·¸ ì£¼ì˜ ì¼ìš”ì¼
  const days = [];
  for(let i=0;i<42;i++) days.push(addDays(start,i));
  return days;
}

// ì›”ê°„ ìˆ˜í–‰ ì¡°íšŒ (í•™ë…„/ë°˜ ê¸°ì¤€) â€” assessments(date, period, subject, grade, class_num)
async function fetchAssessmentsMonth(ref){
  const first = ymd(startOfMonth(ref));
  const last  = ymd(endOfMonth(ref));
  const { data, error } = await supabaseClient
    .from('assessments')
    .select('date, period, subject')
    .gte('date', first).lte('date', last)
    .eq('grade', currentGrade).eq('class_num', currentClassNum)
    .order('date, period');
  if(error){ console.warn('assessments error', error); return []; }
  return data || [];
}

// ìƒì„¸ íŒ¨ë„ ë Œë” (í´ë¦­ ì‹œ) â€” ìˆ˜í–‰(itemsA) + í•™ì‚¬(itemsE)
function renderSchedDetail(dateStr, itemsA, itemsE){
  const t  = document.getElementById('sched-detail-title');
  const ul = document.getElementById('sched-detail-list');
  t.textContent = `${dateStr.replace(/-/g,'.')} ì¼ì •`;

  const aPart = (itemsA && itemsA.length)
    ? itemsA.map(x=>`<li>ğŸ“ <b>${x.period}êµì‹œ</b> Â· ${x.subject || 'ìˆ˜í–‰'}</li>`).join('')
    : '<li>ğŸ“ ìˆ˜í–‰ ì¼ì • ì—†ìŒ</li>';

  const ePart = (itemsE && itemsE.length)
    ? itemsE.map(e=>{
        const tag = e.kind==='holiday'?'ğŸ–ï¸':
                    e.kind==='exam'?'ğŸ§ª':'ğŸ“Œ';
        return `<li>${tag} ${e.title}</li>`;
      }).join('')
    : '<li>ğŸ“Œ í•™ì‚¬ì¼ì • ì—†ìŒ</li>';

  ul.innerHTML = `
    <div style="margin-bottom:.4rem;color:#6b7280;font-weight:700;">ìˆ˜í–‰</div>
    ${aPart}
    <div style="margin:.6rem 0 .4rem;color:#6b7280;font-weight:700;">í•™ì‚¬</div>
    ${ePart}
  `;
}


// âœ… ìˆ˜í–‰+í•™ì‚¬ í†µí•© ë‹¬ë ¥ ë Œë”ëŸ¬ (ì™„ì„±ë³¸ + í† ìš”íœ´ì—…ì¼ ì œì™¸)
async function renderScheduleCalendar(){
  // ì›” ë¼ë²¨
  const label = document.getElementById('sched-month-label');
  label.textContent = `${schedRefDate.getFullYear()}.${String(schedRefDate.getMonth()+1).padStart(2,'0')}`;

  const grid = document.getElementById('sched-grid');
  const detailTitle = document.getElementById('sched-detail-title');
  const detailList  = document.getElementById('sched-detail-list');
  if (!grid) return;

  grid.innerHTML = '<div style="grid-column: 1 / -1; padding: 8px; color:#6b7280;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

  try {
    // 1) ë°ì´í„° ë™ì‹œ ë¡œë“œ
    const [assessRows, schoolRowsRaw] = await Promise.all([
      fetchAssessmentsMonth(schedRefDate),   // {date:'YYYY-MM-DD', period, subject}
      fetchSchoolEventsMonth(schedRefDate)   // {date:'YYYY-MM-DD', title, kind:'exam|holiday|event'}
    ]);

    // ğŸ”¹ (ì¶”ê°€) í† ìš”íœ´ì—…ì¼ ì œì™¸
    const schoolRows = (schoolRowsRaw || []).filter(ev =>
      !/(í† ìš”\s*íœ´ì—…ì¼)/.test(ev.title || '')
    );

    // 2) ë‚ ì§œë³„ë¡œ ë¬¶ê¸°
    const assessByDate = assessRows.reduce((m,r)=>{
      (m[r.date] ??= []).push({ type:'assess', period:r.period, title:r.subject || 'ìˆ˜í–‰' });
      return m;
    }, {});
    const schoolByDate = schoolRows.reduce((m,r)=>{
      (m[r.date] ??= []).push({ type:'school', title:r.title, kind:r.kind });
      return m;
    }, {});

    // 3) 6ì£¼(42ì¹¸) ë‹¬ë ¥ ê·¸ë¦¬ë“œ
    const cells = buildMonthMatrix(schedRefDate);
    const todayStr = ymd(new Date());

    grid.innerHTML = '';
    let firstSelectedDone = false;

    cells.forEach(d=>{
      const dStr = ymd(d);
      const inMonth = (d.getMonth() === schedRefDate.getMonth());

      // í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ì•„ì´í…œ(ìˆ˜í–‰ + í•™ì‚¬)
      const itemsA = assessByDate[dStr] || [];
      const itemsE = schoolByDate[dStr] || [];
      const items  = [...itemsA, ...itemsE];

      // ì…€ ìƒì„±
      const cell = document.createElement('div');
      cell.className = 'sched-cell' + (inMonth ? '' : ' out');
      if (dStr === todayStr) cell.classList.add('today');
      if (items.length)      cell.classList.add('has');

      // ìƒë‹¨ ë‚ ì§œ
      const dayEl = `<div class="sched-day">${d.getDate()}</div>`;

      const top3 = items.slice(0,3).map(it=>{
  if (it.type === 'assess') {
    // ìˆ˜í–‰: ê³¼ëª© - nêµì‹œ
    return `<div class="sched-item">
              ğŸ“˜ ${escapeHtml(it.title)} - <b>${it.period}</b>êµì‹œ
            </div>`;
  } else {
    // í•™ì‚¬: ì•„ì´ì½˜ + ì¹´í…Œê³ ë¦¬ ë¼ë²¨
    return `<div class="sched-item">
              ${eventLabel(it.kind, escapeHtml(it.title))}
            </div>`;
  }
}).join('');


      const more = items.length > 3
        ? `<div class="sched-more">+${items.length - 3}ê°œ ë”</div>`
        : '';

      cell.innerHTML = `${dayEl}<div class="sched-items">${top3}${more}</div>`;

      // í´ë¦­: ì„ íƒ í…Œë‘ë¦¬ ë‹¨ í•˜ë‚˜ + ìƒì„¸ íŒ¨ë„ ê°±ì‹ 
      cell.addEventListener('click', ()=>{
        document.querySelectorAll('.sched-cell.selected').forEach(el=>el.classList.remove('selected'));
        cell.classList.add('selected');
        renderSchedDetail(dStr, itemsA, itemsE);
      });

      grid.appendChild(cell);

      // ì²˜ìŒ ì§„ì… ì‹œ: ê°™ì€ ë‹¬ì˜ ì˜¤ëŠ˜ ìë™ ì„ íƒ/í‘œì‹œ
      if (!firstSelectedDone && dStr === todayStr && inMonth) {
        cell.classList.add('selected');
        renderSchedDetail(dStr, itemsA, itemsE);
        firstSelectedDone = true;
      }
    });

    // ì˜¤ëŠ˜ì´ ë‹¬ ë°–/ë°ì´í„° ì—†ìŒ â†’ ì²« ì¼ì • ìˆëŠ” ë‚  or ê·¸ ë‹¬ 1ì¼ ì„ íƒ
    if (!firstSelectedDone) {
      const allDates = [...new Set([
        ...Object.keys(assessByDate),
        ...Object.keys(schoolByDate)
      ])].sort();

      const pick = allDates[0] || `${schedRefDate.getFullYear()}-${String(schedRefDate.getMonth()+1).padStart(2,'0')}-01`;
      renderSchedDetail(pick, assessByDate[pick] || [], schoolByDate[pick] || []);

      // UIìƒ ì„ íƒ í…Œë‘ë¦¬ë„ ë™ê¸°í™”
      const day = Number(pick.slice(-2));
      const cellToSelect = [...grid.children].find(div => {
        const numEl = div.querySelector('.sched-day');
        return numEl && Number(numEl.textContent) === day && !div.classList.contains('out');
      });
      if (cellToSelect) {
        document.querySelectorAll('.sched-cell.selected').forEach(el=>el.classList.remove('selected'));
        cellToSelect.classList.add('selected');
      }
    }

  } catch (e) {
    console.warn('ë‹¬ë ¥ ë Œë” ì˜¤ë¥˜:', e);
    grid.innerHTML = '<div style="grid-column: 1 / -1; padding: 8px; color:#ef4444;">ë‹¬ë ¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
    if (detailTitle) detailTitle.textContent = 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”';
    if (detailList)  detailList.innerHTML = '';
  }
}



// ì‘ì€ XSS ë°©ì§€ìš©
function escapeHtml(s=''){
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}



// ì›” ì „í™˜ ë²„íŠ¼ ë°”ì¸ë”© (í•œ ë²ˆë§Œ)
let scheduleBound = false;
function bindScheduleUI(){
  if(scheduleBound) return;
  scheduleBound = true;

  const prev = document.getElementById('sched-prev');
  const next = document.getElementById('sched-next');
  if(prev) prev.onclick = () => {
    schedRefDate = new Date(schedRefDate.getFullYear(), schedRefDate.getMonth()-1, 1);
    renderScheduleCalendar();
  };
  if(next) next.onclick = () => {
    schedRefDate = new Date(schedRefDate.getFullYear(), schedRefDate.getMonth()+1, 1);
    renderScheduleCalendar();
  };
}

/* (ì„ íƒ) ê¸°ì¡´ afterLoginRefreshDashboardë¥¼ ì´ ë²„ì „ìœ¼ë¡œ êµì²´ */
async function afterLoginRefreshDashboard(){
  initDashboardTop();      // ê¸°ì¡´ ëŒ€ì‹œë³´ë“œ ìƒë‹¨ ì´ˆê¸°í™”
  bindScheduleUI();        // âªâ© ë°”ì¸ë”©
  await renderScheduleCalendar(); // ë‹¬ë ¥ ì²« ë Œë”
}


// ì›”ê°„ í•™ì‚¬ì¼ì • ì¡°íšŒ (NEIS SchoolSchedule)
async function fetchSchoolEventsMonth(ref){
  // ë‹¬ ë²”ìœ„(YYYYMMDD)
const firstDate = startOfMonth(ref);
const lastDate  = endOfMonth(ref);
const AA_FROM_YMD = ymdCompact(firstDate);
const AA_TO_YMD   = ymdCompact(lastDate);


  // í•™ë…„ë„/í•™ê¸° (ë„¤ê°€ ì‹œê°„í‘œì—ì„œ ì“°ë˜ ê·œì¹™ê³¼ ë™ì¼)
  const AY  = ref.getFullYear();
  const mm  = ref.getMonth() + 1;
  const SEM = (mm <= 8) ? 1 : 2;

  const url = `https://open.neis.go.kr/hub/SchoolSchedule` +
              `?KEY=${NEIS_KEY}` +
              `&Type=json` +
              `&ATPT_OFCDC_SC_CODE=${ATPT_OFCDC_SC_CODE}` +
              `&SD_SCHUL_CODE=${SD_SCHUL_CODE}` +
              `&AY=${AY}&SEM=${SEM}` +
              `&AA_FROM_YMD=${AA_FROM_YMD}` +
              `&AA_TO_YMD=${AA_TO_YMD}`;

  try{
    const res = await fetch(url);
    const data = await res.json();

    // NEIS ì‘ë‹µ íŒŒì‹±
    if(!(data.SchoolSchedule && data.SchoolSchedule[1])) return [];

    const rows = data.SchoolSchedule[1].row || [];
    // ë„ˆì˜ ë‹¬ë ¥ ë Œë”ëŸ¬ê°€ ì“°ëŠ” í˜•íƒœë¡œ ë³€í™˜
    return rows.map(r=>{
      const ymd = String(r.AA_YMD || '');
      const date = `${ymd.slice(0,4)}-${ymd.slice(4,6)}-${ymd.slice(6,8)}`;
      const title = r.EVENT_NM || r.EVENT_CNTNT || '';
      const kind = classifyNeisEvent(title, r.EVENT_CNTNT || '');
      return { date, title, kind };
    });

  }catch(e){
    console.warn('NEIS í•™ì‚¬ì¼ì • ì˜¤ë¥˜:', e);
    return [];
  }
}

// âœ… NEIS í•™ì‚¬ì¼ì • ë¶„ë¥˜ê¸°: ì œëª©/ë‚´ìš©ìœ¼ë¡œ exam | holiday | event íŒë³„
function classifyNeisEvent(title = '', detail = '') {
  const s = `${title} ${detail}`.toLowerCase();

  // ì‹œí—˜/í‰ê°€
  const examKw = [
    'ì‹œí—˜','ì§€í•„','ì¤‘ê°„','ê¸°ë§','í‰ê°€','ê³ ì‚¬','ëª¨ì˜','í€´ì¦ˆ','ìˆ˜í–‰í‰ê°€'
  ];
  // íœ´ì—…/ê³µíœ´ì¼/ë°©í•™
  const holidayKw = [
    'íœ´ì—…','ë°©í•™','ê³µíœ´ì¼','ëŒ€ì²´ê³µíœ´ì¼','ê°œêµê¸°ë…ì¼','ì¬ëŸ‰íœ´ì—…','íœ´êµ',
    'ì„¤ë‚ ','ì„¤ ì—°íœ´','ì¶”ì„','ì¶”ì„ ì—°íœ´','ì„±íƒ„','í¬ë¦¬ìŠ¤ë§ˆìŠ¤','í˜„ì¶©ì¼','ì–´ë¦°ì´ë‚ ',
    'ê´‘ë³µì ˆ','ê°œì²œì ˆ','í•œê¸€ë‚ ','ì„ê°€íƒ„ì‹ ì¼','ì‹ ì •'
  ];

  if (examKw.some(k => s.includes(k)))   return 'exam';
  if (holidayKw.some(k => s.includes(k))) return 'holiday';

  // ê·¸ ì™¸(í–‰ì‚¬, ì…í•™ì‹/ì¡¸ì—…ì‹/ì†Œí’/ì¶•ì œ/ì²´í—˜í•™ìŠµ ë“±)
  return 'event';
}

// í•™ì‚¬ì¼ì • í‘œì‹œìš© ë¼ë²¨: ì•„ì´ì½˜ + ì œëª©
function eventLabel(kind, title){
  // title ë³´ì • (ë¹ˆê°’/â€¦ ë°©ì§€)
  const t = (title && title.trim()) ? title : 'í•™ì‚¬ ì¼ì •';
  if (kind === 'holiday') return `ğŸ–ï¸ ${t}`;
  if (kind === 'exam')    return `ğŸ“ ${t}`;
  return `ğŸ“Œ ${t}`; // ì¼ë°˜ í–‰ì‚¬
}


function renderSchedDetail(dateStr, itemsA, itemsE){
  const t  = document.getElementById('sched-detail-title');
  const ul = document.getElementById('sched-detail-list');
  t.textContent = `${dateStr.replace(/-/g,'.')} ì¼ì •`;

  const aPart = (itemsA && itemsA.length)
    ? itemsA.map(x=>`<li>ğŸ“˜ <b>${x.period}êµì‹œ</b> Â· ${escapeHtml(x.title)}</li>`).join('')
    : '<li>ğŸ“ ìˆ˜í–‰ ì¼ì • ì—†ìŒ</li>';

  const ePart = (itemsE && itemsE.length)
    ? itemsE.map(e=>`<li>${eventLabel(e.kind, escapeHtml(e.title))}</li>`).join('')
    : '<li>ğŸ“Œ í•™ì‚¬ì¼ì • ì—†ìŒ</li>';

  ul.innerHTML = `
    <div style="margin-bottom:.4rem;color:#6b7280;font-weight:700;">ìˆ˜í–‰</div>
    ${aPart}
    <div style="margin:.6rem 0 .4rem;color:#6b7280;font-weight:700;">í•™ì‚¬</div>
    ${ePart}
  `;
}


(() => {
  // ì´ë¯¸ ìƒë‹¨ì—ì„œ ì„¤ì •ëœ ê°’ ì¬ì‚¬ìš©: NEIS_KEY, ATPT_OFCDC_SC_CODE, SD_SCHUL_CODE
  // ì‚¬ìš©ì ìƒíƒœ ì¬ì‚¬ìš©: currentGrade, currentClassNum (ì—†ìœ¼ë©´ localStorageë¡œ ë³´ê°•)

  // DOM
  const elBadge   = document.getElementById('badge-day');
  const elList    = document.getElementById('timetable');
  const elNotice  = document.getElementById('notice');
  const elPicker  = document.getElementById('datePicker');

  const DOW = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

  // ë‚ ì§œ ìœ í‹¸ (ì„œìš¸ ê¸°ì¤€)
  const seoulNow = () => new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
  const toInput = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const toNeisYmd = d => toInput(d).replace(/-/g,'');
  const semesterOf = (d) => (d.getMonth()+1) <= 8 ? 1 : 2;

  function getGradeClass() {
    const g = (typeof currentGrade === 'number' ? currentGrade : parseInt(localStorage.getItem('savedGrade'), 10)) || null;
    const c = (typeof currentClassNum === 'number' ? currentClassNum : parseInt(localStorage.getItem('savedClassNum'), 10)) || null;
    return { grade: g, classNum: c };
  }

  function setBadge(d) {
    if (!elBadge) return;
    elBadge.textContent = `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} (${DOW[d.getDay()]})`;
  }

  function showNotice(msg) {
    if (!elNotice) return;
    elList.innerHTML = '';
    elNotice.style.display = 'block';
    elNotice.textContent = msg;
  }

  function hideNotice() {
    if (!elNotice) return;
    elNotice.style.display = 'none';
    elNotice.textContent = '';
  }

  function renderRows(rows) {
    if (!rows || rows.length === 0) {
      elList.innerHTML = '';
      showNotice('êµìœ¡ì²­ ì‹œê°„í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    hideNotice();

    // ê°™ì€ êµì‹œ ì¤‘ë³µ ì œê±° (ê°€ë” ê°™ì€ PERIOê°€ ì—¬ëŸ¬ í–‰ìœ¼ë¡œ ì˜´)
    const byPeriod = {};
    for (const r of rows) {
      const p = String(r.PERIO ?? '').trim();
      if (!p) continue;
      if (!byPeriod[p]) byPeriod[p] = r.ITRT_CNTNT || '';
    }
    const sorted = Object.keys(byPeriod).map(Number).sort((a,b)=>a-b);

    elList.innerHTML = sorted.map(p => `
      <li style="display:flex;align-items:center;gap:10px;padding:10px 6px;border-top:1px dashed #e9ecef;">
        <span style="width:58px;min-width:58px;text-align:center;font-weight:700;">${p}êµì‹œ</span>
        <span style="font-weight:600;">${byPeriod[p] || ''}</span>
      </li>
    `).join('');

    const first = elList.querySelector('li');
    if (first) first.style.borderTop = '0';
  }

  async function fetchNeisDay({ grade, classNum }, dateObj) {
    const AY   = dateObj.getFullYear();
    const SEM  = semesterOf(dateObj);
    const YMD  = toNeisYmd(dateObj);

    const url =
      `https://open.neis.go.kr/hub/misTimetable` +
      `?KEY=${encodeURIComponent(NEIS_KEY)}` +
      `&Type=json` +
      `&ATPT_OFCDC_SC_CODE=${encodeURIComponent(ATPT_OFCDC_SC_CODE)}` +
      `&SD_SCHUL_CODE=${encodeURIComponent(SD_SCHUL_CODE)}` +
      `&AY=${AY}&SEM=${SEM}` +
      `&ALL_TI_YMD=${YMD}` +
      `&GRADE=${encodeURIComponent(grade)}` +
      `&CLASS_NM=${encodeURIComponent(classNum)}`;

    const res  = await fetch(url);
    if (!res.ok) throw new Error(`NEIS ì‘ë‹µ ì˜¤ë¥˜ ${res.status}`);
    const json = await res.json();
    // ì •ìƒ ë°ì´í„°: json.misTimetable[1].row
    const block = json && json.misTimetable && json.misTimetable[1];
    return block ? (block.row || []) : [];
  }

  async function loadTimetableDay(dateStr) {
    const dateObj = dateStr ? new Date(dateStr) : seoulNow();
    setBadge(dateObj);

    const { grade, classNum } = getGradeClass();
    if (!grade || !classNum) {
      renderRows([]);
      showNotice('í•™ë…„/ë°˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
      return;
    }

    try {
      const rows = await fetchNeisDay({ grade, classNum }, dateObj);
      renderRows(rows);
    } catch (e) {
      console.warn(e);
      renderRows([]);
      showNotice('ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', () => {
    if (elPicker) {
      // ê¸°ë³¸ê°’ = ì˜¤ëŠ˜(ì„œìš¸)
      elPicker.value = toInput(seoulNow());
      elPicker.addEventListener('change', (e) => loadTimetableDay(e.target.value));
    }
    loadTimetableDay(elPicker?.value);
  });

  // ë‹¤ë¥¸ ê³³ì—ì„œ ì¬í˜¸ì¶œí•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©
  window.reloadTimetableCard = () => loadTimetableDay(elPicker?.value || undefined);
})();


(function(){
  const ul        = document.getElementById('rank-list');
  const meEl      = document.getElementById('rank-me');
  const selMetric = document.getElementById('rank-metric');
  const selScope  = document.getElementById('rank-scope');
  const btnRefresh= document.getElementById('rank-refresh');

  // í•™ìƒì€ ë²”ìœ„ ê³ ì •(ê°™ì€ ë°˜), ê´€ë¦¬ìë§Œ ë³€ê²½ ê°€ëŠ¥
  if (typeof currentUserRole === 'string' && currentUserRole !== 'admin') {
    selScope.value = 'class';
    selScope.disabled = true;
  }

  // --- helpers ---
  const escapeHtml = (s='') => String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  function medal(n){
    if (n===1) return 'ğŸ¥‡';
    if (n===2) return 'ğŸ¥ˆ';
    if (n===3) return 'ğŸ¥‰';
    return `<span style="display:inline-block;width:22px;text-align:right;font-weight:700;color:#6b7280">${n}</span>`;
  }

  function rowHtml(rank, u, metric){
    const right =
      metric==='coin'
        ? `ğŸ’° ${Number(u.coin_balance||0)}`
        : `Lv ${Number(u.level||1)} (XP ${Number(u.xp||0)})`;
    const sub = `${u.grade??'-'}í•™ë…„ ${u.class_num??'-'}ë°˜ Â· ${u.student_number??''}ë²ˆ`;
    return `
      <li style="display:flex;align-items:center;gap:10px;padding:10px;border-top:1px dashed #e9ecef;">
        <div style="width:32px;text-align:center">${medal(rank)}</div>
        <div style="flex:1 1 auto;">
          <div style="font-weight:700">${escapeHtml(u.name||u.username||'í•™ìƒ')}</div>
          <div style="font-size:.85rem;color:#6b7280">${sub}</div>
        </div>
        <div style="font-weight:700">${right}</div>
      </li>`;
  }

  function meHtml(rank, total, u, metric){
    const right =
      metric==='coin'
        ? `ğŸ’° ${Number(u.coin_balance||0)}`
        : `Lv ${Number(u.level||1)} (XP ${Number(u.xp||0)})`;
    return `
      <div style="display:flex;align-items:center;gap:10px">
        <div style="font-weight:800">ë‚´ ìˆœìœ„</div>
        <div style="margin-left:auto;font-size:.9rem;color:#6b7280">${rank}/${total}</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-top:6px">
        <div style="width:32px;text-align:center">${medal(rank)}</div>
        <div style="flex:1 1 auto;">
          <div style="font-weight:700">${escapeHtml(u.name||'ë‚˜')}</div>
          <div style="font-size:.85rem;color:#6b7280">${u.grade??'-'}í•™ë…„ ${u.class_num??'-'}ë°˜ Â· ${u.student_number??''}ë²ˆ</div>
        </div>
        <div style="font-weight:700">${right}</div>
      </div>`;
  }

  function sortUsers(users, metric){
    if (metric === 'coin') {
      // ì½”ì¸ ë‚´ë¦¼ì°¨ìˆœ, ë™ì ì ì´ë¦„ìˆœ
      return users.sort(
        (a,b)=>(b.coin_balance||0)-(a.coin_balance||0) || (a.name||'').localeCompare(b.name||'')
      );
    } else {
      // ë ˆë²¨ â†’ XP ë‚´ë¦¼ì°¨ìˆœ, ë™ì ì ì´ë¦„ìˆœ
      return users.sort(
        (a,b)=>(b.level||0)-(a.level||0) || (b.xp||0)-(a.xp||0) || (a.name||'').localeCompare(b.name||'')
      );
    }
  }

  async function loadRanking(){
    const metric = selMetric.value;           // 'coin' | 'level'
    const scope  = selScope.value;            // 'class' | 'grade' | 'school'

    // ë‚´ ì •ë³´ (ì •ë ¬ í›„ 'ë‚´ ìˆœìœ„' í‘œì‹œì— ì‚¬ìš©)
    const myUsername = localStorage.getItem('savedUsername') || '';
    const g = (typeof currentGrade === 'number'
                ? currentGrade
                : parseInt(localStorage.getItem('savedGrade')||'0',10)) || null;
    const c = (typeof currentClassNum === 'number'
                ? currentClassNum
                : parseInt(localStorage.getItem('savedClassNum')||'0',10)) || null;

    // ë¡œë”© í‘œì‹œ
    ul.innerHTML = `<li style="padding:10px;color:#6b7280">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li>`;
    meEl.style.display = 'none';

    // ê¸°ë³¸ ì¿¼ë¦¬ (ê´€ë¦¬ì ì œì™¸)
    let q = supabaseClient.from('users')
      .select('username,name,grade,class_num,student_number,coin_balance,level,xp,role', { count: 'exact' })
      .neq('role','admin');

    // ë²”ìœ„ ì œí•œ: í•™ìƒì€ ê°•ì œ 'ê°™ì€ ë°˜', ê´€ë¦¬ìëŠ” ì„ íƒê°’ ë°˜ì˜
    if (typeof currentUserRole === 'string' && currentUserRole !== 'admin') {
      if (g!=null) q = q.eq('grade', g);
      if (c!=null) q = q.eq('class_num', c);
    } else {
      if (scope === 'class') { if (g!=null) q = q.eq('grade', g); if (c!=null) q = q.eq('class_num', c); }
      else if (scope === 'grade') { if (g!=null) q = q.eq('grade', g); }
      // 'school' = ì „êµ (ì œí•œ ì—†ìŒ)
    }

    const { data, error } = await q;

    if (error) {
      ul.innerHTML = `<li style="padding:10px;color:#ef4444">ë­í‚¹ ë¡œë“œ ì˜¤ë¥˜: ${escapeHtml(error.message)}</li>`;
      return;
    }

    const users = Array.isArray(data) ? data.slice() : [];
    if (users.length === 0) {
      ul.innerHTML = `<li style="padding:10px;color:#6b7280">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
      return;
    }

    const sorted = sortUsers(users, metric);

    // Top N ë Œë”
    const N = 10;
    ul.innerHTML = '';
    sorted.slice(0, N).forEach((u, i) => {
      ul.insertAdjacentHTML('beforeend', rowHtml(i+1, u, metric));
    });

    // ë‚´ ìˆœìœ„ ë°•ìŠ¤
    const myIndex = sorted.findIndex(u => (u.username||'') === myUsername);
    if (myIndex >= 0) {
      meEl.innerHTML = meHtml(myIndex+1, sorted.length, sorted[myIndex], metric);
      meEl.style.display = 'block';
    } else {
      meEl.style.display = 'none';
    }
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  selMetric.addEventListener('change', loadRanking);
  selScope.addEventListener('change', loadRanking);
  btnRefresh.addEventListener('click', loadRanking);
  document.addEventListener('DOMContentLoaded', loadRanking);

  // ì™¸ë¶€ì—ì„œ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ê°€ëŠ¥
  window.reloadRankingCard = loadRanking;
})();


(() => {
  // ì„œìš¸ ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ
  const seoulNow = () => new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
  const toYMD = d => {
    const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,"0"), dd = String(d.getDate()).padStart(2,"0");
    return `${y}${m}${dd}`;
  };
  const labelYMD = d => `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,"0")}.${String(d.getDate()).padStart(2,"0")}`;

  // ë©”ë‰´ ë¬¸ìì—´ ì •ë¦¬
  function parseDishList(ddish="") {
    return String(ddish)
      .replace(/<br\s*\/?>/gi, "\n")
      .split(/\n+/)
      .map(s => s.replace(/\((?:\s*\d+\s*\.)+\s*\)/g,"").trim())
      .filter(Boolean);
  }

  function renderMeal(dateObj, rows) {
    const box = document.getElementById("meal-box");
    const dayLabel = labelYMD(dateObj);

    if (!rows || rows.length===0) {
      box.innerHTML = `<div style="color:#6b7280">ğŸ½ï¸ ${dayLabel} ê¸‰ì‹ ì •ë³´ ì—†ìŒ</div>`;
      return;
    }

    // ì¡°ì‹/ì¤‘ì‹/ì„ì‹ë³„ë¡œ ë¬¶ê¸°
    const byType = rows.reduce((m,r)=>{
      (m[r.MMEAL_SC_NM] ??= []).push(...parseDishList(r.DDISH_NM));
      return m;
    },{});
    const order = ["ì¡°ì‹","ì¤‘ì‹","ì„ì‹"];
    const types = Object.keys(byType).sort((a,b)=>{
      const ia=order.indexOf(a), ib=order.indexOf(b);
      return (ia===-1?99:ia) - (ib===-1?99:ib);
    });

    box.innerHTML = `
      <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
        <strong>ì˜¤ëŠ˜ ê¸‰ì‹</strong>
        <span style="color:#6b7280;font-size:.9rem">${dayLabel}</span>
      </div>
      ${types.map(type=>`
        <div style="margin-bottom:8px;">
          <div style="font-weight:600;margin-bottom:4px;">${type}</div>
          <ul style="margin:0;padding-left:18px;color:#374151;">
            ${byType[type].map(d=>`<li>${d}</li>`).join("")}
          </ul>
        </div>
      `).join("")}
    `;
  }

  // ğŸ½ï¸ ê¸‰ì‹ ë¶ˆëŸ¬ì˜¤ê¸° (NEIS ìƒìˆ˜ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
  async function loadMeal(forDate) {
    const d = forDate ? new Date(forDate) : seoulNow();
    const url = `https://open.neis.go.kr/hub/mealServiceDietInfo`
      + `?KEY=${encodeURIComponent(NEIS_KEY)}&Type=json`
      + `&ATPT_OFCDC_SC_CODE=${encodeURIComponent(ATPT_OFCDC_SC_CODE)}`
      + `&SD_SCHUL_CODE=${encodeURIComponent(SD_SCHUL_CODE)}`
      + `&MLSV_YMD=${toYMD(d)}`;

    try {
      const res = await fetch(url);
      const json = await res.json();
      const block = json && json.mealServiceDietInfo && json.mealServiceDietInfo[1];
      renderMeal(d, block ? block.row : []);
    } catch(e) {
      document.getElementById("meal-box").innerHTML =
        `<div style="color:#ef4444">ê¸‰ì‹ ë¡œë”© ì˜¤ë¥˜</div>`;
      console.error(e);
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ê¸‰ì‹
  document.addEventListener("DOMContentLoaded", ()=> loadMeal());
  // í•„ìš” ì‹œ ì™¸ë¶€ì—ì„œ ë‹¤ì‹œ í˜¸ì¶œ ê°€ëŠ¥
  window.reloadMealCard = loadMeal;
})();
    </script>
  </body> 
</html>

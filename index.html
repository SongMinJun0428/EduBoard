<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduBoard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
  <style>
    /* ===== 공통 ===== */
    body {
      margin: 0;
      font-family: 'Noto Sans KR', sans-serif;
      background: #f8f9fa;
      color: #333;
    }
    header {
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      color: #007bff;
    }
    #profile-icon {
      cursor: pointer;
      font-size: 1.3rem;
      margin-left: 1rem;
    }
    nav {
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 0.75rem;
    }
    nav a {
      text-decoration: none;
      color: #495057;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
    }
    nav a:hover {
      background: #e9ecef;
      color: #007bff;
    }
    .content {
      padding: 2rem;
      max-width: 1000px;
      margin: auto;
    }
    .panel {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    button {
      background: #007bff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background: #0056b3;
    }
    input[type=text],
    input[type=password],
    input[type=email],
    input[type=number],
    textarea {
      display: block;
      width: 100%;
      height: 40px;
      padding: 0 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      margin-bottom: 0.8rem;
      font-size: 0.95rem;
      background: #fff;
      box-sizing: border-box;
    }
    textarea {
      height: 80px;
      padding: 0.6rem;
    }
    #login-screen {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #ffffff;
    }
    .auth-box {
      background: #fff;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 320px;
      text-align: center;
    }
    .auth-box h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #007bff;
    }
    /* 문서 분석 패널 내부 전용 스타일 */
    #doc-panel h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
      color: #343a40;
    }

    #doc-panel input[type="file"] {
      margin-bottom: 0.8rem;
    }

    #doc-panel h3 {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      color: #495057;
      border-top: 1px solid #dee2e6;
      padding-top: 0.8rem;
    }

    #doc-panel textarea {
      width: 100%;
      min-height: 150px;
      resize: vertical;
      font-size: 0.95rem;
      line-height: 1.4rem;
      padding: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 0.5rem;
      background: #fdfdfd;
      margin-bottom: 1rem;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }

    /* 버튼들을 나란히 두고 싶다면 flex */
    #doc-panel .button-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    #doc-panel .button-group button {
      flex: 1;
    }

    /* 버튼 색상 개선 */
    #doc-panel button {
      background: #007bff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.6rem 1rem;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    #doc-panel button:hover {
      background: #0056b3;
    }

    #doc-result {
      width: 100%;
      min-height: 100px;       /* 최소 높이 */
      resize: none;            /* 수동 크기조절 비활성화 */
      overflow: hidden;        /* 넘치는 스크롤 제거 */
      font-size: 0.95rem;
      line-height: 1.4rem;
      padding: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 0.5rem;
      background: #fdfdfd;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }

    #homework-panel label {
      font-weight: 600;
      margin-top: 0.5rem;
      display: block;
      margin-bottom: 0.3rem;
      color: #495057;
    }

    #homework-panel input[type="text"],
    #homework-panel input[type="file"],
    #homework-panel textarea {
      display: block;
      width: 100%;
      padding: 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      font-size: 0.95rem;
      margin-bottom: 1rem;
      background: #fff;
      box-sizing: border-box;
    }

    #homework-panel textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* 📱 태블릿 이하 (768px 이하) */
    @media (max-width: 768px) {
      body {
        background: #ffffff;
        font-size: 15px;
        line-height: 1.6;
      }

      header {
        flex-direction: column;
        align-items: center;
        padding: 16px;
        background: #2563eb;
      }

      header h1 {
        font-size: 24px;
        color: #fff;
        margin-bottom: 12px;
      }

      header .logout {
        background: #ffffff;
        color: #2563eb;
        border: none;
        padding: 10px 16px;
        border-radius: 12px;
        font-size: 16px;
        width: 100%;
      }

      /* 메뉴를 세로 리스트처럼 */
      .menu {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        padding: 12px;
        background: #f0f4ff;
      }

      .menu-item {
        flex: 1 1 40%;
        background: #ffffff;
        border: 1px solid #ccc;
        padding: 12px;
        text-align: center;
        font-size: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      }

      /* 카드 스타일을 모바일 전용으로 큼직하게 */
      .card {
        max-width: none;
        margin: 16px;
        padding: 20px;
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }

      .card h2 {
        font-size: 20px;
        margin-bottom: 12px;
      }

      .card p {
        font-size: 15px;
        margin-bottom: 16px;
      }

      .card button {
        display: block;
        width: 100%;
        background: #2563eb;
        color: #fff;
        padding: 14px 0;
        font-size: 16px;
        border-radius: 12px;
        margin-top: 12px;
        border: none;
      }

      .card textarea {
        width: 100%;
        padding: 14px;
        font-size: 15px;
        border: 1px solid #ccc;
        border-radius: 12px;
        resize: vertical;
        margin-bottom: 12px;
      }
      }
      /* 햄버거 기본 숨김 체크박스 */
        /* 햄버거 기본 숨김 */
        #menu-toggle {
          display: none;
          }

          /* 기본 PC 메뉴 */
          #main-nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 0.75rem;
          }

          /* 햄버거 스타일 */
          .hamburger {
            display: none; /* PC에서는 안보이게 */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
            margin-left: 10px;
          }
          .hamburger span {
            width: 20px;
            height: 3px;
            background: #333;
            border-radius: 2px;
            transition: all 0.3s ease;
          }

          /* 📱 모바일에서 메뉴 숨기기 & 햄버거 보이기 */
          @media (max-width: 768px) {
            #main-nav {
              display: none;
              flex-direction: column;
              position: absolute;
              top: 70px;
              right: 16px;
              background: #fff;
              width: 200px;
              border-radius: 12px;
              box-shadow: 0 4px 8px rgba(0,0,0,0.1);
              padding: 12px;
              z-index: 1000;
            }
            #main-nav a {
              padding: 12px;
              color: #333;
              text-decoration: none;
              border-bottom: 1px solid #eee;
            }
            #main-nav a:last-child {
              border-bottom: none;
            }

            .hamburger {
              display: flex; /* 모바일에서만 보이기 */
            }

            /* 체크박스가 체크되면 메뉴 표시 */
            #menu-toggle:checked ~ nav#main-nav {
              display: flex;
            }

            /* 햄버거 X자 애니메이션 */
            #menu-toggle:checked + .hamburger span:nth-child(1) {
              transform: rotate(45deg) translate(5px, 5px);
            }
            #menu-toggle:checked + .hamburger span:nth-child(2) {
              opacity: 0;
            }
            #menu-toggle:checked + .hamburger span:nth-child(3) {
              transform: rotate(-45deg) translate(5px, -5px);
            }
          }
  </style>
</head>

<body>
  <!-- 로그인/회원가입 -->
  <div id="login-screen">
    <div class="auth-box" id="login-box">
      <h2>로그인</h2>
      <input id="loginUsername" type="text" placeholder="아이디">
      <input id="loginPassword" type="password" placeholder="비밀번호">
      <button onclick="loginDirect()">로그인</button>
      <p style="font-size:0.85rem;">
        아이디가 없으신가요? <a href="#" onclick="showSignup()">회원가입</a>
      </p>
      <div id="loginStatus" style="font-size:0.85rem;color:red;"></div>
    </div>

    <!-- 📌 회원가입 박스 -->
<div class="auth-box" id="signup-box" style="display:none;">
  <h2>회원가입</h2>

  <!-- 개인정보 수집·이용 동의 -->
  <div style="
    text-align:left;
    font-size:0.8rem;
    margin:0.5rem 0;
    border:1px solid #ddd;
    padding:0.6rem;
    border-radius:0.5rem;
    background:#f8f9fa;">
    <p style="margin:0 0 0.4rem 0; font-weight:bold;">📌 개인정보 수집·이용 동의</p>
    <p style="margin:0 0 0.3rem 0; line-height:1.4;">
      수집 항목: 아이디, 비밀번호, 이름, 학년, 반, 번호<br>
      이용 목적: EduBoard 회원 관리 및 수업 자료 제공<br>
      보유 기간: 회원 탈퇴 시까지 (법령에 따라 보관 필요 시 해당 기간 보존)<br>
      동의 거부 시 회원가입이 제한됩니다.
    </p>
    <label style="display:flex;align-items:center;font-weight:600;">
      <input type="checkbox" id="privacy-agree" style="margin-right:0.4rem;">
      위 개인정보 수집·이용에 동의합니다.
    </label>
  </div>

  <!-- 입력 폼 -->
  <input id="signupUsername" type="text" placeholder="아이디">
  <input id="signupPassword" type="password" placeholder="비밀번호 (6자 이상)">
  <input id="signupEmail" type="email" placeholder="이메일">
  <input id="signupName" type="text" placeholder="이름">
  <input id="signupGrade" type="number" placeholder="학년">
  <input id="signupClass" type="number" placeholder="반">
  <input id="signupNumber" type="number" placeholder="번호">

  <!-- 회원가입 버튼 (동의 시 보이도록) -->
  <button id="signup-btn" onclick="signup()" style="display:none;">회원가입 완료</button>

  <p style="font-size:0.85rem;">
    <a href="#" onclick="showLogin()">← 로그인으로 돌아가기</a>
  </p>
  <div id="signupStatus" style="font-size:0.85rem;color:red;"></div>
</div>

<script>
  // ✅ 약관 동의 시 버튼 보이기
  document.addEventListener('DOMContentLoaded', () => {
    const agree = document.getElementById('privacy-agree');
    const btn = document.getElementById('signup-btn');
    agree.addEventListener('change', () => {
      btn.style.display = agree.checked ? 'block' : 'none';
    });
  });
</script>

  </div>

  <!-- 메인 앱 -->
  <div id="main-app" style="display:none;">
    <header>
      <h1>EduBoard</h1>
      <div style="display:flex;align-items:center; gap:10px;">
        <button onclick="logout()">로그아웃</button>
        <span id="profile-icon">👤</span>
      </div>
    </header>

    <input type="checkbox" id="menu-toggle">
    <label for="menu-toggle" class="hamburger">
      <span></span>
      <span></span>
      <span></span>
    </label>

    <nav id="main-nav">
      <a href="#" onclick="showPanel('notice-panel')">공지사항</a>
      <a href="#" onclick="showPanel('doc-panel')">문서 분석</a>
      <!-- <a href="#" onclick="showPanel('student-panel')">학생 관리</a> -->
      <a href="#" onclick="showPanel('homework-panel')">파일 공유 & 자료실</a>
      <!-- <a href="#" onclick="showPanel('chat-panel')">상담실</a> -->
      <a href="#" onclick="showPanel('timetable-panel')">시간표</a>
    </nav>

    <div class="content">
      <div id="notice-panel" class="panel" style="display:none;">
        <h2>📢 공지사항</h2>
        <div id="notice-list"></div>
        <h3>새 공지 등록</h3>
        <input type="text" id="notice-title" placeholder="제목"/>
        <textarea id="notice-content" placeholder="내용"></textarea>
        <!-- 사진 파일 선택 -->
        <input type="file" id="notice-image" accept="image/*">

        <!-- 사진 업로드 여부 선택 -->
        <label style="display:flex;align-items:center;margin-top:0.5rem;">
          <input type="checkbox" id="notice-upload-check" style="margin-right:0.5rem;">
          이 사진을 공지에 포함하기
        </label>
        <button onclick="addNotice()">공지 추가</button>
      </div>

      <div id="doc-panel" class="panel">
        <h2>📄 문서 업로드</h2>
        <input type="file" id="doc-file" accept=".pdf,.jpg,.png"/>
        <div class="button-group">
          <button onclick="analyzeDocument()">문서 분석하기</button>
        </div>

        <h3>분석 결과 (수정 가능)</h3>
          <textarea 
            id="doc-result"
            placeholder="분석된 내용이 여기에 표시됩니다. 필요하면 수정 후 등록하세요."
            style="
              min-height:100px;
              resize:none;
              overflow:hidden;
              width:100%;
              padding:0.8rem;
              font-size:0.95rem;
              line-height:1.4rem;
              border:1px solid #ced4da;
              border-radius:0.5rem;
              background:#fdfdfd;
              box-shadow:inset 0 1px 2px rgba(0,0,0,0.04);
            ">
          </textarea>



        
        <!-- 사진 미리보기 -->
        <img id="doc-preview" style="max-width:100%; margin-top:1rem; display:none; border-radius:0.5rem;" />

        <!-- 업로드 여부 선택 -->
        <label style="display:flex;align-items:center;margin-top:0.5rem;">
          <input type="checkbox" id="upload-image-check" style="margin-right:0.5rem;">
          이 사진을 공지에 같이 올리기
        </label>

        <div class="button-group">
          <button onclick="registerAnalyzedText()">분석된 글 등록하기</button>
        </div>
      </div>



      <div id="student-panel" class="panel" style="display:none;">
        <h2>👩‍🎓 학생 관리</h2>
        <button onclick="loadStudents()">학생 목록 불러오기</button>
        <ul id="student-list"></ul>
      </div>

      <div id="homework-panel" class="panel" style="display:none;">
        <h2>📚 파일 공유 & 자료실</h2>
        
        <!-- 업로드 영역 -->
        <label for="homework-scope">공유 범위</label>
        <select id="homework-scope">
          <option value="school">전교</option>
          <option value="grade">같은 학년</option>
          <option value="class">같은 반</option>
        </select>

        <label for="homework-userinfo">학번 + 이름</label>
        <input type="text" id="homework-userinfo" readonly style="background:#f1f3f5; font-weight:bold; margin-bottom:0.8rem;">

        <label for="homework-title">제목</label>
        <input type="text" id="homework-title" placeholder="예: 체험학습 사진">

        <label for="homework-file">파일 업로드</label>
        <input type="file" id="homework-file">

        <label for="homework-comment">코멘트 (선택)</label>
        <textarea id="homework-comment" placeholder="코멘트를 입력해 주세요"></textarea>

        <button onclick="submitHomework()">업로드하기</button>
        <div id="homework-status" style="margin-top:0.5rem;font-size:0.9rem;color:#007bff;"></div>

        <hr style="margin:1.5rem 0;">

        <!-- 자료 목록 영역 -->
        <h3>📂 업로드된 자료</h3>
        <button onclick="loadMaterials()">🔄 목록 새로고침</button>
        <ul id="material-list" style="margin-top:1rem;"></ul>
      </div>



      <div id="chat-panel" class="panel" style="display:none;">
        <h2>💬 상담실</h2>
        <div id="chat-box" style="border:1px solid #ccc; height:200px; overflow-y:auto; padding:0.5rem; margin-bottom:0.5rem;"></div>
        <input type="text" id="chat-input" placeholder="메시지를 입력하세요"/>
        <button onclick="sendChat()">보내기</button>
      </div>

      <div id="profile-panel" class="panel" style="display:none;">
        <h2>내 정보 수정</h2>
        <input type="text" id="update-name" placeholder="이름 수정">
        <input type="password" id="update-password" placeholder="비밀번호 수정">
        <button onclick="updateProfile()">수정하기</button>
        <button onclick="showPanel('doc-panel')">← 돌아가기</button>
      </div>

      <div id="admin-panel" class="panel" style="display:none;">
        <h2>⚙️ 관리자 설정</h2>
        <input type="text" id="admin-user-id" placeholder="사용자 ID"/>
        <select id="admin-role">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
        <button onclick="changeRole()">권한 변경</button>
        <button onclick="deleteUser()">사용자 삭제</button>
        <div id="admin-status" style="margin-top:0.5rem;"></div>
      </div>

      <!-- ✅ 시간표 패널 -->
      <!-- ✅ 시간표 패널 (EduBoard 스타일 맞춤) -->
      <div id="timetable-panel" class="panel" style="display:none;">
        <h2>🗓️ 나의 시간표</h2>
        <p style="margin-bottom:1rem; color:#495057; font-size:0.95rem;">
          봉담중학교 / 로그인한 학년·반 기준 시간표를 아래에서 확인하세요.
        </p>

        <!-- 상단 정보 영역 -->
        <div id="timetable-info" style="
              display:flex;
              justify-content:space-between;
              align-items:center;
              background:#f1f3f5;
              padding:0.75rem 1rem;
              border-radius:0.5rem;
              margin-bottom:1rem;
              font-size:0.9rem;
              color:#333;">
          <span id="timetable-grade-info">학년/반 정보 불러오는 중...</span>
          <button onclick="reloadTimetable()" style="
              background:#007bff;
              border:none;
              border-radius:0.5rem;
              padding:0.4rem 0.8rem;
              color:#fff;
              font-weight:600;
              cursor:pointer;">
            🔄 새로고침
          </button>
        </div>

        <!-- ✅ 시간표 UI 컨테이너 -->
        <div id="timetable-container"
            style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;">
        </div>
      </div>



      <!-- ✅ 자료실 패널 -->
      <div id="materials-panel" class="panel" style="display:none;">
        <h2>📂 자료실</h2>
        <input type="file" id="material-file">
        <button onclick="uploadMaterial()">업로드</button>
        <div id="material-status" style="margin-top:0.5rem;"></div>
        <h3>자료 목록</h3>
        <ul id="material-list"></ul>
        <button onclick="loadMaterials()">목록 불러오기</button>
      </div>
    </div>
  </div>

<script>
  const { createClient } = supabase;
  const supabaseClient = createClient(
    'https://ucmzrkwrsezfdjnnwsww.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjbXpya3dyc2V6ZmRqbm53c3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NDIzODcsImV4cCI6MjA2ODQxODM4N30.rvLItmDStjWb3GfECnCXocHvj-CMTfHfD1CHsAHOLaw'
  );

  let currentUserRole = 'user';

  let currentUserName = '';
  let currentStudentNumber = '';

  async function loginDirect() {
    const username = document.getElementById('loginUsername').value.replace(/\s+/g, '');
    const password = document.getElementById('loginPassword').value.replace(/\s+/g, '');

    const { data: user } = await supabaseClient
      .from('users')
      .select('*')
      .eq('username', username)
      .eq('password', password)
      .single();

    if (user) {
      currentUserName = user.name;
      currentStudentNumber = user.student_number;

      // ✅ localStorage 에 저장
      localStorage.setItem('savedUsername', username);
      localStorage.setItem('savedName', currentUserName);
      localStorage.setItem('savedStudentNum', currentStudentNumber);

      // 화면에 표시
      setUserInfoInput();

      currentUserRole = user.role || 'user';
      currentGrade = user.grade;
      currentClassNum = user.class_num;

      loadTimetableWeek(user.grade, user.class_num);
      showMain();
      loadNotices();
    } else {
      document.getElementById('loginStatus').innerText = '아이디 또는 비밀번호가 틀렸습니다.';
    }
  }

  // ✅ 로그인 없이도 새로고침 시 저장된 이름/학번을 불러와서 표시
  window.addEventListener('DOMContentLoaded', () => {
    const savedName = localStorage.getItem('savedName');
    const savedNum = localStorage.getItem('savedStudentNum');
    if (savedName && savedNum) {
      currentUserName = savedName;
      currentStudentNumber = savedNum;
      setUserInfoInput();
    }
  });

  function setUserInfoInput() {
    const inputEl = document.getElementById('homework-userinfo');
    if (inputEl) {
      inputEl.value = `${currentStudentNumber}번 ${currentUserName}`;
    }
  }


  async function signup() {
    const username = document.getElementById('signupUsername').value.trim();
    const password = document.getElementById('signupPassword').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const name = document.getElementById('signupName').value.trim();
    const grade = document.getElementById('signupGrade').value.trim();
    const classNum = document.getElementById('signupClass').value.trim();
    const number = document.getElementById('signupNumber').value.trim();
    const agree = document.getElementById('privacy-agree').checked;

    // ✅ 입력값 검증
    if (!agree) {
      document.getElementById('signupStatus').innerText = '개인정보 수집·이용에 동의해 주세요.';
      return;
    }
    if (!username || !password || !email || !name || !grade || !classNum || !number) {
      document.getElementById('signupStatus').innerText = '모든 항목을 입력해 주세요.';
      return;
    }
    if (password.length < 6) {
      document.getElementById('signupStatus').innerText = '비밀번호는 6자 이상이어야 합니다.';
      return;
    }
    // 이메일 형식 검증 (간단)
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      document.getElementById('signupStatus').innerText = '올바른 이메일을 입력해 주세요.';
      return;
    }

    // ✅ 여기에서 실제 DB로 전송 (Supabase 예시)
    try {
      const { error } = await supabaseClient.from('users').insert([{
        username: username,
        password: password,
        email: email,
        name: name,
        grade: parseInt(grade, 10),
        class_num: parseInt(classNum, 10),
        student_number: parseInt(number, 10),
        role: 'user'
      }]);
      if (error) {
        document.getElementById('signupStatus').innerText = '회원가입 실패: ' + error.message;
        return;
      }
      document.getElementById('signupStatus').style.color = 'green';
      document.getElementById('signupStatus').innerText = '회원가입이 완료되었습니다. 로그인해 주세요.';
    } catch (e) {
      document.getElementById('signupStatus').innerText = '오류 발생: ' + e.message;
    }
  }

  function showMain() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    setupAdminNav();
  }

  function showSignup() {
    document.getElementById('login-box').style.display = 'none';
    document.getElementById('signup-box').style.display = 'block';
  }

  function showLogin() {
    document.getElementById('login-box').style.display = 'block';
    document.getElementById('signup-box').style.display = 'none';
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    localStorage.removeItem('savedUsername'); // ✅ 로그아웃 시 저장된 아이디 삭제
    document.getElementById('main-app').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
  }

  async function updateProfile() {
    const newName = document.getElementById('update-name').value;
    const newPass = document.getElementById('update-password').value;

    if (newPass) {
      const { error } = await supabaseClient.auth.updateUser({ password: newPass });
      if (error) alert('비밀번호 수정 오류:' + error.message);
      else alert('비밀번호 수정 완료!');
    }
    if (newName) {
      const user = await supabaseClient.auth.getUser();
      if (user && user.data.user) {
        await supabaseClient.from('users').update({ name: newName }).eq('id', user.data.user.id);
        alert('이름 수정 완료!');
      }
    }
  }

function showPanel(panelId) {
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  document.getElementById(panelId).style.display = 'block';
}

document.getElementById('profile-icon').addEventListener('click', () => {
  showPanel('profile-panel');
});

supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
  if (session) {
    const { data: user } = await supabaseClient
      .from('users')
      .select('role')
      .eq('id', session.user.id)
      .single();
    if (user) currentUserRole = user.role;
    showMain();
  } else {
    showLogin();
  }
});

function setupAdminNav() {
  if (currentUserRole === 'admin') {
    if (!document.getElementById('admin-nav')) {
      const nav = document.getElementById('main-nav');
      const a = document.createElement('a');
      a.href = '#';
      a.id = 'admin-nav';
      a.innerText = '관리자 설정';
      a.onclick = () => { showPanel('admin-panel'); };
      nav.appendChild(a);
    }
  }
}

// ===== 공지사항 등록 (이미지 업로드 추가) =====
async function addNotice() {
  const title = document.getElementById('notice-title').value.trim();
  const content = document.getElementById('notice-content').value.trim();
  const fileInput = document.getElementById('notice-image');
  const uploadChecked = document.getElementById('notice-upload-check').checked;

  if (!title || !content) {
    alert('제목과 내용을 입력해 주세요.');
    return;
  }

  let imageUrl = '';

  if (uploadChecked && fileInput.files.length) {
    const file = fileInput.files[0];
    const uniqueName = Date.now() + '_' + file.name;
    const filePath = `public/${uniqueName}`;

    const { error: uploadErr } = await supabaseClient
      .storage
      .from('notice-images')
      .upload(filePath, file, { upsert: true });

    if (uploadErr) {
      alert('이미지 업로드 실패: ' + uploadErr.message);
      return;
    }

    const { data: publicData } = supabaseClient
      .storage
      .from('notice-images')
      .getPublicUrl(filePath);

    imageUrl = publicData.publicUrl;
  }

  // ✅ 현재 로그인한 사용자 정보 가져오기
  const { data: writerData, error: writerError } = await supabaseClient
    .from('users')
    .select('username,name,role,grade,class_num')
    .eq('username', localStorage.getItem('savedUsername'))
    .single();

  if (writerError || !writerData) {
    alert('사용자 정보 확인 중 오류가 발생했습니다.');
    return;
  }

  // ✅ 테이블에 등록할 데이터
  const newNotice = {
    title: title,
    content: content,
    image_url: imageUrl,
    writer: writerData.name,        // 작성자 이름
    writer_role: writerData.role,   // 작성자 역할
    grade: writerData.grade,        // 작성자 학년
    class_num: writerData.class_num // 작성자 반
  };

  const { error } = await supabaseClient.from('notices').insert([ newNotice ]);
    if (error) {
      alert('공지 등록 실패: ' + error.message);
      return;
    }

    alert('공지 등록 완료!');
    document.getElementById('notice-title').value = '';
    document.getElementById('notice-content').value = '';
    document.getElementById('notice-image').value = '';
    document.getElementById('notice-upload-check').checked = false;

    loadNotices();
  }

  // ===== 공지사항 목록 불러오기 (중복 제거 + 이미지 표시) =====
  async function loadNotices() {
    let query = supabaseClient.from('notices').select('*').order('id', { ascending: false });

    if (currentUserRole !== 'admin') {
      // ✅ 학생이라면 같은 학년/반 & 어드민이 올린 글 제외
      query = query
        .eq('grade', currentGrade)
        .eq('class_num', currentClassNum)
        .neq('writer_role', 'admin');
    }
    // ✅ admin이면 모든 공지를 그대로 불러옴

    const { data, error } = await query;

    if (error) {
      console.error('공지 불러오기 실패:', error);
      return;
    }

    const listEl = document.getElementById('notice-list');
    listEl.innerHTML = '';

    data.forEach(item => {
      const formattedContent = item.content.replace(/\n/g, '<br>');
      const div = document.createElement('div');
      div.style.borderBottom = '1px solid #ddd';
      div.style.padding = '0.5rem 0';
      // 누가 올린 글인지 표시
      div.innerHTML = `<strong>${item.title}</strong> <span style="font-size:0.8rem;color:#888;">(${item.writer})</span><br>${formattedContent}`;

      if (item.image_url) {
        div.innerHTML += `<br><img src="${item.image_url}" style="max-width:100%;margin-top:0.5rem;border-radius:0.5rem;">`;
      }

      listEl.appendChild(div);
    });
  }


// ===== 문서 분석(OCR) =====
async function analyzeDocument() {
  const fileInput = document.getElementById('doc-file');
  if (!fileInput.files.length) {
    alert('파일을 선택해 주세요.');
    return;
  }

  const file = fileInput.files[0];
  lastAnalyzedFile = file; // 분석한 파일을 저장
  document.getElementById('doc-preview').src = URL.createObjectURL(file);
  document.getElementById('doc-preview').style.display = 'block';

  document.getElementById('doc-result').value = '문서 분석 중... 잠시만 기다려 주세요.';

  const reader = new FileReader();
  reader.onload = () => {
    Tesseract.recognize(reader.result, 'kor', { logger: m => console.log(m) })
      .then(({ data: { text } }) => {
        document.getElementById('doc-result').value = text;
        autoResize();
        alert('문서 분석이 완료되었습니다. 아래 체크박스로 사진 업로드 여부를 선택 후 등록하세요.');
      })
      .catch(err => {
        console.error('OCR 오류:', err);
        document.getElementById('doc-result').value = '문서 분석 실패: ' + err.message;
      });
  };
  reader.readAsDataURL(file);
}


async function registerAnalyzedText() {
  const text = document.getElementById('doc-result').value.trim();
  if (!text) {
    alert('내용이 비어 있습니다.');
    return;
  }

  let imageUrl = '';
  const shouldUploadImage = document.getElementById('upload-image-check').checked;

  if (shouldUploadImage && lastAnalyzedFile) {
    const fileName = Date.now() + '_' + lastAnalyzedFile.name;
    const { error: uploadErr } = await supabaseClient
      .storage
      .from('notice-images')
      .upload(fileName, lastAnalyzedFile);

    if (uploadErr) {
      alert('이미지 업로드 실패: ' + uploadErr.message);
      return;
    }
    const { data: publicData } = supabaseClient
      .storage
      .from('notice-images')
      .getPublicUrl(fileName);
    imageUrl = publicData.publicUrl;
  }

  // ✅ 현재 로그인한 사용자 정보 가져오기
  const { data: writerData, error: writerError } = await supabaseClient
    .from('users')
    .select('username,name,role,grade,class_num')
    .eq('username', localStorage.getItem('savedUsername'))
    .single();

  if (writerError || !writerData) {
    alert('사용자 정보 확인 중 오류가 발생했습니다.');
    return;
  }

  // ✅ DB에 공지 등록 (문서 분석 결과)
  const { error } = await supabaseClient.from('notices').insert([{
    title: '문서 분석 등록',
    content: text,
    image_url: imageUrl,
    writer: writerData.name,
    writer_role: writerData.role,
    grade: writerData.grade,
    class_num: writerData.class_num
  }]);

  if (error) {
    alert('공지 등록 실패: ' + error.message);
    return;
  }

  alert('등록이 완료되었습니다!');
  loadNotices();

  // 초기화
  lastAnalyzedFile = null;
  document.getElementById('doc-file').value = '';
  document.getElementById('doc-preview').style.display = 'none';
  document.getElementById('upload-image-check').checked = false;
  document.getElementById('doc-result').value = '';
}


  const docResult = document.getElementById('doc-result');

  // 높이 자동 조정 함수
  function autoResize() {
    docResult.style.height = 'auto';  // 초기화
    docResult.style.height = docResult.scrollHeight + 'px'; // 내용에 맞게 늘림
  }

  // 사용자가 직접 입력할 때도 적용
  docResult.addEventListener('input', autoResize);

    async function submitHomework() {
      const scope = document.getElementById('homework-scope').value
    const name = document.getElementById('homework-name').value.trim();
    const title = document.getElementById('homework-title').value.trim();
    const comment = document.getElementById('homework-comment').value.trim();
    const fileInput = document.getElementById('homework-file');
    const statusEl = document.getElementById('homework-status');

    if (!name || !title || !fileInput.files.length) {
      alert('이름, 과제명, 파일을 모두 입력해 주세요.');
      return;
    }

    // Supabase 스토리지에 파일 업로드
    const file = fileInput.files[0];
    const fileName = Date.now() + '_' + file.name;

    let { error: uploadError } = await supabaseClient.storage
      .from('homework-files') // 스토리지 버킷 이름
      .upload(fileName, file);

    if (uploadError) {
      statusEl.style.color = 'red';
      statusEl.textContent = '파일 업로드 실패: ' + uploadError.message;
      return;
    }

    const { data: publicURLData } = supabaseClient
      .storage
      .from('homework-files')
      .getPublicUrl(fileName);

    const fileURL = publicURLData.publicUrl;

    // DB에 기록
    const { error: insertError } = await supabaseClient.from('homeworks').insert([{
      name: name,
      title: title,
      comment: comment,
      file_url: fileURL
    }]);

    if (insertError) {
      statusEl.style.color = 'red';
      statusEl.textContent = '제출 실패: ' + insertError.message;
      return;
    }

    statusEl.style.color = 'green';
    statusEl.textContent = '✅ 제출이 완료되었습니다!';
    
    loadMaterials();
    // 입력 초기화
    document.getElementById('homework-name').value = '';
    document.getElementById('homework-title').value = '';
    document.getElementById('homework-comment').value = '';
    document.getElementById('homework-file').value = '';
  }

  const NEIS_KEY = '1692c030b074479784fa252d2886f919';
  const ATPT_OFCDC_SC_CODE = 'J10'; // 경기도교육청
  const SD_SCHUL_CODE = '7679111';  // ✅ 봉담중학교 코드로 수정


  let currentGrade = null;
  let currentClassNum = null;

    // 📌 시간표 불러오기
      async function loadTimetableWeek(grade, classNum) {
        currentGrade = grade;
        currentClassNum = classNum;

        document.getElementById('timetable-grade-info').innerText = `${grade}학년 ${classNum}반 (주간)`;
        const container = document.getElementById('timetable-container');
        container.innerHTML = '<p>시간표 불러오는 중...</p>';

        const today = new Date();
        const day = today.getDay();
        const monday = new Date(today);
        monday.setDate(today.getDate() - (day === 0 ? 6 : day - 1));

        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        // ✅ 학기 구분: 7월까지는 1학기, 8월부터 2학기
        const semester = (month <= 8) ? 1 : 2;

        const dates = Array.from({ length: 5 }, (_, i) => {
          const d = new Date(monday);
          d.setDate(monday.getDate() + i);
          return `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
        });

        try {
          const results = await Promise.all(
            dates.map(async (dateStr) => {
              const url = `https://open.neis.go.kr/hub/misTimetable?KEY=${NEIS_KEY}&Type=json&ATPT_OFCDC_SC_CODE=${ATPT_OFCDC_SC_CODE}&SD_SCHUL_CODE=${SD_SCHUL_CODE}&AY=${year}&SEM=${semester}&ALL_TI_YMD=${dateStr}&GRADE=${grade}&CLASS_NM=${classNum}`;
              console.log(url);
              const res = await fetch(url);
              const data = await res.json();
              return { dateStr, data };
            })
          );

          container.innerHTML = '';

          for (const { dateStr, data } of results) {
            const dayBox = document.createElement('div');
            dayBox.style.border = '1px solid #ccc';
            dayBox.style.borderRadius = '8px';
            dayBox.style.padding = '8px';
            dayBox.style.background = '#fdfdfd';
            dayBox.style.marginBottom = '10px';

            const title = document.createElement('h4');
            title.innerText = `${dateStr.slice(0, 4)}-${dateStr.slice(4, 6)}-${dateStr.slice(6, 8)}`;
            dayBox.appendChild(title);

            if (data.misTimetable && data.misTimetable[1]) {
              const rows = data.misTimetable[1].row;
              rows.forEach(row => {
                const item = document.createElement('div');
                item.innerHTML = `<strong>${row.PERIO}교시</strong> : ${row.ITRT_CNTNT}`;
                dayBox.appendChild(item);
              });
            } else {
              const none = document.createElement('p');
              none.innerText = '시간표 데이터 없음';
              dayBox.appendChild(none);
            }

            container.appendChild(dayBox);
          }
        } catch (err) {
          console.error('주간 시간표 오류:', err);
          container.innerHTML = '<p>시간표를 불러오는 중 오류가 발생했습니다.</p>';
        }

        showPanel('timetable-panel');
      }

      // 📌 페이지 로드시 자동 로그인 확인
      window.addEventListener('DOMContentLoaded', async () => {
        const savedUsername = localStorage.getItem('savedUsername');

        if (savedUsername) {
          const { data: user, error } = await supabaseClient
            .from('users')
            .select('*')
            .eq('username', savedUsername)
            .maybeSingle();

          if (error) {
            console.error('자동 로그인 조회 오류:', error);
            showLogin();
            return;
          }

          if (user) {
            currentUserRole = user.role || 'user';
            currentGrade = user.grade;
            currentClassNum = user.class_num;

            await loadTimetableWeek(user.grade, user.class_num);
            showMain();
            loadNotices();
            return;
          }
        }

        showLogin();
      });




  window.addEventListener('DOMContentLoaded', async () => {
    // 👉 이전에 로그인한 아이디가 localStorage에 저장돼 있는지 확인
    const savedUsername = localStorage.getItem('savedUsername');

    if (savedUsername) {
      // Supabase에서 해당 사용자 정보 불러오기
      const { data: user, error } = await supabaseClient
        .from('users')
        .select('*')
        .eq('username', savedUsername)
        .maybeSingle();

      if (error) {
        console.error('자동 로그인 조회 오류:', error);
        showLogin();
        return;
      }

      if (user) {
        currentUserRole = user.role || 'user';
        currentGrade = user.grade;
        currentClassNum = user.class_num;

        // 로그인 성공 시
        loadTimetableWeek(user.grade, user.class_num);
        showMain();
        loadNotices();
        return; // 자동 로그인 성공했으므로 종료
      }
    }

    // 👉 저장된 아이디가 없거나 조회 실패 시 로그인 화면
    showLogin();
  });


  function setupAdminNav() {
    const existing = document.getElementById('admin-nav');

    if (currentUserRole === 'admin') {
      if (!existing) {
        const nav = document.getElementById('main-nav');
        const a = document.createElement('a');
        a.href = '#';
        a.id = 'admin-nav';
        a.innerText = '관리자 설정';
        a.onclick = () => { showPanel('admin-panel'); };
        nav.appendChild(a);
      }
    } else {
      if (existing) existing.remove();
    }
  }

  document.querySelectorAll('#main-nav a').forEach(link => {
    link.addEventListener('click', () => {
      document.getElementById('menu-toggle').checked = false; // ✅ 체크 해제 → 메뉴 닫힘
    });
  });

  function reloadTimetable() {
    if (currentGrade && currentClassNum) {
      loadTimetableWeek(currentGrade, currentClassNum);
    } else {
      alert('로그인 후 다시 시도해 주세요.');
    }
  }

  // 📂 자료실 목록 불러오기
// 📂 자료실 목록 불러오기
async function loadMaterials() {
  
  const { data, error } = await supabaseClient
    .from('homeworks')
    .select('*')
    .order('id', { ascending: false });

  const listEl = document.getElementById('material-list');
  listEl.innerHTML = '';

  if (error) {
    console.error('자료 불러오기 오류:', error);
    listEl.innerHTML = '<li>자료를 불러오는 중 오류가 발생했습니다.</li>';
    return;
  }

  if (!data || data.length === 0) {
    listEl.innerHTML = '<li>등록된 자료가 없습니다.</li>';
    return;
  }

  data.forEach(item => {
    // 제목과 작성자(학번+이름)
    const titleLine = `📌 ${item.title} (${item.grade}학년${item.class_num}반${item.student_number}번 ${item.name})`;

    // 코멘트(있다면)
    const commentHtml = item.comment
      ? `<p style="margin:6px 0;">${item.comment}</p>`
      : '';

    // 파일 다운로드 링크
    const fileHtml = `<a href="${item.file_url}" target="_blank"
      style="display:inline-block;margin-top:6px;color:#007bff;text-decoration:none;">
      📥 다운로드
    </a>`;

    // 이미지 파일이면 썸네일도 표시
    let imageHtml = '';
    if (item.file_url.match(/\.(jpg|jpeg|png|gif)$/i)) {
      imageHtml = `<div style="margin-top:8px;">
        <img src="${item.file_url}" style="max-width:200px;border-radius:8px;">
      </div>`;
    }

    // li 요소 생성
    const li = document.createElement('li');
    li.style.borderBottom = '1px solid #ddd';
    li.style.padding = '10px 0';
    li.innerHTML = `
      <div style="font-weight:bold;">${titleLine}</div>
      ${commentHtml}
      ${fileHtml}
      ${imageHtml}
    `;

    listEl.appendChild(li);
  });
}



async function submitHomework() {
  // ✅ 학번과 이름은 고정값 사용
  const name = currentUserName;
  const studentNum = currentStudentNumber;
  const title = document.getElementById('homework-title').value.trim();
  const comment = document.getElementById('homework-comment').value.trim();
  
  const fileInput = document.getElementById('homework-file');
  const statusEl = document.getElementById('homework-status');

  if (!name || !studentNum || !title || !fileInput.files.length) {
    alert('과제명과 파일을 모두 입력해 주세요.');
    return;
  }

  // ✅ Supabase 스토리지 업로드
  const file = fileInput.files[0];
  const fileName = Date.now() + '_' + file.name;

  let { error: uploadError } = await supabaseClient.storage
    .from('homework-files') // 스토리지 버킷 이름
    .upload(fileName, file);

  if (uploadError) {
    statusEl.style.color = 'red';
    statusEl.textContent = '파일 업로드 실패: ' + uploadError.message;
    return;
  }

  const { data: publicURLData } = supabaseClient
    .storage
    .from('homework-files')
    .getPublicUrl(fileName);

  const fileURL = publicURLData.publicUrl;

  // ✅ DB에 기록 (학번과 이름 포함)
  const { error: insertError } = await supabaseClient.from('homeworks').insert([{
    name: name,
    student_number: studentNum,
    title: title,
    grade: currentGrade,      
    class_num: currentClassNum, 
    comment: comment,
    file_url: fileURL,
    share_scope: scope 
  }]);

  if (insertError) {
    statusEl.style.color = 'red';
    statusEl.textContent = '제출 실패: ' + insertError.message;
    return;
  }

  statusEl.style.color = 'green';
  statusEl.textContent = '✅ 제출이 완료되었습니다!';

  // 입력 초기화
  document.getElementById('homework-title').value = '';
  document.getElementById('homework-comment').value = '';
  document.getElementById('homework-file').value = '';

  // 자료 목록 갱신
  loadMaterials();
}



  




</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduBoard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
  <style>
    /* ===== ê³µí†µ ===== */
    body {
      margin: 0;
      font-family: 'Noto Sans KR', sans-serif;
      background: #f8f9fa;
      color: #333;
    }
    header {
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      color: #007bff;
    }
    #profile-icon {
      cursor: pointer;
      font-size: 1.3rem;
      margin-left: 1rem;
    }
    nav {
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 0.75rem;
    }
    nav a {
      text-decoration: none;
      color: #495057;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
    }
    nav a:hover {
      background: #e9ecef;
      color: #007bff;
    }
    .content {
      padding: 2rem;
      max-width: 1000px;
      margin: auto;
    }
    .panel {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    button {
      background: #007bff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background: #0056b3;
    }
    input[type=text],
    input[type=password],
    input[type=email],
    input[type=number],
    textarea {
      display: block;
      width: 100%;
      height: 40px;
      padding: 0 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      margin-bottom: 0.8rem;
      font-size: 0.95rem;
      background: #fff;
      box-sizing: border-box;
    }
    textarea {
      height: 80px;
      padding: 0.6rem;
    }
    #login-screen {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #ffffff;
    }
    .auth-box {
      background: #fff;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 320px;
      text-align: center;
    }
    .auth-box h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #007bff;
    }
    /* ë¬¸ì„œ ë¶„ì„ íŒ¨ë„ ë‚´ë¶€ ì „ìš© ìŠ¤íƒ€ì¼ */
    #doc-panel h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
      color: #343a40;
    }

    #doc-panel input[type="file"] {
      margin-bottom: 0.8rem;
    }

    #doc-panel h3 {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      color: #495057;
      border-top: 1px solid #dee2e6;
      padding-top: 0.8rem;
    }

    #doc-panel textarea {
      width: 100%;
      min-height: 150px;
      resize: vertical;
      font-size: 0.95rem;
      line-height: 1.4rem;
      padding: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 0.5rem;
      background: #fdfdfd;
      margin-bottom: 1rem;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }

    /* ë²„íŠ¼ë“¤ì„ ë‚˜ë€íˆ ë‘ê³  ì‹¶ë‹¤ë©´ flex */
    #doc-panel .button-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    #doc-panel .button-group button {
      flex: 1;
    }

    /* ë²„íŠ¼ ìƒ‰ìƒ ê°œì„  */
    #doc-panel button {
      background: #007bff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.6rem 1rem;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    #doc-panel button:hover {
      background: #0056b3;
    }

    #doc-result {
      width: 100%;
      min-height: 100px;       /* ìµœì†Œ ë†’ì´ */
      resize: none;            /* ìˆ˜ë™ í¬ê¸°ì¡°ì ˆ ë¹„í™œì„±í™” */
      overflow: hidden;        /* ë„˜ì¹˜ëŠ” ìŠ¤í¬ë¡¤ ì œê±° */
      font-size: 0.95rem;
      line-height: 1.4rem;
      padding: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 0.5rem;
      background: #fdfdfd;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }

    #homework-panel label {
      font-weight: 600;
      margin-top: 0.5rem;
      display: block;
      margin-bottom: 0.3rem;
      color: #495057;
    }

    #homework-panel input[type="text"],
    #homework-panel input[type="file"],
    #homework-panel textarea {
      display: block;
      width: 100%;
      padding: 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      font-size: 0.95rem;
      margin-bottom: 1rem;
      background: #fff;
      box-sizing: border-box;
    }

    #homework-panel textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* ğŸ“± íƒœë¸”ë¦¿ ì´í•˜ (768px ì´í•˜) */
    @media (max-width: 768px) {
      body {
        background: #ffffff;
        font-size: 15px;
        line-height: 1.6;
      }

      header {
        flex-direction: column;
        align-items: center;
        padding: 16px;
        background: #2563eb;
      }

      header h1 {
        font-size: 24px;
        color: #fff;
        margin-bottom: 12px;
      }

      header .logout {
        background: #ffffff;
        color: #2563eb;
        border: none;
        padding: 10px 16px;
        border-radius: 12px;
        font-size: 16px;
        width: 100%;
      }

      /* ë©”ë‰´ë¥¼ ì„¸ë¡œ ë¦¬ìŠ¤íŠ¸ì²˜ëŸ¼ */
      .menu {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        padding: 12px;
        background: #f0f4ff;
      }

      .menu-item {
        flex: 1 1 40%;
        background: #ffffff;
        border: 1px solid #ccc;
        padding: 12px;
        text-align: center;
        font-size: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      }

      /* ì¹´ë“œ ìŠ¤íƒ€ì¼ì„ ëª¨ë°”ì¼ ì „ìš©ìœ¼ë¡œ í¼ì§í•˜ê²Œ */
      .card {
        max-width: none;
        margin: 16px;
        padding: 20px;
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }

      .card h2 {
        font-size: 20px;
        margin-bottom: 12px;
      }

      .card p {
        font-size: 15px;
        margin-bottom: 16px;
      }

      .card button {
        display: block;
        width: 100%;
        background: #2563eb;
        color: #fff;
        padding: 14px 0;
        font-size: 16px;
        border-radius: 12px;
        margin-top: 12px;
        border: none;
      }

      .card textarea {
        width: 100%;
        padding: 14px;
        font-size: 15px;
        border: 1px solid #ccc;
        border-radius: 12px;
        resize: vertical;
        margin-bottom: 12px;
      }
      }
      /* í–„ë²„ê±° ê¸°ë³¸ ìˆ¨ê¹€ ì²´í¬ë°•ìŠ¤ */
        /* í–„ë²„ê±° ê¸°ë³¸ ìˆ¨ê¹€ */
        #menu-toggle {
          display: none;
          }

          /* ê¸°ë³¸ PC ë©”ë‰´ */
          #main-nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 0.75rem;
          }

          /* í–„ë²„ê±° ìŠ¤íƒ€ì¼ */
          .hamburger {
            display: none; /* PCì—ì„œëŠ” ì•ˆë³´ì´ê²Œ */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
            margin-left: 10px;
          }
          .hamburger span {
            width: 20px;
            height: 3px;
            background: #333;
            border-radius: 2px;
            transition: all 0.3s ease;
          }

          /* ğŸ“± ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ ìˆ¨ê¸°ê¸° & í–„ë²„ê±° ë³´ì´ê¸° */
          @media (max-width: 768px) {
            #main-nav {
              display: none;
              flex-direction: column;
              position: absolute;
              top: 70px;
              right: 16px;
              background: #fff;
              width: 200px;
              border-radius: 12px;
              box-shadow: 0 4px 8px rgba(0,0,0,0.1);
              padding: 12px;
              z-index: 1000;
            }
            #main-nav a {
              padding: 12px;
              color: #333;
              text-decoration: none;
              border-bottom: 1px solid #eee;
            }
            #main-nav a:last-child {
              border-bottom: none;
            }

            .hamburger {
              display: flex; /* ëª¨ë°”ì¼ì—ì„œë§Œ ë³´ì´ê¸° */
            }

            /* ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ë©´ ë©”ë‰´ í‘œì‹œ */
            #menu-toggle:checked ~ nav#main-nav {
              display: flex;
            }

            /* í–„ë²„ê±° Xì ì• ë‹ˆë©”ì´ì…˜ */
            #menu-toggle:checked + .hamburger span:nth-child(1) {
              transform: rotate(45deg) translate(5px, 5px);
            }
            #menu-toggle:checked + .hamburger span:nth-child(2) {
              opacity: 0;
            }
            #menu-toggle:checked + .hamburger span:nth-child(3) {
              transform: rotate(-45deg) translate(5px, -5px);
            }
          }
  </style>
</head>

<body>
  <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… -->
  <div id="login-screen">
    <div class="auth-box" id="login-box">
      <h2>ë¡œê·¸ì¸</h2>
      <input id="loginUsername" type="text" placeholder="ì•„ì´ë””">
      <input id="loginPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
      <button onclick="loginDirect()">ë¡œê·¸ì¸</button>
      <p style="font-size:0.85rem;">
        ì•„ì´ë””ê°€ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" onclick="showSignup()">íšŒì›ê°€ì…</a>
      </p>
      <div id="loginStatus" style="font-size:0.85rem;color:red;"></div>
    </div>

    <!-- ğŸ“Œ íšŒì›ê°€ì… ë°•ìŠ¤ -->
<div class="auth-box" id="signup-box" style="display:none;">
  <h2>íšŒì›ê°€ì…</h2>

  <!-- ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ -->
  <div style="
    text-align:left;
    font-size:0.8rem;
    margin:0.5rem 0;
    border:1px solid #ddd;
    padding:0.6rem;
    border-radius:0.5rem;
    background:#f8f9fa;">
    <p style="margin:0 0 0.4rem 0; font-weight:bold;">ğŸ“Œ ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜</p>
    <p style="margin:0 0 0.3rem 0; line-height:1.4;">
      ìˆ˜ì§‘ í•­ëª©: ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸, ì´ë¦„, í•™ë…„, ë°˜, ë²ˆí˜¸<br>
      ì´ìš© ëª©ì : EduBoard íšŒì› ê´€ë¦¬ ë° ìˆ˜ì—… ìë£Œ ì œê³µ<br>
      ë³´ìœ  ê¸°ê°„: íšŒì› íƒˆí‡´ ì‹œê¹Œì§€ (ë²•ë ¹ì— ë”°ë¼ ë³´ê´€ í•„ìš” ì‹œ í•´ë‹¹ ê¸°ê°„ ë³´ì¡´)<br>
      ë™ì˜ ê±°ë¶€ ì‹œ íšŒì›ê°€ì…ì´ ì œí•œë©ë‹ˆë‹¤.
    </p>
    <label style="display:flex;align-items:center;font-weight:600;">
      <input type="checkbox" id="privacy-agree" style="margin-right:0.4rem;">
      ìœ„ ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.
    </label>
  </div>

  <!-- ì…ë ¥ í¼ -->
  <input id="signupUsername" type="text" placeholder="ì•„ì´ë””">
  <input id="signupPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
  <input id="signupEmail" type="email" placeholder="ì´ë©”ì¼">
  <input id="signupName" type="text" placeholder="ì´ë¦„">
  <input id="signupGrade" type="number" placeholder="í•™ë…„">
  <input id="signupClass" type="number" placeholder="ë°˜">
  <input id="signupNumber" type="number" placeholder="ë²ˆí˜¸">

  <!-- íšŒì›ê°€ì… ë²„íŠ¼ (ë™ì˜ ì‹œ ë³´ì´ë„ë¡) -->
  <button id="signup-btn" onclick="signup()" style="display:none;">íšŒì›ê°€ì… ì™„ë£Œ</button>

  <p style="font-size:0.85rem;">
    <a href="#" onclick="showLogin()">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </p>
  <div id="signupStatus" style="font-size:0.85rem;color:red;"></div>
</div>

<script>
  // âœ… ì•½ê´€ ë™ì˜ ì‹œ ë²„íŠ¼ ë³´ì´ê¸°
  document.addEventListener('DOMContentLoaded', () => {
    const agree = document.getElementById('privacy-agree');
    const btn = document.getElementById('signup-btn');
    agree.addEventListener('change', () => {
      btn.style.display = agree.checked ? 'block' : 'none';
    });
  });
</script>

  </div>

  <!-- ë©”ì¸ ì•± -->
  <div id="main-app" style="display:none;">
    <header>
      <h1>EduBoard</h1>
      <div style="display:flex;align-items:center; gap:10px;">
        <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        <span id="profile-icon">ğŸ‘¤</span>
      </div>
    </header>

    <input type="checkbox" id="menu-toggle">
    <label for="menu-toggle" class="hamburger">
      <span></span>
      <span></span>
      <span></span>
    </label>

    <nav id="main-nav">
      <a href="#" onclick="showPanel('notice-panel')">ê³µì§€ì‚¬í•­</a>
      <a href="#" onclick="showPanel('doc-panel')">ë¬¸ì„œ ë¶„ì„</a>
      <!-- <a href="#" onclick="showPanel('student-panel')">í•™ìƒ ê´€ë¦¬</a> -->
      <a href="#" onclick="showPanel('homework-panel')">íŒŒì¼ ê³µìœ  & ìë£Œì‹¤</a>
      <!-- <a href="#" onclick="showPanel('chat-panel')">ìƒë‹´ì‹¤</a> -->
      <a href="#" onclick="showPanel('timetable-panel')">ì‹œê°„í‘œ</a>
    </nav>

    <div class="content">
      <div id="notice-panel" class="panel" style="display:none;">
        <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
        <div id="notice-list"></div>
        <h3>ìƒˆ ê³µì§€ ë“±ë¡</h3>
        <input type="text" id="notice-title" placeholder="ì œëª©"/>
        <textarea id="notice-content" placeholder="ë‚´ìš©"></textarea>
        <!-- ì‚¬ì§„ íŒŒì¼ ì„ íƒ -->
        <input type="file" id="notice-image" accept="image/*">

        <!-- ì‚¬ì§„ ì—…ë¡œë“œ ì—¬ë¶€ ì„ íƒ -->
        <label style="display:flex;align-items:center;margin-top:0.5rem;">
          <input type="checkbox" id="notice-upload-check" style="margin-right:0.5rem;">
          ì´ ì‚¬ì§„ì„ ê³µì§€ì— í¬í•¨í•˜ê¸°
        </label>
        <button onclick="addNotice()">ê³µì§€ ì¶”ê°€</button>
      </div>

      <div id="doc-panel" class="panel">
        <h2>ğŸ“„ ë¬¸ì„œ ì—…ë¡œë“œ</h2>
        <input type="file" id="doc-file" accept=".pdf,.jpg,.png"/>
        <div class="button-group">
          <button onclick="analyzeDocument()">ë¬¸ì„œ ë¶„ì„í•˜ê¸°</button>
        </div>

        <h3>ë¶„ì„ ê²°ê³¼ (ìˆ˜ì • ê°€ëŠ¥)</h3>
          <textarea 
            id="doc-result"
            placeholder="ë¶„ì„ëœ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. í•„ìš”í•˜ë©´ ìˆ˜ì • í›„ ë“±ë¡í•˜ì„¸ìš”."
            style="
              min-height:100px;
              resize:none;
              overflow:hidden;
              width:100%;
              padding:0.8rem;
              font-size:0.95rem;
              line-height:1.4rem;
              border:1px solid #ced4da;
              border-radius:0.5rem;
              background:#fdfdfd;
              box-shadow:inset 0 1px 2px rgba(0,0,0,0.04);
            ">
          </textarea>



        
        <!-- ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° -->
        <img id="doc-preview" style="max-width:100%; margin-top:1rem; display:none; border-radius:0.5rem;" />

        <!-- ì—…ë¡œë“œ ì—¬ë¶€ ì„ íƒ -->
        <label style="display:flex;align-items:center;margin-top:0.5rem;">
          <input type="checkbox" id="upload-image-check" style="margin-right:0.5rem;">
          ì´ ì‚¬ì§„ì„ ê³µì§€ì— ê°™ì´ ì˜¬ë¦¬ê¸°
        </label>

        <div class="button-group">
          <button onclick="registerAnalyzedText()">ë¶„ì„ëœ ê¸€ ë“±ë¡í•˜ê¸°</button>
        </div>
      </div>



      <div id="student-panel" class="panel" style="display:none;">
        <h2>ğŸ‘©â€ğŸ“ í•™ìƒ ê´€ë¦¬</h2>
        <button onclick="loadStudents()">í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <ul id="student-list"></ul>
      </div>

      <div id="homework-panel" class="panel" style="display:none;">
        <h2>ğŸ“š íŒŒì¼ ê³µìœ  & ìë£Œì‹¤</h2>
        
        <!-- ì—…ë¡œë“œ ì˜ì—­ -->
        <label for="homework-scope">ê³µìœ  ë²”ìœ„</label>
        <select id="homework-scope">
          <option value="school">ì „êµ</option>
          <option value="grade">ê°™ì€ í•™ë…„</option>
          <option value="class">ê°™ì€ ë°˜</option>
        </select>

        <label for="homework-userinfo">í•™ë²ˆ + ì´ë¦„</label>
        <input type="text" id="homework-userinfo" readonly style="background:#f1f3f5; font-weight:bold; margin-bottom:0.8rem;">

        <label for="homework-title">ì œëª©</label>
        <input type="text" id="homework-title" placeholder="ì˜ˆ: ì²´í—˜í•™ìŠµ ì‚¬ì§„">

        <label for="homework-file">íŒŒì¼ ì—…ë¡œë“œ</label>
        <input type="file" id="homework-file">

        <label for="homework-comment">ì½”ë©˜íŠ¸ (ì„ íƒ)</label>
        <textarea id="homework-comment" placeholder="ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”"></textarea>

        <button onclick="submitHomework()">ì—…ë¡œë“œí•˜ê¸°</button>
        <div id="homework-status" style="margin-top:0.5rem;font-size:0.9rem;color:#007bff;"></div>

        <hr style="margin:1.5rem 0;">

        <!-- ìë£Œ ëª©ë¡ ì˜ì—­ -->
        <h3>ğŸ“‚ ì—…ë¡œë“œëœ ìë£Œ</h3>
        <button onclick="loadMaterials()">ğŸ”„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        <ul id="material-list" style="margin-top:1rem;"></ul>
      </div>



      <div id="chat-panel" class="panel" style="display:none;">
        <h2>ğŸ’¬ ìƒë‹´ì‹¤</h2>
        <div id="chat-box" style="border:1px solid #ccc; height:200px; overflow-y:auto; padding:0.5rem; margin-bottom:0.5rem;"></div>
        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
        <button onclick="sendChat()">ë³´ë‚´ê¸°</button>
      </div>

      <div id="profile-panel" class="panel" style="display:none;">
        <h2>ë‚´ ì •ë³´ ìˆ˜ì •</h2>
        <input type="text" id="update-name" placeholder="ì´ë¦„ ìˆ˜ì •">
        <input type="password" id="update-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •">
        <button onclick="updateProfile()">ìˆ˜ì •í•˜ê¸°</button>
        <button onclick="showPanel('doc-panel')">â† ëŒì•„ê°€ê¸°</button>
      </div>

      <div id="admin-panel" class="panel" style="display:none;">
        <h2>âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h2>
        <input type="text" id="admin-user-id" placeholder="ì‚¬ìš©ì ID"/>
        <select id="admin-role">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
        <button onclick="changeRole()">ê¶Œí•œ ë³€ê²½</button>
        <button onclick="deleteUser()">ì‚¬ìš©ì ì‚­ì œ</button>
        <div id="admin-status" style="margin-top:0.5rem;"></div>
      </div>

      <!-- âœ… ì‹œê°„í‘œ íŒ¨ë„ -->
      <!-- âœ… ì‹œê°„í‘œ íŒ¨ë„ (EduBoard ìŠ¤íƒ€ì¼ ë§ì¶¤) -->
      <div id="timetable-panel" class="panel" style="display:none;">
        <h2>ğŸ—“ï¸ ë‚˜ì˜ ì‹œê°„í‘œ</h2>
        <p style="margin-bottom:1rem; color:#495057; font-size:0.95rem;">
          ë´‰ë‹´ì¤‘í•™êµ / ë¡œê·¸ì¸í•œ í•™ë…„Â·ë°˜ ê¸°ì¤€ ì‹œê°„í‘œë¥¼ ì•„ë˜ì—ì„œ í™•ì¸í•˜ì„¸ìš”.
        </p>

        <!-- ìƒë‹¨ ì •ë³´ ì˜ì—­ -->
        <div id="timetable-info" style="
              display:flex;
              justify-content:space-between;
              align-items:center;
              background:#f1f3f5;
              padding:0.75rem 1rem;
              border-radius:0.5rem;
              margin-bottom:1rem;
              font-size:0.9rem;
              color:#333;">
          <span id="timetable-grade-info">í•™ë…„/ë°˜ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
          <button onclick="reloadTimetable()" style="
              background:#007bff;
              border:none;
              border-radius:0.5rem;
              padding:0.4rem 0.8rem;
              color:#fff;
              font-weight:600;
              cursor:pointer;">
            ğŸ”„ ìƒˆë¡œê³ ì¹¨
          </button>
        </div>

        <!-- âœ… ì‹œê°„í‘œ UI ì»¨í…Œì´ë„ˆ -->
        <div id="timetable-container"
            style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;">
        </div>
      </div>



      <!-- âœ… ìë£Œì‹¤ íŒ¨ë„ -->
      <div id="materials-panel" class="panel" style="display:none;">
        <h2>ğŸ“‚ ìë£Œì‹¤</h2>
        <input type="file" id="material-file">
        <button onclick="uploadMaterial()">ì—…ë¡œë“œ</button>
        <div id="material-status" style="margin-top:0.5rem;"></div>
        <h3>ìë£Œ ëª©ë¡</h3>
        <ul id="material-list"></ul>
        <button onclick="loadMaterials()">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
  </div>

<script>
  const { createClient } = supabase;
  const supabaseClient = createClient(
    'https://ucmzrkwrsezfdjnnwsww.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjbXpya3dyc2V6ZmRqbm53c3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NDIzODcsImV4cCI6MjA2ODQxODM4N30.rvLItmDStjWb3GfECnCXocHvj-CMTfHfD1CHsAHOLaw'
  );

  let currentUserRole = 'user';

  let currentUserName = '';
  let currentStudentNumber = '';

  async function loginDirect() {
    const username = document.getElementById('loginUsername').value.replace(/\s+/g, '');
    const password = document.getElementById('loginPassword').value.replace(/\s+/g, '');

    const { data: user } = await supabaseClient
      .from('users')
      .select('*')
      .eq('username', username)
      .eq('password', password)
      .single();

    if (user) {
      currentUserName = user.name;
      currentStudentNumber = user.student_number;

      // âœ… localStorage ì— ì €ì¥
      localStorage.setItem('savedUsername', username);
      localStorage.setItem('savedName', currentUserName);
      localStorage.setItem('savedStudentNum', currentStudentNumber);

      // í™”ë©´ì— í‘œì‹œ
      setUserInfoInput();

      currentUserRole = user.role || 'user';
      currentGrade = user.grade;
      currentClassNum = user.class_num;

      loadTimetableWeek(user.grade, user.class_num);
      showMain();
      loadNotices();
    } else {
      document.getElementById('loginStatus').innerText = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
    }
  }

  // âœ… ë¡œê·¸ì¸ ì—†ì´ë„ ìƒˆë¡œê³ ì¹¨ ì‹œ ì €ì¥ëœ ì´ë¦„/í•™ë²ˆì„ ë¶ˆëŸ¬ì™€ì„œ í‘œì‹œ
  window.addEventListener('DOMContentLoaded', () => {
    const savedName = localStorage.getItem('savedName');
    const savedNum = localStorage.getItem('savedStudentNum');
    if (savedName && savedNum) {
      currentUserName = savedName;
      currentStudentNumber = savedNum;
      setUserInfoInput();
    }
  });

  function setUserInfoInput() {
    const inputEl = document.getElementById('homework-userinfo');
    if (inputEl) {
      inputEl.value = `${currentStudentNumber}ë²ˆ ${currentUserName}`;
    }
  }


  async function signup() {
    const username = document.getElementById('signupUsername').value.trim();
    const password = document.getElementById('signupPassword').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const name = document.getElementById('signupName').value.trim();
    const grade = document.getElementById('signupGrade').value.trim();
    const classNum = document.getElementById('signupClass').value.trim();
    const number = document.getElementById('signupNumber').value.trim();
    const agree = document.getElementById('privacy-agree').checked;

    // âœ… ì…ë ¥ê°’ ê²€ì¦
    if (!agree) {
      document.getElementById('signupStatus').innerText = 'ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•´ ì£¼ì„¸ìš”.';
      return;
    }
    if (!username || !password || !email || !name || !grade || !classNum || !number) {
      document.getElementById('signupStatus').innerText = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
      return;
    }
    if (password.length < 6) {
      document.getElementById('signupStatus').innerText = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
      return;
    }
    // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦ (ê°„ë‹¨)
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      document.getElementById('signupStatus').innerText = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
      return;
    }

    // âœ… ì—¬ê¸°ì—ì„œ ì‹¤ì œ DBë¡œ ì „ì†¡ (Supabase ì˜ˆì‹œ)
    try {
      const { error } = await supabaseClient.from('users').insert([{
        username: username,
        password: password,
        email: email,
        name: name,
        grade: parseInt(grade, 10),
        class_num: parseInt(classNum, 10),
        student_number: parseInt(number, 10),
        role: 'user'
      }]);
      if (error) {
        document.getElementById('signupStatus').innerText = 'íšŒì›ê°€ì… ì‹¤íŒ¨: ' + error.message;
        return;
      }
      document.getElementById('signupStatus').style.color = 'green';
      document.getElementById('signupStatus').innerText = 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.';
    } catch (e) {
      document.getElementById('signupStatus').innerText = 'ì˜¤ë¥˜ ë°œìƒ: ' + e.message;
    }
  }

  function showMain() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    setupAdminNav();
  }

  function showSignup() {
    document.getElementById('login-box').style.display = 'none';
    document.getElementById('signup-box').style.display = 'block';
  }

  function showLogin() {
    document.getElementById('login-box').style.display = 'block';
    document.getElementById('signup-box').style.display = 'none';
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    localStorage.removeItem('savedUsername'); // âœ… ë¡œê·¸ì•„ì›ƒ ì‹œ ì €ì¥ëœ ì•„ì´ë”” ì‚­ì œ
    document.getElementById('main-app').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
  }

  async function updateProfile() {
    const newName = document.getElementById('update-name').value;
    const newPass = document.getElementById('update-password').value;

    if (newPass) {
      const { error } = await supabaseClient.auth.updateUser({ password: newPass });
      if (error) alert('ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • ì˜¤ë¥˜:' + error.message);
      else alert('ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • ì™„ë£Œ!');
    }
    if (newName) {
      const user = await supabaseClient.auth.getUser();
      if (user && user.data.user) {
        await supabaseClient.from('users').update({ name: newName }).eq('id', user.data.user.id);
        alert('ì´ë¦„ ìˆ˜ì • ì™„ë£Œ!');
      }
    }
  }

function showPanel(panelId) {
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  document.getElementById(panelId).style.display = 'block';
}

document.getElementById('profile-icon').addEventListener('click', () => {
  showPanel('profile-panel');
});

supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
  if (session) {
    const { data: user } = await supabaseClient
      .from('users')
      .select('role')
      .eq('id', session.user.id)
      .single();
    if (user) currentUserRole = user.role;
    showMain();
  } else {
    showLogin();
  }
});

function setupAdminNav() {
  if (currentUserRole === 'admin') {
    if (!document.getElementById('admin-nav')) {
      const nav = document.getElementById('main-nav');
      const a = document.createElement('a');
      a.href = '#';
      a.id = 'admin-nav';
      a.innerText = 'ê´€ë¦¬ì ì„¤ì •';
      a.onclick = () => { showPanel('admin-panel'); };
      nav.appendChild(a);
    }
  }
}

// ===== ê³µì§€ì‚¬í•­ ë“±ë¡ (ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¶”ê°€) =====
async function addNotice() {
  const title = document.getElementById('notice-title').value.trim();
  const content = document.getElementById('notice-content').value.trim();
  const fileInput = document.getElementById('notice-image');
  const uploadChecked = document.getElementById('notice-upload-check').checked;

  if (!title || !content) {
    alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    return;
  }

  let imageUrl = '';

  if (uploadChecked && fileInput.files.length) {
    const file = fileInput.files[0];
    const uniqueName = Date.now() + '_' + file.name;
    const filePath = `public/${uniqueName}`;

    const { error: uploadErr } = await supabaseClient
      .storage
      .from('notice-images')
      .upload(filePath, file, { upsert: true });

    if (uploadErr) {
      alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadErr.message);
      return;
    }

    const { data: publicData } = supabaseClient
      .storage
      .from('notice-images')
      .getPublicUrl(filePath);

    imageUrl = publicData.publicUrl;
  }

  // âœ… í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const { data: writerData, error: writerError } = await supabaseClient
    .from('users')
    .select('username,name,role,grade,class_num')
    .eq('username', localStorage.getItem('savedUsername'))
    .single();

  if (writerError || !writerData) {
    alert('ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    return;
  }

  // âœ… í…Œì´ë¸”ì— ë“±ë¡í•  ë°ì´í„°
  const newNotice = {
    title: title,
    content: content,
    image_url: imageUrl,
    writer: writerData.name,        // ì‘ì„±ì ì´ë¦„
    writer_role: writerData.role,   // ì‘ì„±ì ì—­í• 
    grade: writerData.grade,        // ì‘ì„±ì í•™ë…„
    class_num: writerData.class_num // ì‘ì„±ì ë°˜
  };

  const { error } = await supabaseClient.from('notices').insert([ newNotice ]);
    if (error) {
      alert('ê³µì§€ ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
      return;
    }

    alert('ê³µì§€ ë“±ë¡ ì™„ë£Œ!');
    document.getElementById('notice-title').value = '';
    document.getElementById('notice-content').value = '';
    document.getElementById('notice-image').value = '';
    document.getElementById('notice-upload-check').checked = false;

    loadNotices();
  }

  // ===== ê³µì§€ì‚¬í•­ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì¤‘ë³µ ì œê±° + ì´ë¯¸ì§€ í‘œì‹œ) =====
  async function loadNotices() {
    let query = supabaseClient.from('notices').select('*').order('id', { ascending: false });

    if (currentUserRole !== 'admin') {
      // âœ… í•™ìƒì´ë¼ë©´ ê°™ì€ í•™ë…„/ë°˜ & ì–´ë“œë¯¼ì´ ì˜¬ë¦° ê¸€ ì œì™¸
      query = query
        .eq('grade', currentGrade)
        .eq('class_num', currentClassNum)
        .neq('writer_role', 'admin');
    }
    // âœ… adminì´ë©´ ëª¨ë“  ê³µì§€ë¥¼ ê·¸ëŒ€ë¡œ ë¶ˆëŸ¬ì˜´

    const { data, error } = await query;

    if (error) {
      console.error('ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
      return;
    }

    const listEl = document.getElementById('notice-list');
    listEl.innerHTML = '';

    data.forEach(item => {
      const formattedContent = item.content.replace(/\n/g, '<br>');
      const div = document.createElement('div');
      div.style.borderBottom = '1px solid #ddd';
      div.style.padding = '0.5rem 0';
      // ëˆ„ê°€ ì˜¬ë¦° ê¸€ì¸ì§€ í‘œì‹œ
      div.innerHTML = `<strong>${item.title}</strong> <span style="font-size:0.8rem;color:#888;">(${item.writer})</span><br>${formattedContent}`;

      if (item.image_url) {
        div.innerHTML += `<br><img src="${item.image_url}" style="max-width:100%;margin-top:0.5rem;border-radius:0.5rem;">`;
      }

      listEl.appendChild(div);
    });
  }


// ===== ë¬¸ì„œ ë¶„ì„(OCR) =====
async function analyzeDocument() {
  const fileInput = document.getElementById('doc-file');
  if (!fileInput.files.length) {
    alert('íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
    return;
  }

  const file = fileInput.files[0];
  lastAnalyzedFile = file; // ë¶„ì„í•œ íŒŒì¼ì„ ì €ì¥
  document.getElementById('doc-preview').src = URL.createObjectURL(file);
  document.getElementById('doc-preview').style.display = 'block';

  document.getElementById('doc-result').value = 'ë¬¸ì„œ ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.';

  const reader = new FileReader();
  reader.onload = () => {
    Tesseract.recognize(reader.result, 'kor', { logger: m => console.log(m) })
      .then(({ data: { text } }) => {
        document.getElementById('doc-result').value = text;
        autoResize();
        alert('ë¬¸ì„œ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ì²´í¬ë°•ìŠ¤ë¡œ ì‚¬ì§„ ì—…ë¡œë“œ ì—¬ë¶€ë¥¼ ì„ íƒ í›„ ë“±ë¡í•˜ì„¸ìš”.');
      })
      .catch(err => {
        console.error('OCR ì˜¤ë¥˜:', err);
        document.getElementById('doc-result').value = 'ë¬¸ì„œ ë¶„ì„ ì‹¤íŒ¨: ' + err.message;
      });
  };
  reader.readAsDataURL(file);
}


async function registerAnalyzedText() {
  const text = document.getElementById('doc-result').value.trim();
  if (!text) {
    alert('ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
    return;
  }

  let imageUrl = '';
  const shouldUploadImage = document.getElementById('upload-image-check').checked;

  if (shouldUploadImage && lastAnalyzedFile) {
    const fileName = Date.now() + '_' + lastAnalyzedFile.name;
    const { error: uploadErr } = await supabaseClient
      .storage
      .from('notice-images')
      .upload(fileName, lastAnalyzedFile);

    if (uploadErr) {
      alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadErr.message);
      return;
    }
    const { data: publicData } = supabaseClient
      .storage
      .from('notice-images')
      .getPublicUrl(fileName);
    imageUrl = publicData.publicUrl;
  }

  // âœ… í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const { data: writerData, error: writerError } = await supabaseClient
    .from('users')
    .select('username,name,role,grade,class_num')
    .eq('username', localStorage.getItem('savedUsername'))
    .single();

  if (writerError || !writerData) {
    alert('ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    return;
  }

  // âœ… DBì— ê³µì§€ ë“±ë¡ (ë¬¸ì„œ ë¶„ì„ ê²°ê³¼)
  const { error } = await supabaseClient.from('notices').insert([{
    title: 'ë¬¸ì„œ ë¶„ì„ ë“±ë¡',
    content: text,
    image_url: imageUrl,
    writer: writerData.name,
    writer_role: writerData.role,
    grade: writerData.grade,
    class_num: writerData.class_num
  }]);

  if (error) {
    alert('ê³µì§€ ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
    return;
  }

  alert('ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
  loadNotices();

  // ì´ˆê¸°í™”
  lastAnalyzedFile = null;
  document.getElementById('doc-file').value = '';
  document.getElementById('doc-preview').style.display = 'none';
  document.getElementById('upload-image-check').checked = false;
  document.getElementById('doc-result').value = '';
}


  const docResult = document.getElementById('doc-result');

  // ë†’ì´ ìë™ ì¡°ì • í•¨ìˆ˜
  function autoResize() {
    docResult.style.height = 'auto';  // ì´ˆê¸°í™”
    docResult.style.height = docResult.scrollHeight + 'px'; // ë‚´ìš©ì— ë§ê²Œ ëŠ˜ë¦¼
  }

  // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•  ë•Œë„ ì ìš©
  docResult.addEventListener('input', autoResize);

    async function submitHomework() {
      const scope = document.getElementById('homework-scope').value
    const name = document.getElementById('homework-name').value.trim();
    const title = document.getElementById('homework-title').value.trim();
    const comment = document.getElementById('homework-comment').value.trim();
    const fileInput = document.getElementById('homework-file');
    const statusEl = document.getElementById('homework-status');

    if (!name || !title || !fileInput.files.length) {
      alert('ì´ë¦„, ê³¼ì œëª…, íŒŒì¼ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      return;
    }

    // Supabase ìŠ¤í† ë¦¬ì§€ì— íŒŒì¼ ì—…ë¡œë“œ
    const file = fileInput.files[0];
    const fileName = Date.now() + '_' + file.name;

    let { error: uploadError } = await supabaseClient.storage
      .from('homework-files') // ìŠ¤í† ë¦¬ì§€ ë²„í‚· ì´ë¦„
      .upload(fileName, file);

    if (uploadError) {
      statusEl.style.color = 'red';
      statusEl.textContent = 'íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadError.message;
      return;
    }

    const { data: publicURLData } = supabaseClient
      .storage
      .from('homework-files')
      .getPublicUrl(fileName);

    const fileURL = publicURLData.publicUrl;

    // DBì— ê¸°ë¡
    const { error: insertError } = await supabaseClient.from('homeworks').insert([{
      name: name,
      title: title,
      comment: comment,
      file_url: fileURL
    }]);

    if (insertError) {
      statusEl.style.color = 'red';
      statusEl.textContent = 'ì œì¶œ ì‹¤íŒ¨: ' + insertError.message;
      return;
    }

    statusEl.style.color = 'green';
    statusEl.textContent = 'âœ… ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
    
    loadMaterials();
    // ì…ë ¥ ì´ˆê¸°í™”
    document.getElementById('homework-name').value = '';
    document.getElementById('homework-title').value = '';
    document.getElementById('homework-comment').value = '';
    document.getElementById('homework-file').value = '';
  }

  const NEIS_KEY = '1692c030b074479784fa252d2886f919';
  const ATPT_OFCDC_SC_CODE = 'J10'; // ê²½ê¸°ë„êµìœ¡ì²­
  const SD_SCHUL_CODE = '7679111';  // âœ… ë´‰ë‹´ì¤‘í•™êµ ì½”ë“œë¡œ ìˆ˜ì •


  let currentGrade = null;
  let currentClassNum = null;

    // ğŸ“Œ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
      async function loadTimetableWeek(grade, classNum) {
        currentGrade = grade;
        currentClassNum = classNum;

        document.getElementById('timetable-grade-info').innerText = `${grade}í•™ë…„ ${classNum}ë°˜ (ì£¼ê°„)`;
        const container = document.getElementById('timetable-container');
        container.innerHTML = '<p>ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

        const today = new Date();
        const day = today.getDay();
        const monday = new Date(today);
        monday.setDate(today.getDate() - (day === 0 ? 6 : day - 1));

        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        // âœ… í•™ê¸° êµ¬ë¶„: 7ì›”ê¹Œì§€ëŠ” 1í•™ê¸°, 8ì›”ë¶€í„° 2í•™ê¸°
        const semester = (month <= 8) ? 1 : 2;

        const dates = Array.from({ length: 5 }, (_, i) => {
          const d = new Date(monday);
          d.setDate(monday.getDate() + i);
          return `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
        });

        try {
          const results = await Promise.all(
            dates.map(async (dateStr) => {
              const url = `https://open.neis.go.kr/hub/misTimetable?KEY=${NEIS_KEY}&Type=json&ATPT_OFCDC_SC_CODE=${ATPT_OFCDC_SC_CODE}&SD_SCHUL_CODE=${SD_SCHUL_CODE}&AY=${year}&SEM=${semester}&ALL_TI_YMD=${dateStr}&GRADE=${grade}&CLASS_NM=${classNum}`;
              console.log(url);
              const res = await fetch(url);
              const data = await res.json();
              return { dateStr, data };
            })
          );

          container.innerHTML = '';

          for (const { dateStr, data } of results) {
            const dayBox = document.createElement('div');
            dayBox.style.border = '1px solid #ccc';
            dayBox.style.borderRadius = '8px';
            dayBox.style.padding = '8px';
            dayBox.style.background = '#fdfdfd';
            dayBox.style.marginBottom = '10px';

            const title = document.createElement('h4');
            title.innerText = `${dateStr.slice(0, 4)}-${dateStr.slice(4, 6)}-${dateStr.slice(6, 8)}`;
            dayBox.appendChild(title);

            if (data.misTimetable && data.misTimetable[1]) {
              const rows = data.misTimetable[1].row;
              rows.forEach(row => {
                const item = document.createElement('div');
                item.innerHTML = `<strong>${row.PERIO}êµì‹œ</strong> : ${row.ITRT_CNTNT}`;
                dayBox.appendChild(item);
              });
            } else {
              const none = document.createElement('p');
              none.innerText = 'ì‹œê°„í‘œ ë°ì´í„° ì—†ìŒ';
              dayBox.appendChild(none);
            }

            container.appendChild(dayBox);
          }
        } catch (err) {
          console.error('ì£¼ê°„ ì‹œê°„í‘œ ì˜¤ë¥˜:', err);
          container.innerHTML = '<p>ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }

        showPanel('timetable-panel');
      }

      // ğŸ“Œ í˜ì´ì§€ ë¡œë“œì‹œ ìë™ ë¡œê·¸ì¸ í™•ì¸
      window.addEventListener('DOMContentLoaded', async () => {
        const savedUsername = localStorage.getItem('savedUsername');

        if (savedUsername) {
          const { data: user, error } = await supabaseClient
            .from('users')
            .select('*')
            .eq('username', savedUsername)
            .maybeSingle();

          if (error) {
            console.error('ìë™ ë¡œê·¸ì¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
            showLogin();
            return;
          }

          if (user) {
            currentUserRole = user.role || 'user';
            currentGrade = user.grade;
            currentClassNum = user.class_num;

            await loadTimetableWeek(user.grade, user.class_num);
            showMain();
            loadNotices();
            return;
          }
        }

        showLogin();
      });




  window.addEventListener('DOMContentLoaded', async () => {
    // ğŸ‘‰ ì´ì „ì— ë¡œê·¸ì¸í•œ ì•„ì´ë””ê°€ localStorageì— ì €ì¥ë¼ ìˆëŠ”ì§€ í™•ì¸
    const savedUsername = localStorage.getItem('savedUsername');

    if (savedUsername) {
      // Supabaseì—ì„œ í•´ë‹¹ ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
      const { data: user, error } = await supabaseClient
        .from('users')
        .select('*')
        .eq('username', savedUsername)
        .maybeSingle();

      if (error) {
        console.error('ìë™ ë¡œê·¸ì¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
        showLogin();
        return;
      }

      if (user) {
        currentUserRole = user.role || 'user';
        currentGrade = user.grade;
        currentClassNum = user.class_num;

        // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ
        loadTimetableWeek(user.grade, user.class_num);
        showMain();
        loadNotices();
        return; // ìë™ ë¡œê·¸ì¸ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì¢…ë£Œ
      }
    }

    // ğŸ‘‰ ì €ì¥ëœ ì•„ì´ë””ê°€ ì—†ê±°ë‚˜ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í™”ë©´
    showLogin();
  });


  function setupAdminNav() {
    const existing = document.getElementById('admin-nav');

    if (currentUserRole === 'admin') {
      if (!existing) {
        const nav = document.getElementById('main-nav');
        const a = document.createElement('a');
        a.href = '#';
        a.id = 'admin-nav';
        a.innerText = 'ê´€ë¦¬ì ì„¤ì •';
        a.onclick = () => { showPanel('admin-panel'); };
        nav.appendChild(a);
      }
    } else {
      if (existing) existing.remove();
    }
  }

  document.querySelectorAll('#main-nav a').forEach(link => {
    link.addEventListener('click', () => {
      document.getElementById('menu-toggle').checked = false; // âœ… ì²´í¬ í•´ì œ â†’ ë©”ë‰´ ë‹«í˜
    });
  });

  function reloadTimetable() {
    if (currentGrade && currentClassNum) {
      loadTimetableWeek(currentGrade, currentClassNum);
    } else {
      alert('ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
    }
  }

  // ğŸ“‚ ìë£Œì‹¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
// ğŸ“‚ ìë£Œì‹¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadMaterials() {
  
  const { data, error } = await supabaseClient
    .from('homeworks')
    .select('*')
    .order('id', { ascending: false });

  const listEl = document.getElementById('material-list');
  listEl.innerHTML = '';

  if (error) {
    console.error('ìë£Œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
    listEl.innerHTML = '<li>ìë£Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>';
    return;
  }

  if (!data || data.length === 0) {
    listEl.innerHTML = '<li>ë“±ë¡ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
    return;
  }

  data.forEach(item => {
    // ì œëª©ê³¼ ì‘ì„±ì(í•™ë²ˆ+ì´ë¦„)
    const titleLine = `ğŸ“Œ ${item.title} (${item.grade}í•™ë…„${item.class_num}ë°˜${item.student_number}ë²ˆ ${item.name})`;

    // ì½”ë©˜íŠ¸(ìˆë‹¤ë©´)
    const commentHtml = item.comment
      ? `<p style="margin:6px 0;">${item.comment}</p>`
      : '';

    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬
    const fileHtml = `<a href="${item.file_url}" target="_blank"
      style="display:inline-block;margin-top:6px;color:#007bff;text-decoration:none;">
      ğŸ“¥ ë‹¤ìš´ë¡œë“œ
    </a>`;

    // ì´ë¯¸ì§€ íŒŒì¼ì´ë©´ ì¸ë„¤ì¼ë„ í‘œì‹œ
    let imageHtml = '';
    if (item.file_url.match(/\.(jpg|jpeg|png|gif)$/i)) {
      imageHtml = `<div style="margin-top:8px;">
        <img src="${item.file_url}" style="max-width:200px;border-radius:8px;">
      </div>`;
    }

    // li ìš”ì†Œ ìƒì„±
    const li = document.createElement('li');
    li.style.borderBottom = '1px solid #ddd';
    li.style.padding = '10px 0';
    li.innerHTML = `
      <div style="font-weight:bold;">${titleLine}</div>
      ${commentHtml}
      ${fileHtml}
      ${imageHtml}
    `;

    listEl.appendChild(li);
  });
}



async function submitHomework() {
  // âœ… í•™ë²ˆê³¼ ì´ë¦„ì€ ê³ ì •ê°’ ì‚¬ìš©
  const name = currentUserName;
  const studentNum = currentStudentNumber;
  const title = document.getElementById('homework-title').value.trim();
  const comment = document.getElementById('homework-comment').value.trim();
  
  const fileInput = document.getElementById('homework-file');
  const statusEl = document.getElementById('homework-status');

  if (!name || !studentNum || !title || !fileInput.files.length) {
    alert('ê³¼ì œëª…ê³¼ íŒŒì¼ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    return;
  }

  // âœ… Supabase ìŠ¤í† ë¦¬ì§€ ì—…ë¡œë“œ
  const file = fileInput.files[0];
  const fileName = Date.now() + '_' + file.name;

  let { error: uploadError } = await supabaseClient.storage
    .from('homework-files') // ìŠ¤í† ë¦¬ì§€ ë²„í‚· ì´ë¦„
    .upload(fileName, file);

  if (uploadError) {
    statusEl.style.color = 'red';
    statusEl.textContent = 'íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadError.message;
    return;
  }

  const { data: publicURLData } = supabaseClient
    .storage
    .from('homework-files')
    .getPublicUrl(fileName);

  const fileURL = publicURLData.publicUrl;

  // âœ… DBì— ê¸°ë¡ (í•™ë²ˆê³¼ ì´ë¦„ í¬í•¨)
  const { error: insertError } = await supabaseClient.from('homeworks').insert([{
    name: name,
    student_number: studentNum,
    title: title,
    grade: currentGrade,      
    class_num: currentClassNum, 
    comment: comment,
    file_url: fileURL,
    share_scope: scope 
  }]);

  if (insertError) {
    statusEl.style.color = 'red';
    statusEl.textContent = 'ì œì¶œ ì‹¤íŒ¨: ' + insertError.message;
    return;
  }

  statusEl.style.color = 'green';
  statusEl.textContent = 'âœ… ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';

  // ì…ë ¥ ì´ˆê¸°í™”
  document.getElementById('homework-title').value = '';
  document.getElementById('homework-comment').value = '';
  document.getElementById('homework-file').value = '';

  // ìë£Œ ëª©ë¡ ê°±ì‹ 
  loadMaterials();
}



  




</script>
</body>
</html>
